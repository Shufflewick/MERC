---
phase: 08-artillery-barrage
plan: 02
type: execute
---

<objective>
Modify flow.ts to add artillery allocation loop during dictator turn.

Purpose: Enable the game flow to pause during dictator's turn when artillery barrage needs rebel input for hit allocation.
Output: Modified flow.ts with loop that checks for pendingArtilleryAllocation and presents action to rebels.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./08-02-SUMMARY.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-artillery-barrage/08-01-SUMMARY.md
@src/rules/flow.ts

**Key insight:** The dictator turn (lines 378-481) currently has NO loops for rebel input.
Artillery barrage happens at line 414-418 (`playTactics` action).
Need to add a loop AFTER the playTactics step to handle pending artillery.

**Pattern to follow:**
Look at lines 299-309 - the `combat-hit-allocation` loop:
```typescript
loop({
  name: 'combat-hit-allocation',
  while: () => game.activeCombat?.pendingHitAllocation != null && !game.isFinished(),
  maxIterations: 50,
  do: actionStep({
    name: 'allocate-hits',
    actions: ['combatAllocateHits', 'combatBasicReroll'],
    skipIf: () => game.isFinished() || game.activeCombat?.pendingHitAllocation == null,
  }),
}),
```

Artillery needs similar pattern but:
1. Happens during DICTATOR turn (not rebel turn)
2. Uses `game.pendingArtilleryAllocation` (not activeCombat)
3. Calls `artilleryAllocateHits` action (to be created in Plan 04)

**Critical architecture note:**
The dictator turn is wrapped in `eachPlayer` with dictator filter.
The loop must temporarily let rebels act. Since actionStep shows available actions
to the current player, we may need to make the artillery action available to ALL players,
but condition it on rebel ownership of units in the targeted sector.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add artillery allocation loop to dictator turn</name>
  <files>src/rules/flow.ts</files>
  <action>
Add a loop AFTER the `playTactics` actionStep (after line 418) and BEFORE the dictator MERC actions loop.

```typescript
// MERC-lw9r: Artillery hit allocation - rebels choose how damage is allocated
// This runs after playTactics in case Artillery Barrage was played
loop({
  name: 'artillery-allocation',
  while: () => game.pendingArtilleryAllocation != null && !game.isFinished(),
  maxIterations: 50, // Safety: max sectors * max allocations per sector
  do: actionStep({
    name: 'artillery-allocate',
    actions: ['artilleryAllocateHits'],
    prompt: 'Allocate artillery damage to your units',
    skipIf: () => game.isFinished() || game.pendingArtilleryAllocation == null,
  }),
}),
```

**Important:** This loop runs during dictator's turn but the action will be conditioned
to only be available to rebels (via the action's .condition()). The framework will
show the action to the correct player based on the condition check.

Place this immediately after:
```typescript
// Step 1: Play a tactics card or reinforce
actionStep({
  name: 'dictator-play-tactics',
  actions: ['playTactics', 'reinforce'],
  skipIf: () => game.isFinished(),
}),
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` (will warn about missing action, that's expected until Plan 04)</verify>
  <done>Artillery allocation loop added after playTactics step in dictator turn sequence</done>
</task>

<task type="auto">
  <name>Task 2: Register the artillery action placeholder</name>
  <files>src/rules/actions/index.ts</files>
  <action>
Add a placeholder registration for `artilleryAllocateHits` action.
This ensures the flow can reference the action name without runtime errors.

Find the actions array export and add 'artilleryAllocateHits' to the list.
The actual implementation will be added in Plan 04.

For now, create a stub in rebel-combat.ts or a new file that returns an action
that always has `condition: () => false` so it never shows up but doesn't break the flow.

Add to exports in index.ts:
```typescript
export { createArtilleryAllocateHitsAction } from './rebel-combat.js';
```

In the registration function, add:
```typescript
createArtilleryAllocateHitsAction(game),
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>artilleryAllocateHits action registered, flow doesn't error on unknown action</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm test` passes (no regressions)
- [ ] flow.ts has artillery-allocation loop in dictator turn
- [ ] artilleryAllocateHits action is registered (even if stub)
- [ ] Game still runs normally (artillery barrage still auto-allocates for now)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- No test regressions
- Flow structure ready to handle artillery allocation when state is set
</success_criteria>

<output>
After completion, create `.planning/phases/08-artillery-barrage/08-02-SUMMARY.md`
</output>
