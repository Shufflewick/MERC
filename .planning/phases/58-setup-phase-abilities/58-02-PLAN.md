---
phase: 58-setup-phase-abilities
plan: 02
type: execute
wave: 2
depends_on: ["58-01"]
files_modified:
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
autonomous: true

must_haves:
  truths:
    - "Hussein draws and plays a second tactics card at the end of each turn"
    - "The second tactics play can trigger all post-effects (artillery, generalissimo, lockdown, combat)"
    - "Human Hussein sees a distinct 'Hussein Ability: Play a second tactics card' prompt"
    - "AI Hussein auto-plays the second card from the deck"
    - "Hand refills to 3 cards after both plays"
  artifacts:
    - path: "src/rules/dictator-abilities.ts"
      provides: "applyHusseinBonusTactics AI-path function"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "husseinBonusTactics and husseinBonusReinforce actions"
    - path: "src/rules/flow.ts"
      provides: "hussein-bonus-tactics step with post-effects in dictator turn sequence"
    - path: "src/ui/components/DictatorPanel.vue"
      provides: "husseinBonusTactics and husseinBonusReinforce in dictatorSpecificActions and UI routing"
  key_links:
    - from: "src/rules/flow.ts"
      to: "husseinBonusTactics action"
      via: "actionStep in dictator turn after ability step"
      pattern: "husseinBonusTactics.*husseinBonusReinforce"
    - from: "src/rules/flow.ts"
      to: "post-effects after second tactics play"
      via: "artillery/generalissimo/lockdown/combat loops"
      pattern: "hussein-bonus-artillery|hussein-bonus-generalissimo|hussein-bonus-lockdown"
    - from: "src/ui/components/DictatorPanel.vue"
      to: "husseinBonusTactics routing"
      via: "dictatorSpecificActions array"
      pattern: "husseinBonusTactics"
---

<objective>
Implement Hussein's persistent per-turn ability: draw and play a second tactics card at the end of each turn.

Purpose: Hussein's unique ongoing ability gives the dictator double tactical impact each turn -- after the normal tactics play and MERC actions, Hussein gets a second tactics card play with all the same post-effects (artillery allocation, generalissimo hire, lockdown placement, combat resolution).

Output: AI-path function in dictator-abilities.ts, human-path actions (husseinBonusTactics/husseinBonusReinforce) in dictator-actions.ts, flow steps with full post-effects in dictator turn sequence, and UI wiring in DictatorPanel.vue.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-setup-phase-abilities/58-RESEARCH.md
@.planning/phases/58-setup-phase-abilities/58-01-SUMMARY.md

Key source files:
@src/rules/dictator-abilities.ts
@src/rules/actions/dictator-actions.ts (playTactics and reinforce patterns at lines 74-260)
@src/rules/actions/index.ts
@src/rules/flow.ts (dictator turn at lines 776-999, combatResolutionFlow at line 166)
@src/ui/components/DictatorPanel.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI-path function and human-path actions for Hussein bonus tactics</name>
  <files>
    src/rules/dictator-abilities.ts
    src/rules/actions/dictator-actions.ts
    src/rules/actions/index.ts
  </files>
  <action>
  **In src/rules/dictator-abilities.ts:**

  Add `applyHusseinBonusTactics(game: MERCGame): DictatorAbilityResult` for the AI path:
  - Guard: check `dictator.combatantId === 'hussein'`, return failure if not
  - Get `tacticsDeck` from `game.dictatorPlayer.tacticsDeck`
  - Get top card: `tacticsDeck.first(TacticsCard)`
  - If no card, return success with message "No cards remaining"
  - Move card to discard: `card.putInto(game.dictatorPlayer.tacticsDiscard!)`
  - Execute tactics effect: `executeTacticsEffect(game, card)` (import from `../tactics-effects.js` if not already)
  - Handle base reveal for AI (same pattern as `createPlayTacticsAction` execute handler -- if card reveals base, find base sector, reveal, equip dictator)
  - Message: "Hussein plays bonus tactics card: {card.tacticsName}"
  - Return success

  Export `applyHusseinBonusTactics` so flow.ts can import it.

  **In src/rules/actions/dictator-actions.ts:**

  1. Add `createHusseinBonusTacticsAction(game: MERCGame): ActionDefinition`:
     - Action name: `'husseinBonusTactics'`
     - Prompt: "Hussein's Ability: Play a second tactics card"
     - Conditions:
       - Is dictator player: `game.isDictatorPlayer(ctx.player)`
       - Is Hussein: `game.dictatorPlayer?.dictator?.combatantId === 'hussein'`
       - Is human: `!game.dictatorPlayer?.isAI`
       - Has tactics cards in hand: `(game.dictatorPlayer?.tacticsHand?.count(TacticsCard) ?? 0) > 0`
     - Selection: `chooseElement<TacticsCard>('card', ...)` -- identical filter to `playTactics`: filter to cards in `tacticsHand` by ID comparison
     - Selection: `chooseFrom<string>('baseLocation', ...)` -- identical to `playTactics` (base location choice for base-reveal cards, with `(skipped)` placeholder when not applicable). Use `dependsOn: 'card'`.
     - Selection: `chooseFrom<string>('dictatorEquipment', ...)` -- identical to `playTactics` (dictator equipment for base reveal). Use `dependsOn: 'baseLocation'`.
     - Execute handler: identical to `playTactics` execute -- move card to discard, handle base reveal for human, call `executeTacticsEffect`, equip dictator if applicable. Return result.
     - NOTE: This is intentionally a near-copy of `playTactics`. The distinct action name provides clear UX prompting ("Hussein's Ability"). Do NOT try to share code with playTactics via a helper -- keeping them as independent actions is simpler and avoids coupling.

  2. Add `createHusseinBonusReinforceAction(game: MERCGame): ActionDefinition`:
     - Action name: `'husseinBonusReinforce'`
     - Prompt: "Hussein's Ability: Reinforce instead of playing tactics"
     - Conditions: same as `reinforce` but with Hussein and human checks added
     - Selection: `chooseElement<TacticsCard>('card', ...)` -- identical filter to `reinforce`
     - Selection: `chooseElement<Sector>('sector', ...)` -- identical filter to `reinforce`
     - Execute handler: identical to `reinforce` execute -- discard card, calculate reinforcements, place militia, message. Return result.

  **In src/rules/actions/index.ts:**
  - Import `createHusseinBonusTacticsAction` and `createHusseinBonusReinforceAction` from `./dictator-actions.js`
  - Register both in `registerAllActions`
  </action>
  <verify>
  `npx tsc --noEmit` passes. Grep for `husseinBonusTactics` and `husseinBonusReinforce` in dictator-actions.ts and index.ts confirms both actions exist and are registered.
  </verify>
  <done>
  AI-path `applyHusseinBonusTactics` auto-plays top card from deck. Human-path `husseinBonusTactics` and `husseinBonusReinforce` actions present "Hussein's Ability" prompt with identical selection/execute logic to playTactics/reinforce. Both registered in index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Flow wiring with post-effects and UI routing</name>
  <files>
    src/rules/flow.ts
    src/ui/components/DictatorPanel.vue
  </files>
  <action>
  **In src/rules/flow.ts:**

  In the dictator turn sequence (inside the `eachPlayer` block starting at line 776), add the Hussein bonus tactics steps AFTER the "Apply end-of-turn effects (Conscripts)" step (line 988-991) and BEFORE the "Step 4: Refill hand to 3 cards" step (line 993-997).

  Add this block:

  ```
  // Hussein: Draw bonus card and play second tactics (persistent per-turn ability)
  execute(() => {
    if (game.isFinished()) return;
    const dictator = game.dictatorPlayer?.dictator;
    if (dictator?.combatantId !== 'hussein') return;

    if (game.dictatorPlayer?.isAI) {
      // AI: Auto-play second card
      applyHusseinBonusTactics(game);
    } else {
      // Human: Draw 1 card from deck to hand for the bonus play
      const deck = game.dictatorPlayer.tacticsDeck;
      const hand = game.dictatorPlayer.tacticsHand;
      if (deck && hand) {
        const card = deck.first(TacticsCard);
        if (card) {
          card.putInto(hand);
          game.message('Hussein draws a bonus tactics card');
        }
      }
    }
  }),

  // Hussein second tactics play (human only)
  actionStep({
    name: 'hussein-bonus-tactics',
    actions: ['husseinBonusTactics', 'husseinBonusReinforce'],
    prompt: "Hussein's Ability: Play a second tactics card",
    skipIf: () => game.isFinished() ||
      game.dictatorPlayer?.dictator?.combatantId !== 'hussein' ||
      game.dictatorPlayer?.isAI === true,
  }),

  // Post-effects for Hussein's second tactics play
  // These are duplicates of the post-first-tactics-play effects (lines 818-857)
  // Required because the second card can trigger artillery, generalissimo, lockdown, or combat

  // Artillery allocation after Hussein bonus tactics
  loop({
    name: 'hussein-bonus-artillery',
    while: () => game.pendingArtilleryAllocation != null && !game.isFinished(),
    maxIterations: 50,
    do: actionStep({
      name: 'hussein-artillery-allocate',
      actions: ['artilleryAllocateHits'],
      prompt: 'Allocate artillery damage to your units',
      skipIf: () => game.isFinished() || game.pendingArtilleryAllocation == null,
    }),
  }),

  // Generalissimo hire after Hussein bonus tactics
  loop({
    name: 'hussein-bonus-generalissimo',
    while: () => game.pendingGeneralissimoHire != null && !game.isFinished(),
    maxIterations: 5,
    do: actionStep({
      name: 'hussein-generalissimo-pick',
      actions: ['generalissimoPick'],
      prompt: 'Generalissimo: Choose a MERC to hire',
      skipIf: () => game.isFinished() || game.pendingGeneralissimoHire == null,
    }),
  }),

  // Lockdown militia placement after Hussein bonus tactics
  loop({
    name: 'hussein-bonus-lockdown',
    while: () => game.pendingLockdownMilitia != null && game.pendingLockdownMilitia.remaining > 0 && !game.isFinished(),
    maxIterations: 50,
    do: actionStep({
      name: 'hussein-lockdown-place',
      actions: ['lockdownPlaceMilitia'],
      prompt: 'Lockdown: Place militia on base or adjacent sectors',
      skipIf: () => game.isFinished() || game.pendingLockdownMilitia == null || game.pendingLockdownMilitia.remaining <= 0,
    }),
  }),

  // Combat resolution after Hussein bonus tactics
  combatResolutionFlow(game, 'hussein-bonus-combat'),
  ```

  Import `applyHusseinBonusTactics` from `./dictator-abilities.js` at the top of flow.ts.

  **Placement rationale:** The ability text says "at the end of each of your turns," so it goes after Conscripts but before hand refill. The post-effects (artillery, generalissimo, lockdown, combat) must follow the second play just like they follow the first play.

  **In src/ui/components/DictatorPanel.vue:**

  1. Add `'husseinBonusTactics'` and `'husseinBonusReinforce'` to the `dictatorSpecificActions` array (line ~128).

  2. Add UI routing for `husseinBonusTactics`:
     - In the section that checks for sector selection (around line 156-171):
       - Add `husseinBonusTactics` alongside `playTactics` for `baseLocation` selection: `(currentAction === 'playTactics' || currentAction === 'husseinBonusTactics' || currentAction === 'chooseKimBase') && sel.name === 'baseLocation'`
       - Add `husseinBonusReinforce` alongside `reinforce` for `sector` selection: `(currentAction === 'reinforce' || currentAction === 'husseinBonusReinforce') && sel.name === 'sector'`
     - In the equipment selection check (around line 181-182): Add `husseinBonusTactics` alongside `playTactics` for `dictatorEquipment` selection
     - In the tactics card display area (around line 112-116): Add `husseinBonusTactics` check so the tactics hand is shown when this action is available, and `husseinBonusReinforce` for the reinforce option

  3. Verify the DictatorPanel tactics UI (lines 112-116) shows cards for `husseinBonusTactics` the same way it shows them for `playTactics`:
     - `if (props.availableActions.includes('husseinBonusTactics') && props.tacticsHand.length > 0)` adds a "Play Tactics" button (or similar)
     - `if (props.availableActions.includes('husseinBonusReinforce') && props.tacticsHand.length > 0)` adds a "Reinforce" button
  </action>
  <verify>
  1. `npx tsc --noEmit` passes
  2. `npx vitest run` passes (no regressions)
  3. Grep verification:
     - `husseinBonusTactics` in flow.ts actionStep
     - `hussein-bonus-artillery` in flow.ts (post-effects wired)
     - `hussein-bonus-combat` in flow.ts (combat resolution wired)
     - `husseinBonusTactics` in DictatorPanel.vue dictatorSpecificActions array
     - `applyHusseinBonusTactics` imported in flow.ts
  </verify>
  <done>
  Hussein's per-turn double tactics is fully wired: AI auto-plays second card from deck, human sees "Hussein's Ability" prompt with full card/base/equipment selections. Post-effects (artillery, generalissimo, lockdown, combat) run after the second play. UI routes husseinBonusTactics/husseinBonusReinforce through DictatorPanel for sector and equipment selections. Hand refill runs after both plays.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors
2. `npx vitest run` -- all existing tests pass, no regressions
3. Grep verification:
   - `husseinBonusTactics` in flow.ts, dictator-actions.ts, index.ts, DictatorPanel.vue
   - `husseinBonusReinforce` in flow.ts, dictator-actions.ts, index.ts, DictatorPanel.vue
   - `applyHusseinBonusTactics` in dictator-abilities.ts and flow.ts
   - `hussein-bonus-artillery` loop in flow.ts
   - `hussein-bonus-combat` combatResolutionFlow in flow.ts
4. Flow order in dictator turn: ability step -> kim-militia-combat -> conscripts -> **hussein bonus draw/play -> hussein post-effects** -> refill hand
</verification>

<success_criteria>
- AI Hussein: `applyHusseinBonusTactics` auto-plays top card from deck each turn, with effects applied
- Human Hussein: sees "Hussein's Ability: Play a second tactics card" prompt after ability step
- Human Hussein: can choose to play a card (with base reveal support) or reinforce
- Post-effects: artillery allocation, generalissimo hire, lockdown placement, and combat resolution all run after the second play
- UI: DictatorPanel routes husseinBonusTactics/husseinBonusReinforce for sector/equipment selections
- Hand refill to 3 runs after both plays (existing step, unchanged)
- Type check and test suite pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/58-setup-phase-abilities/58-02-SUMMARY.md`
</output>
