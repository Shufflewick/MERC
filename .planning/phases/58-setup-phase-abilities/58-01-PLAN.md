---
phase: 58-setup-phase-abilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/dictator-abilities.ts
  - src/rules/actions/day-one-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/rules/constants.ts
autonomous: true

must_haves:
  truths:
    - "Hussein starts the game with 10 tactics cards instead of 5"
    - "Mao starts with 1 random MERC per rebel player, placed into chosen squads"
    - "Mussolini starts with 1 random MERC per rebel player, placed into chosen squads"
    - "Squad placement choices appear as interactive selections for human dictator"
    - "AI dictator auto-places bonus MERCs (primary first, then secondary)"
  artifacts:
    - path: "src/rules/dictator-abilities.ts"
      provides: "applyHusseinSetupAbility, applyMaoSetupAbility, applyMussoliniSetupAbility"
      contains: "case 'hussein'|case 'mao'|case 'mussolini' in applyDictatorSetupAbilities switch"
    - path: "src/rules/actions/day-one-actions.ts"
      provides: "createBonusMercSetupAction for Mao/Mussolini shared human-path squad choice"
    - path: "src/rules/flow.ts"
      provides: "bonus-merc-placement loop in Day 1 dictator landing sequence"
    - path: "src/rules/constants.ts"
      provides: "HUSSEIN_TACTICS_CARDS constant"
  key_links:
    - from: "src/rules/flow.ts"
      to: "bonusMercSetup action"
      via: "actionStep in bonus-merc-placement loop"
      pattern: "bonusMercSetup"
    - from: "src/rules/dictator-abilities.ts"
      to: "applyDictatorSetupAbilities switch"
      via: "case statements for hussein, mao, mussolini"
      pattern: "case 'hussein'|case 'mao'|case 'mussolini'"
    - from: "src/rules/actions/index.ts"
      to: "bonusMercSetup registration"
      via: "registerAllActions"
      pattern: "createBonusMercSetupAction"
---

<objective>
Implement setup-phase abilities for Hussein, Mao, and Mussolini.

Purpose: Three expansion dictators modify game state during Day 1 setup -- Hussein doubles his tactics deck from 5 to 10 cards, while Mao and Mussolini each start with 1 random bonus MERC per rebel player with interactive squad placement choice.

Output: AI-path functions in dictator-abilities.ts, human-path squad choice action in day-one-actions.ts, bonus-merc-placement loop in flow.ts Day 1 sequence, and action registration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-setup-phase-abilities/58-RESEARCH.md
@.planning/phases/57-simple-hire-abilities/57-01-SUMMARY.md

Key source files:
@src/rules/dictator-abilities.ts
@src/rules/actions/day-one-actions.ts
@src/rules/actions/index.ts
@src/rules/flow.ts
@src/rules/constants.ts
@src/rules/setup.ts
@src/rules/elements.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI-path setup ability functions and constants</name>
  <files>
    src/rules/dictator-abilities.ts
    src/rules/constants.ts
  </files>
  <action>
  **In src/rules/constants.ts:**
  Add `HUSSEIN_TACTICS_CARDS: 10` to the `DictatorConstants` object (alongside existing `ACTIVE_TACTICS_CARDS: 5`).

  **In src/rules/dictator-abilities.ts:**

  1. **Add `applyHusseinSetupAbility(game: MERCGame): DictatorAbilityResult`:**
     - Guard: check `dictator.combatantId === 'hussein'`, return failure if not
     - Get `tacticsDeck` from `game.dictatorPlayer.tacticsDeck`
     - Calculate `additionalNeeded = DictatorConstants.HUSSEIN_TACTICS_CARDS - tacticsDeck.count(TacticsCard)`
     - If `additionalNeeded <= 0`, return success (already at target)
     - Build pool of all available tactics from `game.tacticsData` (expand by quantity like `setupTacticsDeck` does)
     - Select `additionalNeeded` random tactics from pool using `game.random()`
     - Create new `TacticsCard` elements in the deck using `tacticsDeck.create(TacticsCard, ...)` with ID format `tactics-hussein-${t.id}-${i}` to avoid collisions
     - Set `tacticsId`, `tacticsName`, `story`, `description`, `revealsBase` properties on each new card (match the pattern in `setupTacticsDeck` in setup.ts lines 293-365)
     - Shuffle the deck after adding cards: `tacticsDeck.shuffle()`
     - `game.message(...)` announcing the expanded deck count
     - Return success with data `{ deckSize }`

  2. **Add `applyMaoSetupAbility(game: MERCGame): DictatorAbilityResult`:**
     - Guard: check `dictator.combatantId === 'mao'`, return failure if not
     - For AI only (`game.dictatorPlayer?.isAI`): loop `game.rebelCount` times
       - Draw MERC via `game.drawMerc()`. If null, message and break
       - Choose target squad: primary if not full, else secondary if not full, else discard to `game.mercDiscard` and continue
       - `merc.putInto(targetSquad)`
       - Call `selectNewMercLocation(game)` if squad has no sectorId, assign it
       - Auto-equip: Weapon first, then Armor, then Accessory (check what slots are empty). Use `equipNewHire(game, merc, equipType)` from helpers
       - `game.updateAllSargeBonuses()`
       - Emit map entry animation: `emitMapCombatantEntries(game, [buildMapCombatantEntry(merc)])`
       - Message each hire
     - For human players: return success with message "Handled via interactive flow" (the human path is the bonusMercSetup action loop)
     - Return success with data `{ hired }`
     - NOTE: Import `equipNewHire` from `./actions/helpers.js` (already imported) and `buildMapCombatantEntry`/`emitMapCombatantEntries` from `./animation-events.js` and `selectNewMercLocation` from `./ai-helpers.js` (already imported)

  3. **Add `applyMussoliniSetupAbility(game: MERCGame): DictatorAbilityResult`:**
     - Identical logic to `applyMaoSetupAbility` but checks `dictator.combatantId === 'mussolini'`
     - Same auto-place logic for AI, same "Handled via interactive flow" for human

  4. **Update `applyDictatorSetupAbilities()` switch statement:**
     - Add `case 'hussein': applyHusseinSetupAbility(game); break;`
     - Add `case 'mao': applyMaoSetupAbility(game); break;`
     - Add `case 'mussolini': applyMussoliniSetupAbility(game); break;`

  **Important:** For Mao/Mussolini, the AI path runs the full hire logic inside `applyDictatorSetupAbilities`. The human path only displays a message -- actual hiring is handled by the `bonusMercSetup` action in the flow loop (Task 2). This avoids double-hiring (Pitfall 7 from research).
  </action>
  <verify>
  `npx tsc --noEmit` passes. Grep for `case 'hussein'` and `case 'mao'` and `case 'mussolini'` in dictator-abilities.ts confirms all three are wired into the switch.
  </verify>
  <done>
  Hussein setup ability adds 5 extra tactics cards to deck (total 10). Mao/Mussolini AI path auto-hires N bonus MERCs (N = rebel count) into squads. Human path defers to interactive flow. All three wired into applyDictatorSetupAbilities switch.
  </done>
</task>

<task type="auto">
  <name>Task 2: Human-path squad choice action, registration, and flow loop</name>
  <files>
    src/rules/actions/day-one-actions.ts
    src/rules/actions/index.ts
    src/rules/flow.ts
  </files>
  <action>
  **In src/rules/actions/day-one-actions.ts:**

  Add `createBonusMercSetupAction(game: MERCGame): ActionDefinition` -- a shared action for both Mao and Mussolini:

  - Action name: `'bonusMercSetup'`
  - Prompt: "Dictator Ability: Choose squad for bonus MERC"
  - Conditions:
    - Is dictator player: `game.isDictatorPlayer(ctx.player)`
    - Is Mao or Mussolini: `dictator.combatantId === 'mao' || dictator.combatantId === 'mussolini'`
    - Is human player: `!game.dictatorPlayer?.isAI`
    - Has mercs to place: `getGlobalCachedValue<number>(game, '_bonus_mercs_remaining')` is > 0
  - Selection 1 (`selectedMerc`): `chooseFrom<string>` showing the drawn MERC name. In `choices()`:
    - Check for already-drawn MERC via `getGlobalCachedValue<string>(game, '_bonus_drawn_merc_id')`
    - If not drawn yet, call `game.drawMerc()`, cache the MERC's `.id` via `setGlobalCachedValue(game, '_bonus_drawn_merc_id', merc.id)`, return `[merc.combatantName]`
    - If already drawn, find by cached ID via `game.first(CombatantModel, m => m.id === mercId)`, return `[merc.combatantName]`
    - If no MERC available, return `['No MERCs available']`
  - Selection 2 (`targetSquad`): `chooseFrom<string>` "Assign to which squad?"
    - Choices: Build array from `'Primary Squad'` (if not full) and `'Secondary Squad'` (if not full). If both full, `['Squads full - MERC will be discarded']`
  - Selection 3 (`equipmentType`): `chooseFrom<string>` "Choose starting equipment type"
    - Choices: `['Weapon', 'Armor', 'Accessory']` -- filter based on what slots the drawn MERC already has filled (check `merc.weaponSlot`, `merc.armorSlot`, `merc.accessorySlot`)
  - Execute handler:
    - Find the cached MERC by ID from `_bonus_drawn_merc_id`
    - Determine target squad from `args.targetSquad` selection ('Primary Squad' -> `game.dictatorPlayer.primarySquad`, 'Secondary Squad' -> `game.dictatorPlayer.secondarySquad`)
    - If both squads full, discard MERC to `game.mercDiscard`
    - Otherwise: `merc.putInto(targetSquad)`, assign sector via `selectNewMercLocation(game)` if squad has no sectorId
    - Equip via `equipNewHire(game, merc, args.equipmentType as 'Weapon' | 'Armor' | 'Accessory')`
    - `game.updateAllSargeBonuses()`
    - Emit map entry animation
    - Decrement `_bonus_mercs_remaining` counter
    - Clear `_bonus_drawn_merc_id` cache
    - Message the hire result

  Import helpers: `getGlobalCachedValue`, `setGlobalCachedValue`, `clearGlobalCachedValue`, `equipNewHire` from `./helpers.js`; `selectNewMercLocation` from `../ai-helpers.js`; `buildMapCombatantEntry`, `emitMapCombatantEntries` from `../animation-events.js`; `CombatantModel` from `../elements.js`.

  **In src/rules/actions/index.ts:**
  - Import `createBonusMercSetupAction` from `./day-one-actions.js`
  - Register it in `registerAllActions`: `game.registerAction(createBonusMercSetupAction(game))`

  **In src/rules/flow.ts:**

  After the existing `dictator-setup-ability` step (line ~542) and BEFORE the `dictator-draw-tactics` step (line ~546), add:

  ```
  // Mao/Mussolini: Initialize bonus MERC counter for human path
  execute(() => {
    const dictator = game.dictatorPlayer?.dictator;
    if (!dictator) return;
    if (dictator.combatantId !== 'mao' && dictator.combatantId !== 'mussolini') return;
    if (game.dictatorPlayer?.isAI) return;  // AI handled in applyDictatorSetupAbilities
    setGlobalCachedValue(game, '_bonus_mercs_remaining', game.rebelCount);
  }),

  // Mao/Mussolini: Bonus MERC squad placement loop (human only)
  loop({
    name: 'bonus-merc-placement',
    while: () => {
      const dictator = game.dictatorPlayer?.dictator;
      if (dictator?.combatantId !== 'mao' && dictator?.combatantId !== 'mussolini') return false;
      if (game.dictatorPlayer?.isAI) return false;
      const remaining = getGlobalCachedValue<number>(game, '_bonus_mercs_remaining');
      return remaining !== undefined && remaining > 0;
    },
    maxIterations: 10,
    do: actionStep({
      name: 'bonus-merc-squad-choice',
      actions: ['bonusMercSetup'],
      prompt: "Dictator Ability: Choose squad for bonus MERC",
    }),
  }),
  ```

  Import `setGlobalCachedValue` and `getGlobalCachedValue` from `./actions/helpers.js` in flow.ts if not already imported.
  </action>
  <verify>
  `npx tsc --noEmit` passes. `npx vitest run` passes (no regressions). Grep for `bonusMercSetup` in flow.ts, day-one-actions.ts, and index.ts confirms action is registered and wired into the Day 1 flow.
  </verify>
  <done>
  Human Mao/Mussolini dictator sees an interactive squad choice loop during Day 1 -- for each bonus MERC (1 per rebel player), the dictator sees the MERC name, chooses Primary or Secondary squad, and chooses equipment type. Counter decrements each iteration. Action is registered and wired into Day 1 flow between setup-ability step and draw-tactics step.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors
2. `npx vitest run` -- all existing tests pass, no regressions
3. Grep verification:
   - `case 'hussein'` in dictator-abilities.ts `applyDictatorSetupAbilities` switch
   - `case 'mao'` in dictator-abilities.ts `applyDictatorSetupAbilities` switch
   - `case 'mussolini'` in dictator-abilities.ts `applyDictatorSetupAbilities` switch
   - `bonusMercSetup` in flow.ts, day-one-actions.ts, index.ts
   - `HUSSEIN_TACTICS_CARDS` in constants.ts
4. No changes to dictator turn flow (that's Plan 02)
</verification>

<success_criteria>
- Hussein AI: `applyHusseinSetupAbility` adds 5 extra tactics cards to deck (verified by deck count === 10)
- Mao/Mussolini AI: `applyMaoSetupAbility`/`applyMussoliniSetupAbility` auto-hires N bonus MERCs into squads
- Mao/Mussolini Human: `bonusMercSetup` action presents squad choice loop N times (N = rebel count)
- All three dictators wired into `applyDictatorSetupAbilities` switch
- Flow loop runs only for Mao/Mussolini human dictators, skips for all others
- Type check and test suite pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/58-setup-phase-abilities/58-01-SUMMARY.md`
</output>
