---
phase: 04-code-quality-state
plan: 03
type: execute
---

<objective>
Migrate rebel-economy.ts and flow.ts to use cache helpers, completing Phase 4.

Purpose: Replace remaining raw game.settings[] access with helpers for consistency.
Output: All action files use cache helpers consistently, phase complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-quality-state/04-02-SUMMARY.md

# Key files
@src/rules/actions/rebel-economy.ts
@src/rules/flow.ts

**Requires:** Plan 04-02 completed

**rebel-economy.ts - Hagness equipment draw:**
Lines 1150-1197: Uses custom `getSettingsKey(player)` that returns `hagnessBuyEquipment_${position}`
This is already player-scoped via position, so use regular getCachedValue pattern but with the position as "playerId".

Actually, looking at the pattern: the key is `hagnessBuyEquipment_${position}` where position is like "0", "1", etc.
We could use existing getCachedValue with prefix='hagnessBuyEquipment' and playerId=position.

**flow.ts - Extra militia check:**
Lines 201, 205: Read `_extra_militia_remaining` to control loop
Use getGlobalCachedValue since this is global dictator state.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate rebel-economy.ts Hagness equipment helpers</name>
  <files>src/rules/actions/rebel-economy.ts</files>
  <action>
The current pattern uses a custom `getSettingsKey` function. Replace with existing cache helpers.

Remove the local `getSettingsKey` helper function if it exists only for this purpose.

Replace raw access with getCachedValue pattern:
- Position is used as the player identifier in the key
- Prefix is 'hagnessBuyEquipment'

```typescript
// Before:
const settingsKey = getSettingsKey(ctx.player);
game.settings[settingsKey] = equipment.id;
const equipmentId = game.settings[settingsKey] as number | undefined;
delete game.settings[settingsKey];

// After:
const HAGNESS_BUY_EQUIPMENT_KEY = 'hagnessBuyEquipment';
const position = ctx.player.position.toString();
setCachedValue(game, HAGNESS_BUY_EQUIPMENT_KEY, position, equipment.id);
const equipmentId = getCachedValue<number>(game, HAGNESS_BUY_EQUIPMENT_KEY, position);
clearCachedValue(game, HAGNESS_BUY_EQUIPMENT_KEY, position);
```

Note: getCachedValue, setCachedValue, clearCachedValue should already be imported for HIRE_DRAWN_MERCS_KEY usage.
  </action>
  <verify>tsc --noEmit passes, grep "game\.settings\[settingsKey\]" returns no matches</verify>
  <done>Hagness equipment draw migrated to standard cache helpers</done>
</task>

<task type="auto">
  <name>Task 2: Migrate flow.ts extra militia check</name>
  <files>src/rules/flow.ts</files>
  <action>
Import getGlobalCachedValue from helpers:
```typescript
import { getGlobalCachedValue } from './actions/helpers';
```

Replace raw access at lines 201 and 205:
```typescript
// Before:
const remaining = game.settings['_extra_militia_remaining'] as number | undefined;

// After:
const remaining = getGlobalCachedValue<number>(game, '_extra_militia_remaining');
```

The key should match REMAINING_MILITIA_KEY from day-one-actions.ts. Consider defining the key in helpers.ts and exporting it, OR just use the string literal (simpler for now).
  </action>
  <verify>tsc --noEmit passes, grep "game\.settings\[" in flow.ts returns no matches</verify>
  <done>Flow.ts extra militia check migrated to global cache helper</done>
</task>

<task type="auto">
  <name>Task 3: Update ROADMAP and STATE for phase completion</name>
  <files>.planning/ROADMAP.md, .planning/STATE.md</files>
  <action>
Update ROADMAP.md:
- Mark Phase 4 plans as complete: 04-01, 04-02, 04-03
- Update progress table: Phase 4 = 3/3, Complete, today's date

Update STATE.md:
- Current Position: Phase 4 of 6 complete
- Last activity: today's date - Completed 04-03-PLAN.md
- Add decision: "Extended cache helpers with global variants for dictator/shared state"
  </action>
  <verify>cat .planning/ROADMAP.md | grep "Phase 4" shows complete status</verify>
  <done>Project tracking updated, Phase 4 marked complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No raw game.settings[] access in action files (except helpers.ts which defines them)
- [ ] Existing tests pass
- [ ] ROADMAP shows Phase 4 complete
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Consistent cache helper usage across all action files
- Phase 4 complete, ready for Phase 5
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality-state/04-03-SUMMARY.md`
</output>
