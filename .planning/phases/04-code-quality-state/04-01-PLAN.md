---
phase: 04-code-quality-state
plan: 01
type: execute
---

<objective>
Add global settings helpers and remove legacy pendingLoot property.

Purpose: Extend helpers.ts with non-player-scoped cache helpers for dictator/global state, and clean up unused legacy code.
Output: New helper functions in helpers.ts, pendingLoot removed from game.ts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-quality-helpers/03-01-SUMMARY.md

# Key files
@src/rules/actions/helpers.ts
@src/rules/game.ts

**Context from Phase 3:**
- Cache helpers established: getCachedValue, setCachedValue, clearCachedValue
- Pattern: prefix:playerId key structure
- Need: Global (non-player-scoped) variant for dictator/shared state

**Legacy code to remove:**
- pendingLoot property in game.ts (line 548) is declared but never used
- Was replaced by pendingLootMap but never removed

**Pattern analysis:**
The existing helpers use `prefix:playerId` pattern. Several places need global keys:
- dictator-actions.ts: `_castro_drawn_mercs`
- day-one-actions.ts: `dictatorFirstMercId`, `_extra_militia_remaining`
- rebel-economy.ts: `hagnessBuyEquipment_${position}` (uses custom getSettingsKey)
- flow.ts: `_extra_militia_remaining`

Adding getGlobalCachedValue/setGlobalCachedValue/clearGlobalCachedValue mirrors existing pattern for non-player cases.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add global cache helpers to helpers.ts</name>
  <files>src/rules/actions/helpers.ts</files>
  <action>
Add three new functions after the existing cache helpers section:

```typescript
/**
 * Get a cached value from game.settings using a simple key (no player scoping).
 * Use for global/dictator state that doesn't need per-player separation.
 */
export function getGlobalCachedValue<T>(game: MERCGame, key: string): T | undefined {
  return game.settings[key] as T | undefined;
}

/**
 * Set a cached value in game.settings using a simple key (no player scoping).
 * Use for global/dictator state that doesn't need per-player separation.
 */
export function setGlobalCachedValue<T>(game: MERCGame, key: string, value: T): void {
  game.settings[key] = value;
}

/**
 * Clear a cached value from game.settings using a simple key (no player scoping).
 * Use for global/dictator state that doesn't need per-player separation.
 */
export function clearGlobalCachedValue(game: MERCGame, key: string): void {
  delete game.settings[key];
}
```

Place these after line 161 (after clearCachedValue) with appropriate section comment.
  </action>
  <verify>tsc --noEmit passes, functions are exported</verify>
  <done>Three new global cache helper functions added and exported</done>
</task>

<task type="auto">
  <name>Task 2: Remove legacy pendingLoot property</name>
  <files>src/rules/game.ts</files>
  <action>
Remove lines 547-548:
```typescript
  // Legacy pendingLoot for backward compatibility (deprecated)
  pendingLoot: { sectorId: string; equipment: Equipment[] } | null = null;
```

This property is declared but never used anywhere in the codebase. It was replaced by pendingLootMap but never cleaned up.

Verify no usage with grep before removing.
  </action>
  <verify>grep -r "pendingLoot[^M]" src/rules/ returns only the definition (which will be gone after removal)</verify>
  <done>Legacy pendingLoot property removed from MERCGame class</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] New helper functions exported from helpers.ts
- [ ] pendingLoot property no longer exists in game.ts
- [ ] Existing tests pass (npm test)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No regressions in existing functionality
- Global cache helpers ready for use in subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality-state/04-01-SUMMARY.md`
</output>
