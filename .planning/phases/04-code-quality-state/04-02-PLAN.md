---
phase: 04-code-quality-state
plan: 02
type: execute
---

<objective>
Migrate dictator-actions.ts and day-one-actions.ts to use global cache helpers.

Purpose: Replace raw game.settings[] access with global cache helpers for consistency and type safety.
Output: Both files use getGlobalCachedValue/setGlobalCachedValue/clearGlobalCachedValue instead of raw access.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-quality-state/04-01-SUMMARY.md

# Key files
@src/rules/actions/dictator-actions.ts
@src/rules/actions/day-one-actions.ts

**Requires:** Plan 04-01 completed (global cache helpers exist)

**dictator-actions.ts locations:**
Line 340: `const DRAWN_MERCS_KEY = '_castro_drawn_mercs';`
Lines 359, 366, 369, 405, 409, 420, 452, 503: Raw game.settings[] access

**day-one-actions.ts locations:**
Lines 631-729: `DRAWN_MERC_KEY = 'dictatorFirstMercId'` - dictator's first merc draw
Lines 822-926: `REMAINING_MILITIA_KEY = '_extra_militia_remaining'` - extra militia placement

**Pattern:** Replace `game.settings[KEY]` with `getGlobalCachedValue(game, KEY)`, etc.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate dictator-actions.ts Castro special action</name>
  <files>src/rules/actions/dictator-actions.ts</files>
  <action>
Import the global cache helpers at top of file:
```typescript
import { getGlobalCachedValue, setGlobalCachedValue, clearGlobalCachedValue } from './helpers';
```

Replace all raw game.settings[DRAWN_MERCS_KEY] accesses (~8 locations):
- `game.settings[DRAWN_MERCS_KEY]` read → `getGlobalCachedValue<number[]>(game, DRAWN_MERCS_KEY)`
- `game.settings[DRAWN_MERCS_KEY] = value` → `setGlobalCachedValue(game, DRAWN_MERCS_KEY, value)`
- `delete game.settings[DRAWN_MERCS_KEY]` → `clearGlobalCachedValue(game, DRAWN_MERCS_KEY)`

The `|| []` fallback at line 405 becomes `?? []` with the helper (it returns undefined).
  </action>
  <verify>tsc --noEmit passes, grep "game\.settings\[DRAWN_MERCS_KEY\]" returns no matches in file</verify>
  <done>All Castro special action settings access migrated to global cache helpers</done>
</task>

<task type="auto">
  <name>Task 2: Migrate day-one-actions.ts dictator state</name>
  <files>src/rules/actions/day-one-actions.ts</files>
  <action>
Import the global cache helpers at top of file (add to existing helpers import):
```typescript
import { ..., getGlobalCachedValue, setGlobalCachedValue, clearGlobalCachedValue } from './helpers';
```

**Dictator first merc (DRAWN_MERC_KEY):**
Lines 636, 639, 643, 698, 703, 729 - Replace with global cache helpers.

**Extra militia (REMAINING_MILITIA_KEY):**
Lines 826, 837, 842, 866, 884, 890, 917, 926 - Replace with global cache helpers.

Note: Line 890 uses `?? total` fallback - use `getGlobalCachedValue<number>(game, KEY) ?? total`
  </action>
  <verify>tsc --noEmit passes, grep "game\.settings\[.*_KEY\]" returns no matches for DRAWN_MERC_KEY or REMAINING_MILITIA_KEY</verify>
  <done>All dictator first merc and extra militia settings access migrated to global cache helpers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No raw game.settings[KEY] access in dictator-actions.ts for DRAWN_MERCS_KEY
- [ ] No raw game.settings[KEY] access in day-one-actions.ts for DRAWN_MERC_KEY or REMAINING_MILITIA_KEY
- [ ] Existing tests pass
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Type safety improved (explicit generics on get calls)
- Consistent helper usage pattern
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality-state/04-02-SUMMARY.md`
</output>
