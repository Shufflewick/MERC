---
phase: 39-unify-ui-breakdown
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/components/CombatantCard.vue
autonomous: true

must_haves:
  truths:
    - "Ability bonuses display with proper labels (e.g., 'Stumpy's Ability +2')"
    - "No duplicate display of ability bonuses in tooltips"
    - "All 18 stat-modifying MERC abilities appear correctly in breakdowns"
    - "Vulture's penalty negation still displays correctly"
  artifacts:
    - path: "src/ui/components/CombatantCard.vue"
      provides: "Unified breakdown generation from activeStatModifiers"
      contains: "getAbilityModifiersForStat"
  key_links:
    - from: "src/ui/components/CombatantCard.vue"
      to: "activeStatModifiers"
      via: "getProp() in getAbilityModifiersForStat helper"
      pattern: "getProp.*activeStatModifiers"
---

<objective>
Replace hardcoded ability bonus checks in CombatantCard.vue with unified iteration over activeStatModifiers.

Purpose: Eliminate duplicate display bugs and remove maintenance burden of hardcoded ability checks. New abilities added to the registry will automatically appear in UI without Vue changes.

Output: Clean CombatantCard.vue that reads ability bonuses from server-provided activeStatModifiers array.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-unify-server-side-calculation/38-02-SUMMARY.md
@.planning/phases/39-unify-ui-breakdown/39-RESEARCH.md
@src/ui/components/CombatantCard.vue
@src/rules/merc-abilities.ts (first 100 lines - StatModifier interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MercData interface field and helper function</name>
  <files>src/ui/components/CombatantCard.vue</files>
  <action>
1. Add `activeStatModifiers` to the MercData interface (around line 15):
```typescript
interface MercData {
  // ... existing properties ...
  activeStatModifiers?: Array<{
    stat: string;
    bonus: number;
    label?: string;
  }>;
}
```

2. Add helper function after getProp() (around line 80):
```typescript
/**
 * Get ability modifiers for a specific stat from activeStatModifiers.
 * Returns breakdown items ready for display.
 */
function getAbilityModifiersForStat(stat: string): StatBreakdownItem[] {
  const modifiers = getProp<Array<{stat: string; bonus: number; label?: string}>>('activeStatModifiers', []);
  return modifiers
    .filter(m => m.stat === stat)
    .map(m => ({
      label: m.label || 'Ability',
      value: m.bonus
    }));
}
```

The helper filters activeStatModifiers by stat type and maps to StatBreakdownItem format.
  </action>
  <verify>
- File compiles: `npx vue-tsc --noEmit src/ui/components/CombatantCard.vue` (or check no red squiggles if running in dev mode)
- Helper function exists after getProp()
- MercData interface includes activeStatModifiers field
  </verify>
  <done>MercData interface updated and getAbilityModifiersForStat helper added</done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded bonus checks with unified iteration</name>
  <files>src/ui/components/CombatantCard.vue</files>
  <action>
Replace ALL hardcoded ability bonus checks with calls to getAbilityModifiersForStat(). Preserve only Vulture's special penalty negation logic.

**In buildStatBreakdown() (lines 185-243):**
- REMOVE Haarg-specific check (lines 220-229)
- REMOVE "Ability +X" fallback calculation for combat (lines 233-240)
- The function should only handle Base + Equipment bonuses

**In trainingBreakdown (lines 245-261):**
- REMOVE snakeSoloTrainingBonus check
- REMOVE tavistoWomanTrainingBonus check
- ADD: Append getAbilityModifiersForStat('training') results:
```typescript
const trainingBreakdown = computed(() => {
  const breakdown = buildStatBreakdown('training', 'baseTraining');
  // Add all ability modifiers for training
  breakdown.push(...getAbilityModifiersForStat('training'));
  return breakdown;
});
```

**In combatBreakdown (lines 263-310):**
- REMOVE all 8 individual bonus checks (boubaHandgunCombatBonus, mayhemUziCombatBonus, rozeskeArmorCombatBonus, stumpyExplosiveCombatBonus, vandradiMultiTargetCombatBonus, dutchUnarmedCombatBonus, snakeSoloCombatBonus, tavistoWomanCombatBonus)
- ADD: Append getAbilityModifiersForStat('combat') results

**In initiativeBreakdown (lines 312-360):**
- KEEP Vulture's penalty negation logic (lines 317-327) - this is intentional, calculates negation not a bonus
- REMOVE tackSquadInitiativeBonus check
- REMOVE valkyrieSquadInitiativeBonus check
- REMOVE dutchUnarmedInitiativeBonus check
- REMOVE snakeSoloInitiativeBonus check
- REMOVE tavistoWomanInitiativeBonus check
- ADD: Append getAbilityModifiersForStat('initiative') results AFTER Vulture check

**In targetsBreakdown (lines 361-404):**
- REMOVE moeSmawTargetBonus check
- REMOVE raWeaponTargetBonus check
- ADD: Append getAbilityModifiersForStat('targets') results

**In healthBreakdown (lines 407-418):**
- REMOVE "Ability" fallback calculation
- ADD: Append getAbilityModifiersForStat('health') results

**In actionsBreakdown (lines 464-471):**
- REMOVE hardcoded Ewok check (combatantId.value === 'ewok')
- ADD: Append getAbilityModifiersForStat('actions') results

**In targets computed (lines 167-182):**
- REMOVE moeBonus and raBonus manual addition
- Keep equipment bonuses; ability bonuses now come from effectiveTargets (if available) or the breakdown shows them

**Note:** Do NOT change the basic stat computeds (training, combat, initiative) - they already read from effectiveX properties which include ability bonuses from server calculation. Only the breakdown computeds need updating.
  </action>
  <verify>
Run tests to confirm no regressions:
```bash
npm test
```

Manual verification points (for later visual check):
- Stumpy with Mortar should show "Stumpy's Ability +2" once (not twice)
- Haarg with squad mate having higher stat shows "Haarg's Ability +1"
- Tack with highest initiative shows "Tack's Ability +1" on squad mates
- Vulture with armor penalty still shows "Vulture's Ability +3" (negating -3)
  </verify>
  <done>
- All hardcoded bonus field checks removed from breakdown computeds
- All breakdowns use getAbilityModifiersForStat() for ability bonuses
- Vulture's penalty negation preserved as intentional exception
- No duplicate ability display possible
  </done>
</task>

</tasks>

<verification>
1. All tests pass: `npm test`
2. No hardcoded bonus field reads remain in breakdown computeds (grep check):
   ```bash
   grep -E "(haarg|sarge|tack|valkyrie|bouba|mayhem|rozeske|stumpy|vandradi|dutch|snake|tavisto|moe|ra)[A-Z].*Bonus" src/ui/components/CombatantCard.vue
   ```
   Should return only the Vulture section (which intentionally remains).
3. getAbilityModifiersForStat helper exists and is used by all 6 breakdown computeds
</verification>

<success_criteria>
- [ ] MercData interface includes activeStatModifiers field
- [ ] getAbilityModifiersForStat helper function exists
- [ ] trainingBreakdown uses helper instead of hardcoded checks
- [ ] combatBreakdown uses helper instead of hardcoded checks (8 checks removed)
- [ ] initiativeBreakdown uses helper instead of hardcoded checks (5 checks removed, Vulture preserved)
- [ ] targetsBreakdown uses helper instead of hardcoded checks (2 checks removed)
- [ ] healthBreakdown uses helper instead of fallback calculation
- [ ] actionsBreakdown uses helper instead of Ewok hardcoded check
- [ ] No "Ability +X" generic fallback remains in buildStatBreakdown
- [ ] All 580+ tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/39-unify-ui-breakdown/39-01-SUMMARY.md`
</output>
