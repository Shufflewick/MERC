---
phase: 03-code-quality-helpers
plan: 01
type: execute
---

<objective>
Add new helper utilities to helpers.ts for extracting duplicate patterns.

Purpose: Create the shared utilities that will replace duplicated code across action files.
Output: Enhanced helpers.ts with isDictatorCard, getUnitName, cache helpers, and findUnitSector utilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/rules/actions/helpers.ts
@src/rules/elements.ts

**Prior phase context:**
- Phase 2 established type guard pattern: accept `unknown`, return type predicate
- Existing helpers: isRebelPlayer, asRebelPlayer, asMercCard, asSector, asEquipment, asTacticsCard, asSquad

**Patterns to add:**
1. isDictatorCard - type guard for DictatorCard detection (replaces 4 duplicate functions)
2. getUnitName - get name from MercCard or DictatorCard (replaces 6 duplicate functions)
3. Cache helpers - getCachedValue/setCachedValue/clearCachedValue (replaces 9 duplicate functions)
4. findUnitSector - locate sector containing a unit (replaces 4 duplicate functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isDictatorCard type guard and getUnitName helper</name>
  <files>src/rules/actions/helpers.ts</files>
  <action>
Add to helpers.ts after existing type assertion helpers:

1. Import DictatorCard from elements.js (add to existing import)

2. Add isDictatorCard type guard:
```typescript
/**
 * Check if a unit is a DictatorCard (type guard).
 */
export function isDictatorCard(unit: unknown): unit is DictatorCard {
  return unit instanceof DictatorCard;
}
```

3. Add getUnitName helper:
```typescript
/**
 * Get the display name from a MercCard or DictatorCard.
 * Works with any unit type that has mercName or dictatorName.
 */
export function getUnitName(unit: MercCard | DictatorCard): string {
  if (unit instanceof DictatorCard) {
    return unit.dictatorName;
  }
  return unit.mercName;
}
```

Place these in a new section "// ===== Unit Type Helpers =====" before the existing "// ===== Type Assertion Helpers =====" section.
  </action>
  <verify>TypeScript compiles: cd /Users/jtsmith/Dropbox/MERC/BoardSmith/MERC && npx tsc --noEmit</verify>
  <done>isDictatorCard and getUnitName functions exported from helpers.ts, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Add generic cache value helpers</name>
  <files>src/rules/actions/helpers.ts</files>
  <action>
Add to helpers.ts in a new section "// ===== Settings Cache Helpers =====":

```typescript
/**
 * Get a cached value from game.settings using prefix:playerId key pattern.
 * Returns undefined if not found.
 */
export function getCachedValue<T>(game: MERCGame, prefix: string, playerId: string): T | undefined {
  const key = `${prefix}:${playerId}`;
  return game.settings[key] as T | undefined;
}

/**
 * Set a cached value in game.settings using prefix:playerId key pattern.
 */
export function setCachedValue<T>(game: MERCGame, prefix: string, playerId: string, value: T): void {
  const key = `${prefix}:${playerId}`;
  game.settings[key] = value;
}

/**
 * Clear a cached value from game.settings using prefix:playerId key pattern.
 */
export function clearCachedValue(game: MERCGame, prefix: string, playerId: string): void {
  const key = `${prefix}:${playerId}`;
  delete game.settings[key];
}
```

Place this section after the Action Point Helpers section.
  </action>
  <verify>TypeScript compiles: cd /Users/jtsmith/Dropbox/MERC/BoardSmith/MERC && npx tsc --noEmit</verify>
  <done>getCachedValue, setCachedValue, clearCachedValue exported from helpers.ts</done>
</task>

<task type="auto">
  <name>Task 3: Add findUnitSector helper</name>
  <files>src/rules/actions/helpers.ts</files>
  <action>
Add to helpers.ts in the "// ===== Unit Type Helpers =====" section after getUnitName:

```typescript
/**
 * Find the sector containing a unit (MercCard or DictatorCard).
 * Searches across rebel squads and dictator units.
 * Returns null if unit is not in any sector.
 */
export function findUnitSector(unit: MercCard | DictatorCard, player: unknown, game: MERCGame): Sector | null {
  // Handle rebel player - search squads for the merc
  if (isRebelPlayer(player)) {
    if (!(unit instanceof MercCard)) return null;
    for (const squad of [player.primarySquad, player.secondarySquad]) {
      if (!squad?.sectorId) continue;
      const mercs = squad.getMercs();
      if (mercs.some(m => m.id === unit.id)) {
        return game.getSector(squad.sectorId) || null;
      }
    }
    return null;
  }

  // Handle dictator player
  if (game.isDictatorPlayer(player) && game.dictatorPlayer) {
    // DictatorCard has sectorId directly
    if (unit instanceof DictatorCard) {
      return unit.sectorId ? game.getSector(unit.sectorId) || null : null;
    }

    // MercCard - check squad or direct sectorId
    const merc = unit as MercCard;
    const squad = game.dictatorPlayer.getSquadContaining(merc);
    if (squad?.sectorId) {
      return game.getSector(squad.sectorId) || null;
    }
    if (merc.sectorId) {
      return game.getSector(merc.sectorId) || null;
    }
  }

  return null;
}
```

Note: This helper uses isRebelPlayer which is already in helpers.ts.
  </action>
  <verify>TypeScript compiles: cd /Users/jtsmith/Dropbox/MERC/BoardSmith/MERC && npx tsc --noEmit</verify>
  <done>findUnitSector exported from helpers.ts, handles both rebel and dictator players</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] helpers.ts exports: isDictatorCard, getUnitName, getCachedValue, setCachedValue, clearCachedValue, findUnitSector
- [ ] All new functions have JSDoc comments
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- helpers.ts has 6 new exported functions ready for use
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality-helpers/03-01-SUMMARY.md`
</output>
