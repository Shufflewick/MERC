---
phase: 03-code-quality-helpers
plan: 03
type: execute
---

<objective>
Replace duplicate helper patterns in rebel-equipment.ts with shared utilities.

Purpose: Remove duplicated code by using helpers from helpers.ts, reducing maintenance burden.
Output: rebel-equipment.ts using isDictatorCard, getUnitName, cache helpers, and findUnitSector.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-code-quality-helpers/03-01-SUMMARY.md
@.planning/phases/03-code-quality-helpers/03-02-SUMMARY.md
@src/rules/actions/helpers.ts
@src/rules/actions/rebel-equipment.ts

**Duplicate patterns to replace in rebel-equipment.ts:**
1. Lines 36-38: isDictatorCardForEquip → use isDictatorCard
2. Lines 41-46: getUnitNameForEquip → use getUnitName
3. Lines 49-80: findUnitSectorForEquip → use findUnitSector
4. Lines 952-983: Hagness equipment cache helpers → use cache helpers
5. Lines 1470-1488: findMercSectorForMortar → use findUnitSector
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace isDictatorCard, getUnitName, and findUnitSector duplicates</name>
  <files>src/rules/actions/rebel-equipment.ts</files>
  <action>
1. Update imports at top of file to add new helpers:
   - Add to existing helpers import: isDictatorCard, getUnitName, findUnitSector, getCachedValue, setCachedValue, clearCachedValue

2. Remove these local function definitions:
   - isDictatorCardForEquip (around line 36-38)
   - getUnitNameForEquip (around line 41-46)
   - findUnitSectorForEquip (around line 49-80)
   - findMercSectorForMortar (around line 1470-1488) - this is a variant of findUnitSector

3. Update all usages:
   - Replace `isDictatorCardForEquip(` with `isDictatorCard(`
   - Replace `getUnitNameForEquip(unit)` with `getUnitName(unit)`
   - Replace `findUnitSectorForEquip(unit, player, game)` with `findUnitSector(unit, player, game)`
   - Replace `findMercSectorForMortar(merc, player, game)` with `findUnitSector(merc, player, game)`

Note: findMercSectorForMortar has identical logic to findUnitSector for rebel players (only works with MercCard), so the shared helper works directly.
  </action>
  <verify>TypeScript compiles: cd /Users/jtsmith/Dropbox/MERC/BoardSmith/MERC && npx tsc --noEmit</verify>
  <done>All type guard and sector finder duplicates removed, using shared helpers</done>
</task>

<task type="auto">
  <name>Task 2: Replace Hagness equipment cache helpers</name>
  <files>src/rules/actions/rebel-equipment.ts</files>
  <action>
1. Locate the Hagness equipment cache helpers (around lines 952-983):
   - getHagnessEquipmentChoice / setHagnessEquipmentChoice / clearHagnessEquipmentChoice
   - getHagnessEquipmentTarget / setHagnessEquipmentTarget / clearHagnessEquipmentTarget

   These follow the same pattern as the hire cache helpers.

2. Keep the constants:
   - `const HAGNESS_EQUIPMENT_CHOICE_KEY = 'hagnessEquipmentChoice';`
   - `const HAGNESS_EQUIPMENT_TARGET_KEY = 'hagnessEquipmentTarget';`

3. Remove the local function definitions.

4. Update all usages to use generic cache helpers:
   - Replace `getHagnessEquipmentChoice(game, playerId)` with `getCachedValue<string>(game, HAGNESS_EQUIPMENT_CHOICE_KEY, playerId)`
   - Replace `setHagnessEquipmentChoice(game, playerId, choice)` with `setCachedValue(game, HAGNESS_EQUIPMENT_CHOICE_KEY, playerId, choice)`
   - Replace `clearHagnessEquipmentChoice(game, playerId)` with `clearCachedValue(game, HAGNESS_EQUIPMENT_CHOICE_KEY, playerId)`
   - Same pattern for target helpers

Note: The type parameter should match what was being cached (string for choice, number for target element id, etc.).
  </action>
  <verify>TypeScript compiles: cd /Users/jtsmith/Dropbox/MERC/BoardSmith/MERC && npx tsc --noEmit</verify>
  <done>Hagness cache helpers removed, using generic cache helpers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] No local isDictatorCard*, getUnitName*, findUnitSector*, or cache helper functions remain
- [ ] All functionality preserved (same behavior, just using shared helpers)
- [ ] Imports updated to include new helpers
</verification>

<success_criteria>

- All 2 tasks completed
- All verification checks pass
- rebel-equipment.ts reduced by ~80 lines of duplicate code
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality-helpers/03-03-SUMMARY.md`
</output>
