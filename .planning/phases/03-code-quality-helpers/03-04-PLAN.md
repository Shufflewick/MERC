---
phase: 03-code-quality-helpers
plan: 04
type: execute
---

<objective>
Replace duplicate helper patterns in day-one-actions.ts and dictator-actions.ts with shared utilities.

Purpose: Complete helper extraction by updating remaining files with duplicated patterns.
Output: day-one-actions.ts and dictator-actions.ts using shared helpers, Phase 3 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-code-quality-helpers/03-01-SUMMARY.md
@.planning/phases/03-code-quality-helpers/03-02-SUMMARY.md
@.planning/phases/03-code-quality-helpers/03-03-SUMMARY.md
@src/rules/actions/helpers.ts
@src/rules/actions/day-one-actions.ts
@src/rules/actions/dictator-actions.ts

**Duplicate patterns to replace:**

day-one-actions.ts:
1. Lines 34-53: getCachedMercIds/setCachedMercIds/clearCachedMercIds → use cache helpers

dictator-actions.ts:
1. Lines 31-36: getDictatorUnitName → use getUnitName (if applicable)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace cache helpers in day-one-actions.ts</name>
  <files>src/rules/actions/day-one-actions.ts</files>
  <action>
1. Update imports at top of file to add cache helpers:
   - Add to existing helpers import: getCachedValue, setCachedValue, clearCachedValue

2. Keep the constant: `const DRAWN_MERCS_KEY = 'drawnMercs';`

3. Remove these local function definitions (around lines 34-53):
   - getCachedMercIds
   - setCachedMercIds
   - clearCachedMercIds

4. Update all usages to use generic cache helpers:
   - Replace `getCachedMercIds(game, playerId)` with `getCachedValue<number[]>(game, DRAWN_MERCS_KEY, playerId)`
   - Replace `setCachedMercIds(game, playerId, mercIds)` with `setCachedValue(game, DRAWN_MERCS_KEY, playerId, mercIds)`
   - Replace `clearCachedMercIds(game, playerId)` with `clearCachedValue(game, DRAWN_MERCS_KEY, playerId)`
  </action>
  <verify>TypeScript compiles: cd /Users/jtsmith/Dropbox/MERC/BoardSmith/MERC && npx tsc --noEmit</verify>
  <done>day-one-actions.ts cache helpers replaced with shared utilities</done>
</task>

<task type="auto">
  <name>Task 2: Review and update dictator-actions.ts</name>
  <files>src/rules/actions/dictator-actions.ts</files>
  <action>
1. Check if getDictatorUnitName (around line 31-36) can use getUnitName helper:
   - If it handles both MercCard and DictatorCard with mercName/dictatorName, replace with getUnitName
   - If it has dictator-specific logic, keep it but ensure no duplication

2. Update imports if needed:
   - Add isDictatorCard, getUnitName if they will be used

3. Search for any other duplicate patterns that could use helpers:
   - isDictatorCard type checks
   - Unit name lookups
   - Sector finding logic

Replace any found duplicates with helper calls.
  </action>
  <verify>TypeScript compiles: cd /Users/jtsmith/Dropbox/MERC/BoardSmith/MERC && npx tsc --noEmit</verify>
  <done>dictator-actions.ts reviewed and updated to use shared helpers where applicable</done>
</task>

<task type="auto">
  <name>Task 3: Final verification and cleanup</name>
  <files>src/rules/actions/*.ts</files>
  <action>
1. Run grep to confirm no remaining local duplicates:
   ```bash
   grep -n "isDictatorCard" src/rules/actions/*.ts | grep "function"
   grep -n "getUnitName" src/rules/actions/*.ts | grep "function"
   grep -n "findUnitSector\|findMercSector" src/rules/actions/*.ts | grep "function"
   ```

2. Verify no unused imports in helpers.ts

3. Run full TypeScript check and tests:
   ```bash
   npx tsc --noEmit
   npm test
   ```

4. If any duplicates remain, document them for potential future extraction.
  </action>
  <verify>All tests pass: cd /Users/jtsmith/Dropbox/MERC/BoardSmith/MERC && npm test</verify>
  <done>No duplicate patterns remain, all tests pass, Phase 3 complete</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm test` passes all tests
- [ ] No local isDictatorCard*, getUnitName*, findUnitSector*, or cache helper functions remain in action files
- [ ] helpers.ts is the single source for shared utilities
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- All 4 action files updated to use shared helpers
- No TypeScript errors
- All tests pass
- Phase 3: Code Quality: Helpers complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality-helpers/03-04-SUMMARY.md`:

Include:
- Total lines of code removed across all files
- List of all helper functions added
- Any patterns that couldn't be extracted (and why)
- Next phase readiness
</output>
