---
phase: 57-simple-hire-abilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
autonomous: true

must_haves:
  truths:
    - "Gaddafi hires 1 random MERC per turn during the dictator ability step"
    - "Stalin hires 1 random MERC to primary squad each turn"
    - "Stalin hires a second MERC to secondary squad when base is revealed"
    - "Hired MERCs appear in the correct squad and are usable in the dictator turn"
    - "Human dictator players see hire choices in the UI and can select equipment/sector"
    - "AI dictator auto-applies hire abilities without user interaction"
    - "AI-path functions do NOT emit map animations (mutations and messages only)"
  artifacts:
    - path: "src/rules/dictator-abilities.ts"
      provides: "AI-path Gaddafi and Stalin turn abilities"
      contains: "applyGadafiTurnAbility|applyStalinTurnAbility"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "Human-path Gaddafi and Stalin hire actions"
      contains: "createGadafiBonusHireAction|createStalinBonusHireAction"
    - path: "src/rules/actions/index.ts"
      provides: "Registration of both new actions"
      contains: "createGadafiBonusHireAction|createStalinBonusHireAction"
  key_links:
    - from: "src/rules/dictator-abilities.ts"
      to: "applyDictatorTurnAbilities switch"
      via: "case 'gadafi' and case 'stalin' in switch statement"
      pattern: "case 'gadafi':|case 'stalin':"
    - from: "src/rules/actions/dictator-actions.ts"
      to: "src/rules/actions/index.ts"
      via: "import and registerAction calls"
      pattern: "createGadafiBonusHireAction|createStalinBonusHireAction"
---

<objective>
Implement AI-path and human-path hire abilities for Gaddafi and Stalin, following the established Castro two-path pattern.

Purpose: TURN-01 (Gaddafi) and TURN-08 (Stalin) are the simplest expansion dictator abilities -- direct variations of the existing Castro hire pattern. Completing these establishes the hire pattern for later phases.

Output: Both dictators can hire MERCs each turn via AI or human paths, with action registration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-simple-hire-abilities/57-RESEARCH.md

Key source files (read these for pattern reference):
@src/rules/dictator-abilities.ts
@src/rules/actions/dictator-actions.ts (especially createCastroBonusHireAction starting ~line 304)
@src/rules/actions/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI-path functions and switch cases in dictator-abilities.ts</name>
  <files>
    src/rules/dictator-abilities.ts
  </files>
  <action>
IMPORTANT: AI-path functions run via `execute()` in flow.ts with no UI listener. They must NOT emit map animations. Follow the Castro AI-path pattern exactly: mutations + messages only. Do NOT import or call `emitMapCombatantEntries`, `buildMapCombatantEntry`, or anything from `'./animation-events.js'`. The research document examples are WRONG about AI-path animations -- ignore them.

1. Add `applyGadafiTurnAbility(game: MERCGame): DictatorAbilityResult` function:
   - Guard: `dictator.combatantId !== 'gadafi'` returns early
   - Draw 1 MERC via `game.drawMerc()`. If none, message and return failure
   - Find first non-full squad (primary first, then secondary). If both full, discard to `game.mercDiscard` and return failure
   - Place via `merc.putInto(targetSquad)`
   - Select sector via `selectNewMercLocation(game)`, set `targetSquad.sectorId`
   - Choose equipment type (Weapon first, then Armor if weapon occupied, then Accessory)
   - Call `equipNewHire(game, merc, equipType)`
   - Call `game.updateAllSargeBonuses()`
   - Message `Gaddafi hired ${merc.combatantName}`
   - NO animation calls -- AI path has no UI listener

2. Add `applyStalinTurnAbility(game: MERCGame): DictatorAbilityResult` function:
   - Guard: `dictator.combatantId !== 'stalin'` returns early
   - First hire: always to primary squad. Draw 1 via `game.drawMerc()`. If primary full, discard. Otherwise place, equip, update bonuses (same pattern as Gaddafi, NO animations)
   - Second hire: only if `game.dictatorPlayer.baseRevealed === true`. Draw another via `game.drawMerc()`. Target is secondary squad. If secondary full, discard. Otherwise place, equip, update bonuses
   - Message each hire separately ("Stalin hired X to primary/secondary squad")
   - Return success even if some hires were skipped (squads full or base not revealed)
   - NO animation calls in either hire path

3. Update `applyDictatorTurnAbilities` switch statement (~line 301):
   - Add `case 'gadafi': applyGadafiTurnAbility(game); break;`
   - Add `case 'stalin': applyStalinTurnAbility(game); break;`
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors in dictator-abilities.ts. Grep the new functions for any animation imports -- there should be NONE.
  </verify>
  <done>
Both AI-path functions exist with switch cases. No animation imports or calls. TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Human-path actions and registration in dictator-actions.ts and index.ts</name>
  <files>
    src/rules/actions/dictator-actions.ts
    src/rules/actions/index.ts
  </files>
  <action>
**Gaddafi human-path (dictator-actions.ts):**

1. Add `createGadafiBonusHireAction(game: MERCGame): ActionDefinition`:
   - Action name: `'gadafiBonusHire'`
   - Prompt: `"Gaddafi's Ability: Hire a MERC"`
   - Condition: `isDictatorPlayer`, combatantId === 'gadafi', not AI
   - Use cached value pattern with key `'_gadafi_drawn_merc'` to persist the drawn MERC across selection steps
   - First `chooseFrom('selectedMerc')`: Draw 1 MERC (cache its element ID), display as single-item list showing capitalized name. If no MERC available, show `['No MERCs available']`
   - Second `chooseFrom('equipmentType')`: choices `['Weapon', 'Armor', 'Accessory']`
   - Third `chooseFrom('targetSector')`: Follow Castro's sector choice logic exactly (lines 347-380 of dictator-actions.ts) -- check squad sector occupancy, filter to dictator-controlled sectors, fallback to industries
   - `execute`: Find MERC from cached ID, find target sector by name (use Castro's matching logic), determine squad (Castro's squad selection logic lines 432-461), place via `putInto`, set `sectorId`, emit map animation, update bonuses, equip, clear cache. Discard if squads full.
   - IMPORTANT: Clear the cached value in ALL exit paths (success, failure, squads full)

**Stalin human-path (dictator-actions.ts):**

2. Add `createStalinBonusHireAction(game: MERCGame): ActionDefinition`:
   - Action name: `'stalinBonusHire'`
   - Prompt: `"Stalin's Ability: Hire MERCs"`
   - Condition: `isDictatorPlayer`, combatantId === 'stalin', not AI
   - Use cached value key: `'_stalin_drawn_merc_primary'`
   - **Strategy: Single action, primary hire has human choices, secondary hire is auto-placed in execute.** BoardSmith's `chooseFrom` does NOT support `skipIf` -- conditional selection steps are not available on the Action builder API. Therefore, the human only makes choices for the primary hire. The secondary hire (when base is revealed) is handled automatically in `execute` using AI-style auto-placement.
   - First `chooseFrom('selectedMerc')`: Draw 1 MERC for primary squad, cache its ID, display name. Single item, no real choice (like Gaddafi)
   - Second `chooseFrom('equipmentType')`: equipment for first MERC
   - Third `chooseFrom('targetSector')`: sector for first MERC (same sector logic as Castro)
   - `execute`:
     - Place first MERC into primary squad (or first available). Emit map animation, update bonuses, equip, clear cache.
     - If `game.dictatorPlayer.baseRevealed === true` AND secondary squad is not full: draw second MERC via `game.drawMerc()`, auto-place into secondary squad, select sector via `selectNewMercLocation(game)`, choose equipment type automatically (Weapon first, then Armor, then Accessory), call `equipNewHire`, emit map animation, update bonuses. Message each hire.
     - If secondary squad is full or base not revealed, skip second hire.
   - IMPORTANT: Clear cached values in ALL exit paths

3. Ensure both `createGadafiBonusHireAction` and `createStalinBonusHireAction` are exported from dictator-actions.ts.

**Registration (actions/index.ts):**

4. Add imports for `createGadafiBonusHireAction` and `createStalinBonusHireAction` to the import block from `'./dictator-actions.js'` (~line 96-102)
5. Add registration calls in `registerAllActions` after the existing Castro/Kim lines (~line 205-206):
   ```
   game.registerAction(createGadafiBonusHireAction(game));
   game.registerAction(createStalinBonusHireAction(game));
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors across all modified files.
  </verify>
  <done>
Both human-path actions exist in dictator-actions.ts and are registered in index.ts. Stalin uses single-action approach with auto-placed secondary hire in execute. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes clean
2. `applyDictatorTurnAbilities` switch handles `'gadafi'` and `'stalin'`
3. `registerAllActions` includes both new action registrations
4. AI-path functions in dictator-abilities.ts do NOT import or call any animation functions
</verification>

<success_criteria>
- Gaddafi AI path: draws 1 MERC, places in first available squad, equips, messages (no animations)
- Stalin AI path: draws 1 MERC to primary; if baseRevealed, draws second to secondary (no animations)
- Gaddafi human path: shows MERC name, equipment choice, sector choice
- Stalin human path: shows primary hire choices; secondary hire auto-placed in execute when base revealed
- Both actions registered in index.ts
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/57-simple-hire-abilities/57-01-SUMMARY.md`
</output>
