---
phase: 57-simple-hire-abilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
  - src/ui/composables/useActionState.ts
  - src/ui/components/GameTable.vue
autonomous: true

must_haves:
  truths:
    - "Gaddafi hires 1 random MERC per turn during the dictator ability step"
    - "Stalin hires 1 random MERC to primary squad each turn"
    - "Stalin hires a second MERC to secondary squad when base is revealed"
    - "Hired MERCs appear in the correct squad and are usable in the dictator turn"
    - "Human dictator players see hire choices in the UI and can select equipment/sector"
    - "AI dictator auto-applies hire abilities without user interaction"
  artifacts:
    - path: "src/rules/dictator-abilities.ts"
      provides: "AI-path Gaddafi and Stalin turn abilities"
      contains: "applyGadafiTurnAbility|applyStalinTurnAbility"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "Human-path Gaddafi and Stalin hire actions"
      contains: "createGadafiBonusHireAction|createStalinBonusHireAction"
    - path: "src/rules/flow.ts"
      provides: "Both action names in dictator-ability step"
      contains: "gadafiBonusHire.*stalinBonusHire"
  key_links:
    - from: "src/rules/dictator-abilities.ts"
      to: "applyDictatorTurnAbilities switch"
      via: "case 'gadafi' and case 'stalin' in switch statement"
      pattern: "case 'gadafi':|case 'stalin':"
    - from: "src/rules/actions/dictator-actions.ts"
      to: "src/rules/actions/index.ts"
      via: "import and registerAction calls"
      pattern: "createGadafiBonusHireAction|createStalinBonusHireAction"
    - from: "src/rules/flow.ts"
      to: "action step actions array"
      via: "gadafiBonusHire and stalinBonusHire in actions array"
      pattern: "'gadafiBonusHire'.*'stalinBonusHire'"
    - from: "src/ui/components/DictatorPanel.vue"
      to: "dictatorSpecificActions array"
      via: "action name inclusion for UI routing"
      pattern: "gadafiBonusHire|stalinBonusHire"
---

<objective>
Implement per-turn hire abilities for Gaddafi and Stalin, following the established Castro two-path pattern (AI-path in dictator-abilities.ts, human-path in dictator-actions.ts).

Purpose: TURN-01 (Gaddafi) and TURN-08 (Stalin) are the simplest expansion dictator abilities -- direct variations of the existing Castro hire pattern. Completing these establishes the hire pattern for later phases (Hitler in Phase 60 also hires).

Output: Both dictators can hire MERCs each turn via AI or human paths, with full UI support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-simple-hire-abilities/57-RESEARCH.md

Key source files (read these for pattern reference):
@src/rules/dictator-abilities.ts
@src/rules/actions/dictator-actions.ts (especially createCastroBonusHireAction starting ~line 304)
@src/rules/actions/index.ts
@src/rules/flow.ts (lines 948-963 for dictator-ability step)
@src/ui/components/DictatorPanel.vue (lines 127-153)
@src/ui/composables/useActionState.ts (line 246)
@src/ui/components/GameTable.vue (line 903)
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI-path and human-path hire abilities for Gaddafi and Stalin</name>
  <files>
    src/rules/dictator-abilities.ts
    src/rules/actions/dictator-actions.ts
    src/rules/actions/index.ts
  </files>
  <action>
**AI-path (dictator-abilities.ts):**

1. Add `applyGadafiTurnAbility(game: MERCGame): DictatorAbilityResult` function:
   - Guard: `dictator.combatantId !== 'gadafi'` returns early
   - Draw 1 MERC via `game.drawMerc()`. If none, message and return failure
   - Find first non-full squad (primary first, then secondary). If both full, discard to `game.mercDiscard` and return failure
   - Place via `merc.putInto(targetSquad)`
   - Select sector via `selectNewMercLocation(game)`, set `targetSquad.sectorId`
   - Choose equipment type (Weapon first, then Armor if weapon occupied, then Accessory)
   - Call `equipNewHire(game, merc, equipType)`
   - Emit map animation via `emitMapCombatantEntries(game, [buildMapCombatantEntry(merc, sectorId)])`
   - Call `game.updateAllSargeBonuses()`
   - Message `Gaddafi hired ${merc.combatantName}`
   - Import `buildMapCombatantEntry` and `emitMapCombatantEntries` from `../animation-events.js` (add to existing imports)

2. Add `applyStalinTurnAbility(game: MERCGame): DictatorAbilityResult` function:
   - Guard: `dictator.combatantId !== 'stalin'` returns early
   - First hire: always to primary squad. Draw 1 via `game.drawMerc()`. If primary full, discard. Otherwise place, equip, animate, update bonuses (same pattern as Gaddafi)
   - Second hire: only if `game.dictatorPlayer.baseRevealed === true`. Draw another via `game.drawMerc()`. Target is secondary squad. If secondary full, discard. Otherwise place, equip, animate, update bonuses
   - Message each hire separately ("Stalin hired X to primary/secondary squad")
   - Return success even if some hires were skipped (squads full or base not revealed)

3. Update `applyDictatorTurnAbilities` switch statement (~line 301):
   - Add `case 'gadafi': applyGadafiTurnAbility(game); break;`
   - Add `case 'stalin': applyStalinTurnAbility(game); break;`

**Human-path (dictator-actions.ts):**

4. Add `createGadafiBonusHireAction(game: MERCGame): ActionDefinition`:
   - Action name: `'gadafiBonusHire'`
   - Prompt: `"Gaddafi's Ability: Hire a MERC"`
   - Condition: `isDictatorPlayer`, combatantId === 'gadafi', not AI
   - Use cached value pattern with key `'_gadafi_drawn_merc'` to persist the drawn MERC across selection steps
   - First `chooseFrom('selectedMerc')`: Draw 1 MERC (cache its element ID), display as single-item list showing capitalized name. If no MERC available, show `['No MERCs available']`
   - Second `chooseFrom('equipmentType')`: choices `['Weapon', 'Armor', 'Accessory']`
   - Third `chooseFrom('targetSector')`: Follow Castro's sector choice logic exactly (lines 347-380 of dictator-actions.ts) -- check squad sector occupancy, filter to dictator-controlled sectors, fallback to industries
   - `execute`: Find MERC from cached ID, find target sector by name (use Castro's matching logic), determine squad (Castro's squad selection logic lines 432-461), place via `putInto`, set `sectorId`, emit map animation, update bonuses, equip, clear cache. Discard if squads full.
   - IMPORTANT: Clear the cached value in ALL exit paths (success, failure, squads full)

5. Add `createStalinBonusHireAction(game: MERCGame): ActionDefinition`:
   - Action name: `'stalinBonusHire'`
   - Prompt: `"Stalin's Ability: Hire MERCs"`
   - Condition: `isDictatorPlayer`, combatantId === 'stalin', not AI
   - Use cached value keys: `'_stalin_drawn_merc_primary'` and `'_stalin_drawn_merc_secondary'`
   - First `chooseFrom('selectedMerc')`: Draw 1 MERC for primary squad, cache its ID, display name. Single item, no real choice (like Gaddafi)
   - Second `chooseFrom('equipmentType')`: equipment for first MERC
   - Third `chooseFrom('targetSector')`: sector for first MERC (same sector logic as Castro)
   - If `game.dictatorPlayer.baseRevealed` AND secondary squad is not full:
     - Fourth `chooseFrom('secondaryMerc')`: Draw 1 more MERC, cache ID, display name
     - Fifth `chooseFrom('secondaryEquipmentType')`: equipment for second MERC
     - Sixth `chooseFrom('secondarySector')`: sector for second MERC
   - For conditional selections (the secondary hire), use the `skipIf` option on the `chooseFrom` calls: `skipIf: () => !game.dictatorPlayer.baseRevealed || game.dictatorPlayer.secondarySquad.isFull`
   - `execute`: Place first MERC into primary squad (or first available). If base revealed, place second MERC into secondary squad. Emit map animations, update bonuses, equip both, clear all caches.
   - If `skipIf` is not available on `chooseFrom`, use a single execute that handles both hires -- draw the primary MERC in the first chooseFrom, and if base is revealed, draw and auto-place the secondary MERC in execute (AI-style, no human choice for second). Check RESEARCH.md recommendation: "Single action `stalinBonusHire` that handles both hires."

6. Update `dictator-actions.ts` exports: ensure both `createGadafiBonusHireAction` and `createStalinBonusHireAction` are exported.

**Registration (actions/index.ts):**

7. Add imports for `createGadafiBonusHireAction` and `createStalinBonusHireAction` to the import block from `'./dictator-actions.js'` (~line 96-102)
8. Add registration calls in `registerAllActions` after the existing Castro/Kim lines (~line 205-206):
   ```
   game.registerAction(createGadafiBonusHireAction(game));
   game.registerAction(createStalinBonusHireAction(game));
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors across all modified files.
  </verify>
  <done>
Both AI-path functions exist in dictator-abilities.ts with switch cases. Both human-path actions exist in dictator-actions.ts and are registered in index.ts. TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Flow step and UI wiring</name>
  <files>
    src/rules/flow.ts
    src/ui/components/DictatorPanel.vue
    src/ui/composables/useActionState.ts
    src/ui/components/GameTable.vue
  </files>
  <action>
1. **flow.ts** (~line 961): Add `'gadafiBonusHire'` and `'stalinBonusHire'` to the `actions` array in the `dictator-ability` actionStep:
   ```typescript
   actions: ['castroBonusHire', 'kimBonusMilitia', 'gadafiBonusHire', 'stalinBonusHire'],
   ```

2. **DictatorPanel.vue** (~line 128): Add `'gadafiBonusHire'` and `'stalinBonusHire'` to the `dictatorSpecificActions` array so the DictatorPanel handles these actions.

3. **DictatorPanel.vue** (~line 152): Add both action names to the sector selection conditional:
   ```typescript
   if (currentAction === 'castroBonusHire' || currentAction === 'kimBonusMilitia' || currentAction === 'generalissimoPick' || currentAction === 'lockdownPlaceMilitia' || currentAction === 'gadafiBonusHire' || currentAction === 'stalinBonusHire') {
   ```

4. **DictatorPanel.vue** (~line 134): Add computed properties for Gaddafi/Stalin hiring state (follow `isCastroHiring` pattern):
   ```typescript
   const isGadafiHiring = computed(() => {
     return props.actionController.currentAction.value === 'gadafiBonusHire';
   });
   const isStalinHiring = computed(() => {
     return props.actionController.currentAction.value === 'stalinBonusHire';
   });
   ```
   These may be needed by the template for showing the hire UI. Check if `isCastroHiring` is used in the template -- if it triggers the main hiring UI in GameTable.vue instead, then the Gaddafi/Stalin equivalents should also be wired the same way.

5. **useActionState.ts** (~line 246): Add `'gadafiBonusHire'` and `'stalinBonusHire'` to the `hiringActions` array:
   ```typescript
   const hiringActions = ['hireFirstMerc', 'hireSecondMerc', 'hireThirdMerc', 'dictatorHireFirstMerc', 'castroBonusHire', 'gadafiBonusHire', 'stalinBonusHire', 'selectDictator'];
   ```

6. **GameTable.vue** (~line 903): Add `'gadafiBonusHire'` and `'stalinBonusHire'` to the `hiringActions` array:
   ```typescript
   const hiringActions = ['placeLanding', 'selectDictator', 'hireFirstMerc', 'hireSecondMerc', 'hireThirdMerc', 'dictatorHireFirstMerc', 'castroBonusHire', 'gadafiBonusHire', 'stalinBonusHire'];
   ```

7. Check if there are any other places in useActionState.ts that reference `castroBonusHire` specifically (the research mentions lines 172, 229, 323). If those are additional arrays or conditionals, add the new action names there too. Grep for `castroBonusHire` across useActionState.ts and handle all occurrences.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Then grep all UI files for `castroBonusHire` and verify that every array/conditional containing it also contains `gadafiBonusHire` and `stalinBonusHire`.
  </verify>
  <done>
Flow step lists all 4 dictator ability actions. All 3 UI files (DictatorPanel.vue, useActionState.ts, GameTable.vue) route the new action names correctly. No `castroBonusHire` reference exists without corresponding Gaddafi/Stalin entries.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify with type check and smoke test</name>
  <files></files>
  <action>
1. Run `npx tsc --noEmit` -- must pass clean
2. Run the existing test suite: `npx vitest run` -- all existing tests must still pass
3. Grep the codebase for any remaining references to `castroBonusHire` that might indicate a missed UI wiring point. Every array containing `castroBonusHire` should also contain `gadafiBonusHire` and `stalinBonusHire`.
4. Verify the switch statement in `applyDictatorTurnAbilities` now handles `'gadafi'` and `'stalin'` cases.
5. Verify the `registerAllActions` function registers both new actions.
  </action>
  <verify>
`npx tsc --noEmit` exits 0. `npx vitest run` exits 0 with no new failures.
  </verify>
  <done>
All type checks pass, all existing tests pass, no wiring gaps found. Phase 57 implementation is complete.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes clean
2. `npx vitest run` passes with no regressions
3. Every occurrence of `castroBonusHire` in UI files has corresponding `gadafiBonusHire` and `stalinBonusHire` entries
4. `applyDictatorTurnAbilities` switch handles `'gadafi'` and `'stalin'`
5. `registerAllActions` includes both new action registrations
6. Flow step `dictator-ability` lists all 4 ability action names
</verification>

<success_criteria>
- Gaddafi AI path: draws 1 MERC, places in first available squad, equips, animates
- Stalin AI path: draws 1 MERC to primary; if baseRevealed, draws second to secondary
- Gaddafi human path: shows MERC name, equipment choice, sector choice
- Stalin human path: shows primary hire choices; conditional secondary hire if base revealed
- Both actions registered, in flow step, and routed by all 3 UI files
- TypeScript compiles clean, existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/57-simple-hire-abilities/57-01-SUMMARY.md`
</output>
