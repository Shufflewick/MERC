---
phase: 61-reactive-abilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/game.ts
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
  - src/ui/composables/useActionState.ts
autonomous: true

must_haves:
  truths:
    - "Pinochet distributes damage equal to rebel-controlled sector count across all rebel forces each turn"
    - "Damage is spread as evenly as possible across living MERCs and militia"
    - "When Pinochet loses control of a sector during rebel turns, a free MERC hire is queued"
    - "Queued hires are placed at the start of the next dictator turn"
    - "Multiple sector losses in one rebel turn queue multiple hires"
    - "Pinochet abilities work for both AI and human dictator players"
  artifacts:
    - path: "src/rules/dictator-abilities.ts"
      provides: "applyPinochetTurnAbility damage spread function"
      contains: "applyPinochetTurnAbility"
    - path: "src/rules/game.ts"
      provides: "Pinochet state fields for snapshot and pending hires"
      contains: "_pinochetControlledSnapshot"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "pinochetBonusHire action for human flow"
      contains: "pinochetBonusHire"
    - path: "src/rules/flow.ts"
      provides: "Pinochet snapshot, comparison, hire flow steps"
      contains: "_pinochetControlledSnapshot"
  key_links:
    - from: "src/rules/flow.ts execute (before rebel-phase)"
      to: "game._pinochetControlledSnapshot"
      via: "snapshot dictator-controlled sectors before rebel turns"
      pattern: "_pinochetControlledSnapshot.*new Set"
    - from: "src/rules/flow.ts execute (after rebel-phase)"
      to: "game._pinochetPendingHires"
      via: "compare snapshot to current, increment pending hires"
      pattern: "_pinochetPendingHires"
    - from: "src/rules/flow.ts execute (dictator turn start)"
      to: "pinochetBonusHire action"
      via: "process pending hires at start of dictator turn"
      pattern: "pinochetBonusHire"
---

<objective>
Implement both Pinochet abilities: per-turn damage spread (TURN-06) and sector-loss reactive hire (REACT-03).

Purpose: Pinochet is the only dictator with zero implemented abilities. This plan adds both: a per-turn damage distribution that weakens rebel forces proportional to their territory, and a reactive hire that compensates Pinochet when losing sectors.

Output: Working Pinochet damage spread and sector-loss hire for AI and human players.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-reactive-abilities/61-RESEARCH.md

Key reference files:
@src/rules/dictator-abilities.ts (applyDictatorTurnAbilities switch, existing ability patterns like applyMaoTurnAbility)
@src/rules/game.ts (pendingNoriegaConversion pattern, _polpotTargetSectorId pattern, getControlledSectors)
@src/rules/flow.ts (rebel-phase loop at line ~639, dictator-turn at line ~804, per-turn ability step at line ~976, Pol Pot hire pattern at line ~1092-1154)
@src/rules/actions/dictator-actions.ts (polpotBonusHire action pattern at line ~1174, gadafiBonusHire pattern at line ~1510)
@src/rules/actions/index.ts (action registration)
@src/rules/elements.ts (Sector militia methods, CombatantModel.takeDamage, isDead)
@src/ui/components/DictatorPanel.vue (dictatorSpecificActions array)
@src/ui/composables/useActionState.ts (hiring computed patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pinochet damage spread and game state</name>
  <files>
    src/rules/game.ts
    src/rules/dictator-abilities.ts
  </files>
  <action>
**game.ts -- Add Pinochet state fields to MERCGame:**
- Add `_pinochetControlledSnapshot: Set<string> | null = null` -- sector IDs before rebel turn for before/after comparison
- Add `_pinochetPendingHires: number = 0` -- queued hires from sector losses (counter, not boolean, to handle multiple losses)
- Place these near the existing `_polpotTargetSectorId` and `pendingNoriegaConversion` fields

**dictator-abilities.ts -- Add applyPinochetTurnAbility function:**

Create `applyPinochetTurnAbility(game: MERCGame)` following existing ability patterns. This function handles BOTH damage spread AND processing pending hires from sector losses.

**Part A: Process pending hires (at turn start, before damage):**
- If `game._pinochetPendingHires > 0`, hire that many MERCs using the same pattern as Gaddafi/Pol Pot AI hire:
  - For each pending hire: `game.drawMerc()`, place in non-full squad (primarySquad first, then secondarySquad), auto-equip via `equipNewHire()`, emit map entry, update sarge bonuses
  - Message each hire: `Pinochet lost a sector - hired ${merc.combatantName}`
  - If `drawMerc()` returns null, message "No MERCs available to hire" and stop hiring
  - Reset `game._pinochetPendingHires = 0` after processing

**Part B: Damage spread:**
- Count rebel-controlled sectors: sum `game.getControlledSectors(rebel).length` for all `game.rebelPlayers`
- If 0, message and return early
- Gather all rebel forces as a flat array of targets:
  - For each rebel player: living MERCs (`!merc.isDead` for each in `rebel.team`)
  - For each rebel player: militia in each sector (`sector.getRebelMilitia(String(rebel.seat))` -- each individual militia is a separate target)
- If no targets, message and return early
- Distribute damage: `const perUnit = Math.floor(totalDamage / targets.length)`, `const remainder = totalDamage % targets.length`
- Apply damage to each target: first `remainder` targets get `perUnit + 1`, rest get `perUnit`
- For MERC targets: call `merc.takeDamage(dmg)`. If merc becomes dead (`merc.isDead`), discard equipment using the same 3-slot loop pattern from combat.ts (unequip Weapon/Armor/Accessory, putInto discard pile), then `merc.putInto(game.mercDiscard)`. Do NOT trigger Gaddafi loot -- Pinochet damage is not "forces kill".
- For militia targets: call `sector.removeRebelMilitia(playerId, 1)` for each point of damage
- Message the total damage applied

**Note on target ordering:** MERCs first (iterate `rebel.team` in order), then militia. This determines who gets remainder damage.

**dictator-abilities.ts -- Register in applyDictatorTurnAbilities switch:**
- Add `case 'pinochet': applyPinochetTurnAbility(game); break;` in the switch

**Important:** The damage spread has NO player choices (it's "as evenly as possible"), so it auto-executes for BOTH AI and human. The pending hire processing also auto-executes for AI. For human, pending hires need an actionStep (Task 2).
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `applyPinochetTurnAbility` in dictator-abilities.ts -- function exists
- Grep for `case 'pinochet'` in dictator-abilities.ts -- appears in switch
- Grep for `_pinochetControlledSnapshot` in game.ts -- field exists
- Grep for `_pinochetPendingHires` in game.ts -- field exists
  </verify>
  <done>
- MERCGame has _pinochetControlledSnapshot and _pinochetPendingHires state fields
- applyPinochetTurnAbility handles pending hires (AI) and damage spread (AI + human)
- Damage distributed evenly with remainder going to first N targets
- Dead MERCs from damage spread have equipment discarded and are moved to mercDiscard
- Pinochet registered in the dispatcher switch
  </done>
</task>

<task type="auto">
  <name>Task 2: Pinochet sector snapshot, hire flow, and UI wiring</name>
  <files>
    src/rules/flow.ts
    src/rules/actions/dictator-actions.ts
    src/rules/actions/index.ts
    src/ui/components/DictatorPanel.vue
    src/ui/composables/useActionState.ts
  </files>
  <action>
**flow.ts -- Add Pinochet sector snapshot (BEFORE rebel phase):**
- Add an `execute()` block BEFORE the rebel-phase loop (line ~639), AFTER the Oil Reserves effect (line ~632-636):
```typescript
// Pinochet: Snapshot controlled sectors before rebel turns
execute(() => {
  if (game.dictatorPlayer?.dictator?.combatantId !== 'pinochet') return;
  game._pinochetControlledSnapshot = new Set(
    game.getControlledSectors(game.dictatorPlayer).map(s => s.sectorId)
  );
}),
```

**flow.ts -- Add Pinochet sector comparison (AFTER rebel phase, BEFORE dictator turn):**
- Add an `execute()` block AFTER the rebel-phase loop closes (after line ~795) but BEFORE the dictator-turn eachPlayer (line ~804):
```typescript
// Pinochet: Compare controlled sectors after rebel turns
execute(() => {
  if (!game._pinochetControlledSnapshot) return;
  const currentControlled = new Set(
    game.getControlledSectors(game.dictatorPlayer).map(s => s.sectorId)
  );
  for (const sectorId of game._pinochetControlledSnapshot) {
    if (!currentControlled.has(sectorId)) {
      game._pinochetPendingHires = (game._pinochetPendingHires || 0) + 1;
      game.message('Pinochet lost control of a sector - MERC hire queued');
    }
  }
  game._pinochetControlledSnapshot = null;
}),
```

**flow.ts -- Add Pinochet hire steps in dictator turn:**
- In the dictator turn section, the AI path already calls `applyDictatorTurnAbilities` (line ~981) which processes pending hires for AI. For human Pinochet, the damage spread also auto-runs via applyDictatorTurnAbilities BUT the pending hires need an interactive step.
- HOWEVER: re-examine -- `applyDictatorTurnAbilities` is only called for AI (`if (game.dictatorPlayer?.isAI)`). For human Pinochet, we need BOTH:
  1. The damage spread to auto-execute (no choices) -- add to the execute block at line ~978, alongside the human Mao initialization. Add: `else if (game.dictatorPlayer?.dictator?.combatantId === 'pinochet') { applyPinochetTurnAbility(game); }` -- BUT only the damage spread part.

  Actually, simpler approach: Since Pinochet damage spread has no human choices, call `applyPinochetTurnAbility(game)` for human Pinochet in the same execute block. The function should handle pending hires for AI only (check `game.dictatorPlayer?.isAI` inside the function for hire processing), OR: make the function always process pending hires AND damage. Then add a human actionStep for pinochetBonusHire that only appears if there are pending hires and dictator is NOT AI.

  **Cleaner approach:** Split the execute block logic:
  - In the execute block at line ~978, add an `else if` for Pinochet that runs ONLY the damage spread portion (not hire processing). The hire processing for human happens via actionStep below.
  - For AI: `applyDictatorTurnAbilities` already handles everything (hires + damage).
  - For human: damage auto-runs in execute block, hires go through actionStep.

  **Implementation:** In the existing execute block at line ~978:
  ```typescript
  } else if (game.dictatorPlayer?.dictator?.combatantId === 'pinochet') {
    // Human Pinochet: auto-apply damage spread (no choices)
    // Pending hires are handled by the pinochetBonusHire actionStep below
    applyPinochetDamageSpread(game);  // Extract damage-only portion
  }
  ```

  This means `applyPinochetTurnAbility` in dictator-abilities.ts should be split into two exported functions:
  1. `applyPinochetPendingHires(game)` -- processes queued hires
  2. `applyPinochetDamageSpread(game)` -- distributes damage

  And `applyPinochetTurnAbility` (called by AI dispatcher) calls both. Update Task 1's function accordingly -- export all three, have the main function call both sub-functions.

- Add pinochetBonusHire actionStep AFTER the existing Pol Pot bonus hire step (line ~1147) and before the "Clear outcome" execute:
```typescript
// Pinochet: Human bonus hire from sector losses
loop({
  name: 'pinochet-bonus-hire',
  while: () => !game.isFinished() &&
    game.dictatorPlayer?.dictator?.combatantId === 'pinochet' &&
    game.dictatorPlayer?.isAI !== true &&
    game._pinochetPendingHires > 0,
  maxIterations: 20,
  do: actionStep({
    name: 'pinochet-hire',
    actions: ['pinochetBonusHire'],
    prompt: 'Pinochet lost a sector - hire a bonus MERC',
    skipIf: () => game.isFinished() || game._pinochetPendingHires <= 0,
  }),
}),
```

**dictator-actions.ts -- Create pinochetBonusHire action:**
- Follow the `polpotBonusHire` pattern exactly (it's the closest: reactive hire based on game event)
- Action name: `'pinochetBonusHire'`
- Condition: dictator is Pinochet, not AI, not finished, `game._pinochetPendingHires > 0`
- Execute: Draw MERC, equipment selection, sector selection (same pattern as Gaddafi/Pol Pot hire actions). After placing: decrement `game._pinochetPendingHires` by 1.
- Message: `Pinochet lost a sector - hired ${merc.combatantName}`

**index.ts -- Register pinochetBonusHire:**
- Import `createPinochetBonusHireAction` from dictator-actions
- Add to `registerAllActions`

**DictatorPanel.vue -- Add UI routing:**
- Add `'pinochetBonusHire'` to the `dictatorSpecificActions` array
- Add `isPinochetHiring` computed following existing hiring patterns
- Add to sector selection conditionals alongside other hiring actions

**useActionState.ts -- Add state tracking:**
- Add `isPinochetHiring: ComputedRef<boolean>` to return type
- Add `isPinochetHiring` computed following existing pattern
- Add to return object
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `_pinochetControlledSnapshot` in flow.ts -- appears twice (snapshot + compare)
- Grep for `_pinochetPendingHires` in flow.ts -- appears in compare block and hire loop
- Grep for `pinochetBonusHire` in dictator-actions.ts, index.ts, flow.ts, DictatorPanel.vue -- all 4 files
- Grep for `isPinochetHiring` in DictatorPanel.vue and useActionState.ts -- both files
- Grep for `applyPinochetDamageSpread` in flow.ts -- called in human execute block
  </verify>
  <done>
- Sector snapshot taken before rebel phase, comparison after rebel phase
- Lost sectors increment _pinochetPendingHires counter
- AI Pinochet processes hires + damage in applyDictatorTurnAbilities
- Human Pinochet: damage auto-applies, hires go through interactive pinochetBonusHire loop
- Action registered, wired into flow, routed through DictatorPanel
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Pinochet case in applyDictatorTurnAbilities switch
3. Snapshot/compare execute blocks surround rebel-phase in flow.ts
4. Human Pinochet damage auto-applies, hires use interactive loop
5. pinochetBonusHire action registered in index.ts
6. DictatorPanel routes pinochetBonusHire with isPinochetHiring computed
</verification>

<success_criteria>
- AI Pinochet distributes damage evenly and processes queued hires at turn start
- Human Pinochet sees damage auto-applied and gets interactive hire for each lost sector
- Sector snapshot correctly detects control losses during rebel phase
- Multiple sector losses queue multiple hires
- Dead MERCs from damage spread have equipment properly discarded
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/61-reactive-abilities/61-01-SUMMARY.md`
</output>
