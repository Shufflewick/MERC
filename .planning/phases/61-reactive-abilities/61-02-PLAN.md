---
phase: 61-reactive-abilities
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/game.ts
  - src/rules/combat.ts
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
  - src/ui/composables/useActionState.ts
autonomous: true

must_haves:
  truths:
    - "When dictator forces kill a rebel MERC in combat under Gaddafi, equipment is offered to dictator MERCs in the sector"
    - "Human Gaddafi chooses which dictator MERC gets each piece of looted equipment"
    - "AI Gaddafi auto-equips looted equipment to best-fit dictator MERC"
    - "Equipment is only offered to MERCs with an open slot of the matching type"
    - "If no dictator MERC has an open slot, equipment is discarded normally"
    - "Gaddafi loot triggers in any combat where dictator forces kill rebel MERCs (rebel phase, dictator phase, ability-triggered)"
  artifacts:
    - path: "src/rules/game.ts"
      provides: "Gaddafi loot staging field"
      contains: "_gaddafiLootableEquipment"
    - path: "src/rules/combat.ts"
      provides: "Equipment staging hook at discard points"
      contains: "_gaddafiLootableEquipment"
    - path: "src/rules/dictator-abilities.ts"
      provides: "AI Gaddafi loot processing function"
      contains: "processGaddafiLoot"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "gaddafiLootEquipment action for human flow"
      contains: "gaddafiLootEquipment"
    - path: "src/rules/flow.ts"
      provides: "Post-combat Gaddafi loot steps in combatResolutionFlow"
      contains: "gaddafiLootEquipment"
  key_links:
    - from: "src/rules/combat.ts (3 discard points)"
      to: "game._gaddafiLootableEquipment"
      via: "record equipment ID + type + sectorId at discard time"
      pattern: "_gaddafiLootableEquipment"
    - from: "combatResolutionFlow post-combat"
      to: "processGaddafiLoot or gaddafiLootEquipment action"
      via: "after combat-complete, before clearActiveCombat"
      pattern: "gaddafiLoot"
    - from: "gaddafiLootEquipment action"
      to: "equipment discard pile -> dictator MERC slot"
      via: "pull from discard, equip on chosen MERC"
      pattern: "putInto.*equip"
---

<objective>
Implement Gaddafi's reactive equipment loot ability (REACT-02): when dictator forces kill a rebel MERC in combat, offer the dead MERC's equipment to dictator MERCs in that sector.

Purpose: This is Gaddafi's second ability (per-turn hire already exists from Phase 57). The equipment loot makes combat kills more valuable for Gaddafi, creating a unique strategic incentive.

Output: Working Gaddafi equipment loot for AI and human players, triggered after any combat where dictator forces kill rebel MERCs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-reactive-abilities/61-RESEARCH.md

Key reference files:
@src/rules/combat.ts (equipment discard at lines ~937-947, ~2682-2692, ~2936-2944; activeCombat structure with rebelCasualties, sectorId)
@src/rules/game.ts (getEquipmentDiscard, getDictatorMercsInSector, activeCombat)
@src/rules/dictator-abilities.ts (existing Gaddafi hire function for AI equip pattern)
@src/rules/flow.ts (combatResolutionFlow function at line ~167, auto-clear at ~386, animation-wait at ~396; rebel-phase combat at ~685, dictator combat at ~927, ability combat at ~1090)
@src/rules/actions/dictator-actions.ts (gadafiBonusHire action pattern)
@src/rules/actions/index.ts (action registration)
@src/rules/elements.ts (CombatantModel equipment slots, Equipment class, equip/unequip methods)
@src/ui/components/DictatorPanel.vue (dictatorSpecificActions)
@src/ui/composables/useActionState.ts (computed patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gaddafi loot staging, combat hooks, and AI processing</name>
  <files>
    src/rules/game.ts
    src/rules/combat.ts
    src/rules/dictator-abilities.ts
  </files>
  <action>
**game.ts -- Add Gaddafi loot staging field to MERCGame:**
- Add `_gaddafiLootableEquipment: Array<{ equipmentId: number; sectorId: string }> | null = null`
- Place near other dictator state fields. This staging field collects equipment IDs as they're discarded during combat, so we can reclaim them from discard piles afterward.

**combat.ts -- Add staging hooks at equipment discard points:**

At each of the 3 equipment discard locations (where rebel MERC equipment is discarded on death), add a staging hook AFTER the `equip.putInto(discardPile)` line. The hook records the equipment for later reclaim. All 3 locations follow the same pattern:

Location 1: `applyMilitiaBatchDamage` (~line 937-947, militia kills MERC):
- After the for loop that unequips and discards equipment (lines 940-946), add:
```typescript
// Gaddafi loot: stage discarded equipment for post-combat reclaim
if (game.dictatorPlayer?.dictator?.combatantId === 'gadafi' && game.activeCombat) {
  if (!game._gaddafiLootableEquipment) game._gaddafiLootableEquipment = [];
  for (const slotName of ['Weapon', 'Armor', 'Accessory'] as const) {
    // Equipment was already unequipped above, check the discard pile for recently added
    // Actually, we need to record BEFORE the unequip loop runs, or track what was unequipped
  }
}
```

**Better approach:** Instead of hooking AFTER discard, check BEFORE the unequip loop at each location. Collect the equipment IDs of what the merc has equipped, THEN let the normal discard happen, THEN record those IDs in the staging field.

**Revised hook pattern (use at all 3 locations):**

Before each discard loop, add:
```typescript
// Gaddafi loot: record equipment being discarded from killed rebel MERC
const isGaddafiLoot = game.dictatorPlayer?.dictator?.combatantId === 'gadafi'
  && game.activeCombat
  && target.sourceElement?.isMerc  // already checked at this point
  && !target.sourceElement?.isDictator;  // rebel MERC, not dictator MERC
```

Actually, simplest correct approach: At each discard point, the code already has the equipment reference (`equip`) and is about to call `equip.putInto(discardPile)`. Right AFTER `putInto`, add:
```typescript
if (game.dictatorPlayer?.dictator?.combatantId === 'gadafi' && game.activeCombat) {
  if (!game._gaddafiLootableEquipment) game._gaddafiLootableEquipment = [];
  game._gaddafiLootableEquipment.push({
    equipmentId: equip.id,
    sectorId: game.activeCombat.sectorId
  });
}
```

This must be added at exactly 3 places. Check if the dead combatant is a rebel MERC (not a dictator MERC) before staging -- at each location, verify the context:

**Location 1 (~line 937-947):** In `applyMilitiaBatchDamage`. The `target` here is from `sortedTargets` which are MERCs defending against militia. These are rebel MERCs (militia attacks rebels). The `target.sourceElement?.isMerc` is already checked at line 938. Add staging inside the existing `if (equip)` block, right after `equip.putInto(discardPile)`.

**Location 2 (~line 2682-2692):** Individual attacker kills MERC. The `merc` variable is from `target.sourceElement` where `target` is the one being killed. Need to verify this is a rebel MERC, not dictator MERC. Check: the killer (attacker) is on the dictator side. The context is inside the combat round processing. The `target` could be either side. Add a check: only stage if the dead merc belongs to a rebel player. Check `merc.isDictator === false` or check if `merc` is in any rebel player's team. Simplest: `!merc.isDictator` (since isMerc is already confirmed by the outer check `target.sourceElement?.isMerc`).

**Location 3 (~line 2936-2944):** In `applyCombatResults`. Same pattern: `combatant.sourceElement?.isMerc` is checked. The `merc` is `combatant.sourceElement`. Check `!merc.isDictator` to only stage rebel equipment.

**At each of the 3 locations**, after each `equip.putInto(discardPile)` or `equipment.putInto(discard)` line, add:
```typescript
if (game.dictatorPlayer?.dictator?.combatantId === 'gadafi'
    && game.activeCombat
    && !merc.isDictator) {
  if (!game._gaddafiLootableEquipment) game._gaddafiLootableEquipment = [];
  game._gaddafiLootableEquipment.push({
    equipmentId: equip.id,  // or equipment.id at location 3
    sectorId: game.activeCombat.sectorId
  });
}
```

**dictator-abilities.ts -- Add processGaddafiLoot function:**

```typescript
export function processGaddafiLoot(game: MERCGame): void {
  if (!game._gaddafiLootableEquipment || game._gaddafiLootableEquipment.length === 0) return;

  const lootItems = [...game._gaddafiLootableEquipment];
  game._gaddafiLootableEquipment = null;

  for (const item of lootItems) {
    const sector = game.getSector(item.sectorId);
    if (!sector) continue;

    const dictatorMercs = game.getDictatorMercsInSector(sector);
    if (dictatorMercs.length === 0) continue;

    // Find the equipment in discard piles by ID
    const equipment = findEquipmentInDiscards(game, item.equipmentId);
    if (!equipment) continue;

    const equipType = equipment.equipmentType as 'Weapon' | 'Armor' | 'Accessory';

    // Find dictator MERC with open slot of matching type
    const recipient = dictatorMercs.find(m => {
      if (equipType === 'Weapon') return !m.weaponSlot;
      if (equipType === 'Armor') return !m.armorSlot;
      if (equipType === 'Accessory') return !m.accessorySlot;
      return false;
    });

    if (!recipient) {
      // No open slot - equipment stays in discard
      game.message(`Gaddafi: No MERC in sector can use ${equipment.name} - discarded`);
      continue;
    }

    // Pull from discard and equip
    recipient.equip(equipment);
    game.message(`Gaddafi loots ${equipment.name} onto ${recipient.combatantName}`);
  }
}
```

**Helper function `findEquipmentInDiscards`:** Search all 3 equipment discard piles (Weapon, Armor, Accessory) for an equipment with the matching ID. Use `game.getEquipmentDiscard(type)` to get each pile, then search its elements. Equipment is a game element, so iterate the discard pile's elements/children to find by ID.

Check how Equipment and discard piles work -- look at how `getEquipmentDiscard` returns a container, and how to find an element by ID in it. Likely: `discardPile.all(Equipment).find(e => e.id === targetId)` or similar BoardSmith element query. Look at existing patterns for finding elements by ID.

If pulling from discard needs `moveTo` or `putInto` another location, use the appropriate method. The `equip()` method on CombatantModel should handle moving the equipment from its current container (discard) to the MERC's slot.

**Important:** For AI Gaddafi, call `processGaddafiLoot(game)` after combat completes. For human Gaddafi, stage the loot for an interactive step (Task 2).
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `_gaddafiLootableEquipment` in game.ts -- field exists
- Grep for `_gaddafiLootableEquipment` in combat.ts -- appears at 3 discard locations
- Grep for `processGaddafiLoot` in dictator-abilities.ts -- function exists
- Grep for `findEquipmentInDiscards` in dictator-abilities.ts -- helper exists
  </verify>
  <done>
- Game state has _gaddafiLootableEquipment staging field
- All 3 equipment discard points in combat.ts record equipment for Gaddafi loot (only for rebel MERC deaths)
- processGaddafiLoot AI function finds equipment in discard piles, equips on dictator MERCs with open slots
- Equipment with no valid recipient stays in discard
  </done>
</task>

<task type="auto">
  <name>Task 2: Gaddafi loot flow steps, human action, and UI wiring</name>
  <files>
    src/rules/flow.ts
    src/rules/actions/dictator-actions.ts
    src/rules/actions/index.ts
    src/ui/components/DictatorPanel.vue
    src/ui/composables/useActionState.ts
  </files>
  <action>
**flow.ts -- Add Gaddafi loot processing to combatResolutionFlow:**

The loot needs to trigger after EVERY combat (rebel-phase, dictator-phase, ability-triggered), so it must go inside `combatResolutionFlow()` itself, not at each call site. Add after the auto-clear block (step 9, ~line 386-393) but BEFORE the animation-wait loop (step 10, ~line 396):

Actually, re-examine. The auto-clear at step 9 calls `clearActiveCombat(game)` which resets the combat state. The loot needs to access `activeCombat.sectorId` to know where dictator MERCs are. So it must go BEFORE auto-clear.

But wait -- the staging field `_gaddafiLootableEquipment` already has `sectorId` recorded on each item. So we don't need activeCombat anymore at loot time. The equipment is already staged with sector info.

However, the loot processing should happen AFTER combat is complete but the player should see the results. The right place:

**For AI Gaddafi:** Process loot right after combat completes (after step 9 auto-clear, since we have sectorId in staging). Add BEFORE auto-clear:
```typescript
// Gaddafi: AI auto-loot after combat
execute(() => {
  if (game.dictatorPlayer?.dictator?.combatantId !== 'gadafi') return;
  if (!game._gaddafiLootableEquipment || game._gaddafiLootableEquipment.length === 0) return;
  if (!game.activeCombat?.combatComplete) return;
  if (game.dictatorPlayer?.isAI) {
    processGaddafiLoot(game);
  }
}),
```

**For human Gaddafi:** Add a loop actionStep AFTER the AI loot execute but still BEFORE auto-clear:
```typescript
// Gaddafi: Human equipment loot choices after combat
loop({
  name: `${prefix}-gaddafi-loot`,
  while: () => game.dictatorPlayer?.dictator?.combatantId === 'gadafi' &&
    game.dictatorPlayer?.isAI !== true &&
    game._gaddafiLootableEquipment != null &&
    game._gaddafiLootableEquipment.length > 0 &&
    !game.isFinished(),
  maxIterations: 20,
  do: actionStep({
    name: 'gaddafi-loot-equipment',
    actions: ['gaddafiLootEquipment', 'gaddafiDiscardLoot'],
    prompt: "Gaddafi's Ability: Equip looted equipment on your MERCs",
    skipIf: () => game.isFinished() ||
      !game._gaddafiLootableEquipment ||
      game._gaddafiLootableEquipment.length === 0,
  }),
}),
```

Place both blocks inside `combatResolutionFlow`, between the retreat-decision loop end and the auto-clear execute. This is between line ~384 (end of retreat loop) and line ~386 (auto-clear).

**dictator-actions.ts -- Create Gaddafi loot actions:**

1. `createGaddafiLootEquipmentAction(game)`:
   - Action name: `'gaddafiLootEquipment'`
   - Condition: dictator is Gaddafi, not AI, not finished, `game._gaddafiLootableEquipment` has items
   - Selection step 1: `chooseFrom` showing available loot items (equipment names from staging field). Show what each piece is.
   - Selection step 2: `chooseElement` for dictator MERCs in the sector that have an open slot matching the equipment type
   - Execute: Pull chosen equipment from its discard pile (find by ID), equip on chosen MERC. Remove the item from `_gaddafiLootableEquipment`. Message: `Gaddafi loots ${equipment.name} onto ${merc.combatantName}`

   **Finding equipment to show in chooseFrom:** Iterate `game._gaddafiLootableEquipment`, for each find the equipment in discard piles using `findEquipmentInDiscards(game, item.equipmentId)`. Build choice list with equipment name/type. If equipment is no longer in discard (edge case), skip it and remove from staging.

   **Filter available recipients:** Only show dictator MERCs in the item's sector who have an open slot for that equipment type.

2. `createGaddafiDiscardLootAction(game)`:
   - Action name: `'gaddafiDiscardLoot'`
   - Condition: dictator is Gaddafi, not AI, not finished, `game._gaddafiLootableEquipment` has items
   - Execute (no selections): Clear `game._gaddafiLootableEquipment = null`. This skips remaining loot.
   - Message: "Gaddafi declines remaining loot"

   This gives human Gaddafi a way to skip looting if no good recipients.

**index.ts -- Register both actions:**
- Import `createGaddafiLootEquipmentAction`, `createGaddafiDiscardLootAction`
- Add to `registerAllActions`

**DictatorPanel.vue -- Add UI routing:**
- Add `'gaddafiLootEquipment'`, `'gaddafiDiscardLoot'` to `dictatorSpecificActions` array

**useActionState.ts -- Add state tracking (if needed for sector highlighting):**
- Add `isGaddafiLooting: ComputedRef<boolean>` if any sector/MERC highlighting is needed for the loot step
- Check if the existing action metadata pattern is sufficient -- the chooseElement step may handle MERC highlighting automatically
- If DictatorPanel needs a computed for conditional rendering, add `isGaddafiLooting` following existing patterns
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `gaddafiLootEquipment` in dictator-actions.ts, index.ts, flow.ts, DictatorPanel.vue -- all 4 files
- Grep for `gaddafiDiscardLoot` in dictator-actions.ts, index.ts, flow.ts, DictatorPanel.vue -- all 4 files
- Grep for `processGaddafiLoot` in flow.ts -- called for AI path
- Grep for `gaddafi-loot` in flow.ts -- loop name exists inside combatResolutionFlow
  </verify>
  <done>
- Gaddafi loot steps are inside combatResolutionFlow (triggers for ALL combat types)
- AI Gaddafi auto-loots with processGaddafiLoot after combat completes
- Human Gaddafi gets interactive loop to assign each piece of equipment or discard remaining
- Equipment pulled from discard piles and equipped on dictator MERCs with open slots
- Actions registered and wired through DictatorPanel
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. _gaddafiLootableEquipment staging field exists in game.ts
3. 3 discard points in combat.ts record equipment for Gaddafi (rebel MERC deaths only)
4. combatResolutionFlow includes Gaddafi loot processing (AI auto + human interactive)
5. gaddafiLootEquipment and gaddafiDiscardLoot actions registered in index.ts
6. DictatorPanel routes both loot actions
7. Equipment correctly moves from discard pile to dictator MERC slot
</verification>

<success_criteria>
- AI Gaddafi auto-equips looted equipment on dictator MERCs with open slots after combat
- Human Gaddafi chooses which MERC gets each piece of looted equipment
- Equipment with no valid recipient (no open slots) stays in discard
- Loot triggers in rebel-phase combat, dictator-phase combat, and ability-triggered combat
- Only rebel MERC deaths trigger loot (not dictator MERC deaths)
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/61-reactive-abilities/61-02-SUMMARY.md`
</output>
