---
phase: 61-reactive-abilities
plan: 02
type: execute
wave: 2
depends_on: ['01']
files_modified:
  - src/rules/game.ts
  - src/rules/combat.ts
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
  - src/ui/composables/useActionState.ts
autonomous: true

must_haves:
  truths:
    - "When dictator forces kill a rebel MERC in combat under Gaddafi, equipment is offered to dictator MERCs in the sector"
    - "Human Gaddafi chooses which dictator MERC gets each piece of looted equipment"
    - "AI Gaddafi auto-equips looted equipment to best-fit dictator MERC"
    - "Equipment is only offered to MERCs with an open slot of the matching type"
    - "If no dictator MERC has an open slot, equipment is discarded normally"
    - "Gaddafi loot triggers in any combat where dictator forces kill rebel MERCs (rebel phase, dictator phase, ability-triggered)"
  artifacts:
    - path: "src/rules/game.ts"
      provides: "Gaddafi loot staging field"
      contains: "_gaddafiLootableEquipment"
    - path: "src/rules/combat.ts"
      provides: "Equipment staging hook at discard points"
      contains: "_gaddafiLootableEquipment"
    - path: "src/rules/dictator-abilities.ts"
      provides: "AI Gaddafi loot processing function"
      contains: "processGaddafiLoot"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "gaddafiLootEquipment action for human flow"
      contains: "gaddafiLootEquipment"
    - path: "src/rules/flow.ts"
      provides: "Post-combat Gaddafi loot steps in combatResolutionFlow"
      contains: "gaddafiLootEquipment"
  key_links:
    - from: "src/rules/combat.ts (3 discard points)"
      to: "game._gaddafiLootableEquipment"
      via: "record equipment ID + sectorId at discard time"
      pattern: "_gaddafiLootableEquipment"
    - from: "combatResolutionFlow post-combat"
      to: "processGaddafiLoot or gaddafiLootEquipment action"
      via: "after combat-complete, before clearActiveCombat"
      pattern: "gaddafiLoot"
    - from: "gaddafiLootEquipment action"
      to: "equipment discard pile -> dictator MERC slot"
      via: "find by ID in discard, equip on chosen MERC"
      pattern: "equip.*equipment"
---

<objective>
Implement Gaddafi's reactive equipment loot ability (REACT-02): when dictator forces kill a rebel MERC in combat, offer the dead MERC's equipment to dictator MERCs in that sector.

Purpose: This is Gaddafi's second ability (per-turn hire already exists from Phase 57). The equipment loot makes combat kills more valuable for Gaddafi, creating a unique strategic incentive.

Output: Working Gaddafi equipment loot for AI and human players, triggered after any combat where dictator forces kill rebel MERCs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-reactive-abilities/61-RESEARCH.md
@.planning/phases/61-reactive-abilities/61-01-SUMMARY.md

Key reference files:
@src/rules/combat.ts (equipment discard at lines ~937-947, ~2682-2692, ~2936-2944; activeCombat structure with rebelCasualties, sectorId)
@src/rules/game.ts (getEquipmentDiscard, getDictatorMercsInSector, activeCombat, weaponsDiscard/armorDiscard/accessoriesDiscard)
@src/rules/dictator-abilities.ts (existing Gaddafi hire function for AI equip pattern)
@src/rules/flow.ts (combatResolutionFlow function at line ~167, auto-clear at ~386, animation-wait at ~396; rebel-phase combat at ~685, dictator combat at ~927, ability combat at ~1090)
@src/rules/actions/dictator-actions.ts (gadafiBonusHire action pattern)
@src/rules/actions/index.ts (action registration)
@src/rules/elements.ts (CombatantModel.equip() method, Equipment class, weaponSlot/armorSlot/accessorySlot getters)
@src/ui/components/DictatorPanel.vue (dictatorSpecificActions)
@src/ui/composables/useActionState.ts (computed patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gaddafi loot staging, combat hooks, and AI processing</name>
  <files>
    src/rules/game.ts
    src/rules/combat.ts
    src/rules/dictator-abilities.ts
  </files>
  <action>
**game.ts -- Add Gaddafi loot staging field to MERCGame:**
- Add `_gaddafiLootableEquipment: Array<{ equipmentId: number; sectorId: string }> | null = null`
- Place near other dictator state fields (next to `_pinochetPendingHires` added in Plan 01).

**combat.ts -- Add staging hooks at all 3 equipment discard points:**

At each location where rebel MERC equipment is discarded on death, add a staging hook right AFTER the `equip.putInto(discardPile)` line (or equivalent). The hook records the equipment ID and sector for later reclaim from the discard pile. Same pattern at all 3 locations:

```typescript
if (game.dictatorPlayer?.dictator?.combatantId === 'gadafi'
    && game.activeCombat
    && !merc.isDictator) {
  if (!game._gaddafiLootableEquipment) game._gaddafiLootableEquipment = [];
  game._gaddafiLootableEquipment.push({
    equipmentId: equip.id,
    sectorId: game.activeCombat.sectorId
  });
}
```

**Location 1 (~line 937-947):** In `applyMilitiaBatchDamage`. The targets here are rebel MERCs defending against militia. Add the hook inside the existing `if (equip)` block, right after `equip.putInto(discardPile)`. Use `equip.id` for the equipment ID. The `merc` variable is `target.sourceElement` -- confirm `!merc.isDictator` is true in this context (militia attacks rebels, so it should always be a rebel MERC).

**Location 2 (~line 2682-2692):** Individual attacker kills MERC. The `merc` variable is from `target.sourceElement`. Add check `!merc.isDictator` to only stage rebel equipment. Add the hook after each `equip.putInto(discardPile)` inside the for loop.

**Location 3 (~line 2936-2944):** In `applyCombatResults` fallback. The `merc` is `combatant.sourceElement`. Add check `!merc.isDictator`. Add the hook after each `equipment.putInto(discard)` (note: variable name may be `equipment` not `equip` here -- match the local variable name).

**dictator-abilities.ts -- Add `findEquipmentInDiscards` helper:**

```typescript
function findEquipmentInDiscards(game: MERCGame, equipmentId: number): Equipment | undefined {
  for (const type of ['Weapon', 'Armor', 'Accessory'] as const) {
    const discard = game.getEquipmentDiscard(type);
    if (!discard) continue;
    const found = discard.first(Equipment, e => e.id === equipmentId);
    if (found) return found;
  }
  return undefined;
}
```

This uses the BoardSmith `first(Class, filter)` query pattern (same as `zone.first(Equipment, e => e.id === equipment.id)` in elements.ts line 1371). Search all 3 discard piles (`game.getEquipmentDiscard('Weapon')`, `game.getEquipmentDiscard('Armor')`, `game.getEquipmentDiscard('Accessory')`) for the equipment by ID.

**dictator-abilities.ts -- Add `processGaddafiLoot` function:**

```typescript
export function processGaddafiLoot(game: MERCGame): void {
  if (!game._gaddafiLootableEquipment || game._gaddafiLootableEquipment.length === 0) return;

  const lootItems = [...game._gaddafiLootableEquipment];
  game._gaddafiLootableEquipment = null;

  for (const item of lootItems) {
    const sector = game.getSector(item.sectorId);
    if (!sector) continue;

    const dictatorMercs = game.getDictatorMercsInSector(sector);
    if (dictatorMercs.length === 0) continue;

    const equipment = findEquipmentInDiscards(game, item.equipmentId);
    if (!equipment) continue;

    const equipType = equipment.equipmentType as 'Weapon' | 'Armor' | 'Accessory';

    // Find dictator MERC with open slot of matching type
    const recipient = dictatorMercs.find(m => {
      if (equipType === 'Weapon') return !m.weaponSlot;
      if (equipType === 'Armor') return !m.armorSlot;
      if (equipType === 'Accessory') return !m.accessorySlot;
      return false;
    });

    if (!recipient) {
      game.message(`Gaddafi: No MERC in sector can use ${equipment.name} - discarded`);
      continue;
    }

    // equip() handles moving equipment from its current container (discard pile) to the MERC's slot
    recipient.equip(equipment);
    game.message(`Gaddafi loots ${equipment.name} onto ${recipient.combatantName}`);
  }
}
```

The `equip()` method on CombatantModel (elements.ts line 919) handles the full equip flow: it calls `equipToSlot` which internally moves the equipment element to become a child of the MERC via BoardSmith's element tree. No separate `putInto` call is needed -- `equip()` does it all.
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `_gaddafiLootableEquipment` in game.ts -- field exists
- Grep for `_gaddafiLootableEquipment` in combat.ts -- appears at 3 discard locations
- Grep for `processGaddafiLoot` in dictator-abilities.ts -- function exists
- Grep for `findEquipmentInDiscards` in dictator-abilities.ts -- helper exists
  </verify>
  <done>
- Game state has _gaddafiLootableEquipment staging field
- All 3 equipment discard points in combat.ts record equipment for Gaddafi loot (only for rebel MERC deaths, guarded by !merc.isDictator)
- findEquipmentInDiscards searches all 3 discard piles using `discardPile.first(Equipment, e => e.id === targetId)`
- processGaddafiLoot AI function finds equipment in discard piles, equips on dictator MERCs with open slots via `recipient.equip(equipment)`
- Equipment with no valid recipient stays in discard
  </done>
</task>

<task type="auto">
  <name>Task 2: Gaddafi loot flow steps, human action, and UI wiring</name>
  <files>
    src/rules/flow.ts
    src/rules/actions/dictator-actions.ts
    src/rules/actions/index.ts
    src/ui/components/DictatorPanel.vue
    src/ui/composables/useActionState.ts
  </files>
  <action>
**flow.ts -- Add Gaddafi loot processing to combatResolutionFlow:**

The loot must trigger after EVERY combat (rebel-phase, dictator-phase, ability-triggered), so it goes inside `combatResolutionFlow()` itself. Place both blocks between the end of the retreat-decision loop (~line 384) and the auto-clear execute (~line 386), BEFORE `clearActiveCombat` is called (the staging field has sectorId recorded on each item so we do not need activeCombat for that, but we do need `activeCombat.combatComplete` as a guard).

**AI auto-loot execute block:**
```typescript
// Gaddafi: AI auto-loot after combat
execute(() => {
  if (game.dictatorPlayer?.dictator?.combatantId !== 'gadafi') return;
  if (!game._gaddafiLootableEquipment || game._gaddafiLootableEquipment.length === 0) return;
  if (!game.activeCombat?.combatComplete) return;
  if (game.dictatorPlayer?.isAI) {
    processGaddafiLoot(game);
  }
}),
```

**Human interactive loot loop (immediately after AI block):**
```typescript
// Gaddafi: Human equipment loot choices after combat
loop({
  name: `${prefix}-gaddafi-loot`,
  while: () => game.dictatorPlayer?.dictator?.combatantId === 'gadafi' &&
    game.dictatorPlayer?.isAI !== true &&
    game._gaddafiLootableEquipment != null &&
    game._gaddafiLootableEquipment.length > 0 &&
    !game.isFinished(),
  maxIterations: 20,
  do: actionStep({
    name: 'gaddafi-loot-equipment',
    actions: ['gaddafiLootEquipment', 'gaddafiDiscardLoot'],
    prompt: "Gaddafi's Ability: Equip looted equipment on your MERCs",
    skipIf: () => game.isFinished() ||
      !game._gaddafiLootableEquipment ||
      game._gaddafiLootableEquipment.length === 0,
  }),
}),
```

Import `processGaddafiLoot` from dictator-abilities.ts at the top of flow.ts.

**dictator-actions.ts -- Create two Gaddafi loot actions:**

1. `createGaddafiLootEquipmentAction(game)`:
   - Action name: `'gaddafiLootEquipment'`
   - Condition: dictator is Gaddafi, not AI, not finished, `game._gaddafiLootableEquipment` has items
   - Selection step 1: `chooseFrom` showing available loot items. For each item in `game._gaddafiLootableEquipment`, find the equipment using `findEquipmentInDiscards(game, item.equipmentId)` (import from dictator-abilities.ts). Build choice list with equipment name/type. Skip items where equipment is no longer in discard (remove from staging).
   - Selection step 2: `chooseElement` for dictator MERCs in the item's sector (`game.getDictatorMercsInSector(sector)`) that have an open slot matching the equipment type. Filter: if Weapon, `!m.weaponSlot`; if Armor, `!m.armorSlot`; if Accessory, `!m.accessorySlot`.
   - Execute: Call `recipient.equip(equipment)` to move from discard to MERC slot. Remove the item from `_gaddafiLootableEquipment`. Message: `Gaddafi loots ${equipment.name} onto ${merc.combatantName}`

2. `createGaddafiDiscardLootAction(game)`:
   - Action name: `'gaddafiDiscardLoot'`
   - Condition: dictator is Gaddafi, not AI, not finished, `game._gaddafiLootableEquipment` has items
   - Execute (no selections): Set `game._gaddafiLootableEquipment = null`. This skips all remaining loot.
   - Message: "Gaddafi declines remaining loot"

**index.ts -- Register both actions:**
- Import `createGaddafiLootEquipmentAction`, `createGaddafiDiscardLootAction` from dictator-actions
- Add to `registerAllActions`

**DictatorPanel.vue -- Add UI routing:**
- Add `'gaddafiLootEquipment'`, `'gaddafiDiscardLoot'` to `dictatorSpecificActions` array

**useActionState.ts -- Add state tracking (if needed for sector highlighting):**
- Add `isGaddafiLooting: ComputedRef<boolean>` if any sector/MERC highlighting is needed for the loot step
- Check if the existing action metadata pattern is sufficient -- the chooseElement step may handle MERC highlighting automatically
- If DictatorPanel needs a computed for conditional rendering, add `isGaddafiLooting` following existing patterns
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `gaddafiLootEquipment` in dictator-actions.ts, index.ts, flow.ts, DictatorPanel.vue -- all 4 files
- Grep for `gaddafiDiscardLoot` in dictator-actions.ts, index.ts, flow.ts, DictatorPanel.vue -- all 4 files
- Grep for `processGaddafiLoot` in flow.ts -- called for AI path
- Grep for `gaddafi-loot` in flow.ts -- loop name exists inside combatResolutionFlow
  </verify>
  <done>
- Gaddafi loot steps are inside combatResolutionFlow (triggers for ALL combat types)
- AI Gaddafi auto-loots with processGaddafiLoot after combat completes
- Human Gaddafi gets interactive loop to assign each piece of equipment or discard remaining
- Equipment found in discard via findEquipmentInDiscards, equipped via recipient.equip(equipment)
- Actions registered and wired through DictatorPanel
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. _gaddafiLootableEquipment staging field exists in game.ts
3. 3 discard points in combat.ts record equipment for Gaddafi (rebel MERC deaths only)
4. combatResolutionFlow includes Gaddafi loot processing (AI auto + human interactive)
5. gaddafiLootEquipment and gaddafiDiscardLoot actions registered in index.ts
6. DictatorPanel routes both loot actions
7. Equipment correctly moves from discard pile to dictator MERC slot via equip()
</verification>

<success_criteria>
- AI Gaddafi auto-equips looted equipment on dictator MERCs with open slots after combat
- Human Gaddafi chooses which MERC gets each piece of looted equipment
- Equipment with no valid recipient (no open slots) stays in discard
- Loot triggers in rebel-phase combat, dictator-phase combat, and ability-triggered combat
- Only rebel MERC deaths trigger loot (not dictator MERC deaths)
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/61-reactive-abilities/61-02-SUMMARY.md`
</output>
