---
phase: 49-sector-panel-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/components/SectorPanel.vue
  - src/ui/composables/useSectorState.ts
autonomous: true

must_haves:
  truths:
    - "When hospital/armsDealer/reEquip has a single eligible unit and is started from SectorPanel, the unit is auto-selected correctly (chooseFrom string format, not element ID)"
    - "When coordinatedAttack is clicked from an adjacent sector panel, the target sector is pre-filled automatically"
    - "No debug console.log or console.warn statements exist in SectorPanel.vue or useSectorState.ts for mortar visibility or image path debugging"
  artifacts:
    - path: "src/ui/components/SectorPanel.vue"
      provides: "Fixed auto-fill logic, coordinatedAttack pre-fill, debug removal"
    - path: "src/ui/composables/useSectorState.ts"
      provides: "Debug logging removed"
  key_links:
    - from: "SectorPanel.handleAction() auto-fill"
      to: "actionController.fill()"
      via: "sel.type check determines value format"
      pattern: "sel\\.type === 'choice'"
    - from: "SectorPanel.handleAction() coordinatedAttack"
      to: "actionController.fill('target', sector.id)"
      via: "explicit pre-fill like move"
      pattern: "coordinatedAttack"
---

<objective>
Fix the auto-fill format mismatch in SectorPanel's handleAction(), add coordinatedAttack sector pre-fill, and remove debug logging.

Purpose: Three of the 13 SectorPanel actions (hospital, armsDealer, reEquip) use `chooseFrom('actingUnit', ...)` which expects a "id:name:isDictator" string value, but the auto-fill logic only builds that string for `sel.name === 'unit'`. All other names fall into the `else` branch which sends a bare element ID. This means single-unit auto-selection is broken for those actions. Additionally, coordinatedAttack doesn't pre-fill the target sector even though the user clicked on it.

Output: Fixed SectorPanel.vue and useSectorState.ts with correct auto-fill, pre-fill, and no debug logs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-sector-panel-audit/49-RESEARCH.md
@src/ui/components/SectorPanel.vue
@src/ui/composables/useSectorState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix auto-fill format and add coordinatedAttack pre-fill</name>
  <files>src/ui/components/SectorPanel.vue</files>
  <action>
In `handleAction()` (around line 1134), make these changes:

**A. Add coordinatedAttack explicit handling** (after the `mortar` block at line 1185, before the generic start at line 1187):

Add a block similar to `move` that:
1. Sets `activeActionFromPanel.value = actionName`
2. Calls `await props.actionController.start(actionName)`
3. Fills the `target` selection with `props.sector.id` (the sector element ID)
4. Emits `close` since the target is pre-filled
5. Returns early

Also add `'coordinatedAttack'` to the `sectorRelevantActions` array in `isInActionFlow` computed (around line 592).

**B. Fix auto-fill type detection** (lines 1191-1212):

The current logic checks `sel.name === 'unit'` to decide whether to build the "id:name:isDictator" string. This is wrong because `hospital`, `armsDealer`, and `reEquip` all use `chooseFrom('actingUnit', ...)` which also needs the string format.

Change the detection from name-based to type-based:

```typescript
// For in-sector actions, auto-fill the unit if there's only one in this sector
const sel = props.actionController.currentPick.value;
if (sel && (sel.name === 'actingUnit' || sel.name === 'actingMerc' || sel.name === 'unit')) {
  const mercsInSector = allAvailableMercs.value;
  if (mercsInSector.length === 1) {
    const merc = mercsInSector[0];
    if (sel.type === 'choice') {
      // chooseFrom selections expect "id:name:isDictator" string format
      const id = merc.ref || merc.id;
      const name = getAttr(merc, 'combatantName', '') || getAttr(merc, 'combatantId', '');
      const isDictator = merc.isDictator || getAttr(merc, 'isDictator', false);
      const value = `${id}:${name}:${isDictator}`;
      await props.actionController.fill(sel.name, value);
    } else {
      // chooseElement / fromElements selections expect element ID
      const unitId = merc.ref || merc.id;
      if (unitId) {
        await props.actionController.fill(sel.name, unitId);
      }
    }
  }
}
```

The key change: `sel.name === 'unit'` becomes `sel.type === 'choice'`. This correctly handles:
- `train` -> chooseFrom('unit') -> sel.type === 'choice' -> string format (was working, still works)
- `hospital` -> chooseFrom('actingUnit') -> sel.type === 'choice' -> string format (was broken, now fixed)
- `armsDealer` -> chooseFrom('actingUnit') -> sel.type === 'choice' -> string format (was broken, now fixed)
- `reEquip` -> chooseFrom('actingUnit') -> sel.type === 'choice' -> string format (was broken, now fixed)
- `explore` -> chooseElement('actingUnit') -> sel.type === 'element' -> element ID (was working, still works)
- `dropEquipment` -> fromElements('actingMerc') -> sel.type === 'elements' -> element ID (was working, still works)

**C. Remove debug logging** (two locations in SectorPanel.vue):

1. Remove the mortar debug block at lines 554-563 (the `console.log('[SectorPanel] Mortar check:', ...)` and surrounding variables). Keep the actual mortar button logic at line 565.

2. Remove the `console.warn('[SectorPanel] getMercImagePath: No image for merc:', merc)` at line 276.

Update the comment on the `sel.name === 'unit'` line (line 1198 comment says "Train uses string format") to say something like "chooseFrom selections use string format 'id:name:isDictator'".
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Grep SectorPanel.vue for `console.log` and `console.warn` to confirm all debug logging is removed. Grep for `sel.name === 'unit'` to confirm the old name-based check is replaced with `sel.type === 'choice'`.
  </verify>
  <done>
The auto-fill at handleAction() uses `sel.type === 'choice'` to detect chooseFrom selections and builds the "id:name:isDictator" string for all of them (train, hospital, armsDealer, reEquip). coordinatedAttack pre-fills the target sector. No console.log or console.warn debug statements remain in SectorPanel.vue.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove debug logging from useSectorState.ts</name>
  <files>src/ui/composables/useSectorState.ts</files>
  <action>
Remove the debug logging block in useSectorState.ts around lines 415-423:

```typescript
// DEBUG: mortar detection
if (!result && allMercsInSquads.length > 0) {
  console.warn('[hasMortar] No mortar found. Mercs checked:', allMercsInSquads.map((m: any) => ({
    id: getAttrPure(m, 'combatantId', '?'),
    accessorySlotData: getAttrPure(m, 'accessorySlotData', null),
    accessorySlot: getAttrPure(m, 'accessorySlot', null),
    bandolierSlotsData: getAttrPure(m, 'bandolierSlotsData', []),
  })));
}
```

Remove this entire block (the comment, the `if`, and its body). The `return result;` line below it stays.
  </action>
  <verify>
Grep useSectorState.ts for `console.log` and `console.warn` to confirm no debug logging remains. Run `npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
No console.log or console.warn debug statements remain in useSectorState.ts.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. No `console.log` or `console.warn` calls remain in SectorPanel.vue or useSectorState.ts
3. The auto-fill branch condition uses `sel.type === 'choice'` (not `sel.name === 'unit'`)
4. `coordinatedAttack` has explicit handling in handleAction() that fills the `target` selection
5. `coordinatedAttack` is listed in `sectorRelevantActions` array
</verification>

<success_criteria>
- chooseFrom selections (train, hospital, armsDealer, reEquip) auto-fill with "id:name:isDictator" string format when a single unit is in the sector
- chooseElement selections (explore) auto-fill with element ID when a single unit is in the sector
- coordinatedAttack pre-fills the clicked sector as the target, matching the pattern used by move
- All debug console.log/console.warn removed from SectorPanel.vue and useSectorState.ts
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/49-sector-panel-audit/49-01-SUMMARY.md`
</output>
