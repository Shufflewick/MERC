---
phase: 60-complex-interactive-abilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/game.ts
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/combat.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
  - src/ui/composables/useActionState.ts
autonomous: true

must_haves:
  truths:
    - "Hitler hires 1 random MERC per turn during the dictator ability step"
    - "Hitler can pick a rebel to have auto-initiative over (persistent until switched)"
    - "Hitler can switch initiative target once per turn"
    - "Dictator forces always go before targeted rebel forces in combat initiative order"
    - "Initiative target is visible to all players"
    - "Hitler works for both AI and human dictator players"
  artifacts:
    - path: "src/rules/game.ts"
      provides: "hitlerInitiativeTargetSeat and hitlerInitiativeSwitchedThisTurn state"
      contains: "hitlerInitiativeTargetSeat"
    - path: "src/rules/dictator-abilities.ts"
      provides: "applyHitlerTurnAbility AI function"
      contains: "applyHitlerTurnAbility"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "hitlerBonusHire and hitlerPickInitiativeTarget actions"
      contains: "hitlerBonusHire"
    - path: "src/rules/combat.ts"
      provides: "Hitler initiative override in sortByInitiative"
      contains: "hitlerInitiativeTargetSeat"
    - path: "src/rules/flow.ts"
      provides: "Hitler flow steps for hire and target pick"
      contains: "hitlerBonusHire"
  key_links:
    - from: "src/rules/flow.ts"
      to: "src/rules/actions/dictator-actions.ts"
      via: "action name in actionStep"
      pattern: "hitlerBonusHire.*hitlerPickInitiativeTarget"
    - from: "src/rules/combat.ts"
      to: "src/rules/game.ts"
      via: "game.hitlerInitiativeTargetSeat in sortByInitiative"
      pattern: "hitlerInitiativeTargetSeat"
    - from: "src/rules/game.ts advanceDay"
      to: "hitlerInitiativeSwitchedThisTurn reset"
      via: "reset per-turn flag"
      pattern: "hitlerInitiativeSwitchedThisTurn.*false"
---

<objective>
Implement Hitler's complete per-turn ability: hire 1 random MERC and pick a rebel for auto-initiative override.

Purpose: This is half of Phase 60 (TURN-02). Hitler's ability is unique because it introduces persistent cross-turn state (initiative target) and requires a hook into the combat initiative sorting function -- the only ability that modifies combat resolution mechanics.

Output: Working Hitler ability for AI and human players, with initiative override affecting combat resolution.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-complex-interactive-abilities/60-RESEARCH.md
@.planning/phases/57-simple-hire-abilities/57-01-SUMMARY.md
@.planning/phases/57-simple-hire-abilities/57-02-SUMMARY.md

Key reference files:
@src/rules/dictator-abilities.ts (Gaddafi hire pattern at lines 741-780, switch at ~925-937)
@src/rules/actions/dictator-actions.ts (Gaddafi action pattern at lines 1297-1449)
@src/rules/actions/index.ts (action registration)
@src/rules/flow.ts (dictator-ability actionStep at line 999-1003, Mussolini spread loop pattern at 1018-1029)
@src/rules/game.ts (MERCGame class, pendingMussoliniSpread pattern at ~653, advanceDay at ~1879)
@src/rules/combat.ts (sortByInitiative at lines 670-700, call sites at lines 138, 1762, 1773, 3100)
@src/ui/components/DictatorPanel.vue (dictatorSpecificActions at line 136, hiring computeds at 147-152)
@src/ui/composables/useActionState.ts (isGadafiHiring pattern at lines 333-338, return at 704-705)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hitler AI ability, game state, and initiative override</name>
  <files>
    src/rules/game.ts
    src/rules/dictator-abilities.ts
    src/rules/combat.ts
  </files>
  <action>
**game.ts -- Add Hitler persistent state to MERCGame:**
- Add `hitlerInitiativeTargetSeat: number | null = null` property (persistent, serialized to clients so all players see the target)
- Add `hitlerInitiativeSwitchedThisTurn: boolean = false` property (per-turn tracking)
- In `advanceDay()` method (~line 1879): add `this.hitlerInitiativeSwitchedThisTurn = false;` to reset the switch flag each day. Place it alongside other per-day resets.

**dictator-abilities.ts -- Add applyHitlerTurnAbility:**
- Follow the exact `applyGadafiTurnAbility` pattern for the hire step: draw 1 MERC, place in first non-full squad (primary preferred, then secondary), auto-equip (Weapon if no weapon, Armor if no armor, else Accessory), select sector via `selectNewMercLocation`, update sarge bonuses, emit map combatant entry animation, game.message the hire. If both squads full, discard to mercDiscard.
- After the hire step, add initiative target selection: get `game.rebelPlayers`, pick the rebel with the most controlled sectors (`game.getControlledSectors(rebel).length`), tiebreak by first in array. Set `game.hitlerInitiativeTargetSeat = target.seat` and `game.hitlerInitiativeSwitchedThisTurn = true`. Message: `Hitler targets ${target.name || 'Rebel ' + target.seat} for auto-initiative`.
- Add `case 'hitler':` to the `applyDictatorTurnAbilities` switch (the one that calls individual ability functions, around line 925-937), calling `applyHitlerTurnAbility(game)`.
- Also add `case 'hitler':` returning `true` to the "has ability" switch (around line 890-902) that checks if a dictator has a turn ability.

**combat.ts -- Add Hitler initiative override to sortByInitiative:**
- Modify `sortByInitiative` signature to accept optional `game?: MERCGame` parameter: `function sortByInitiative(combatants: Combatant[], game?: MERCGame): Combatant[]`
- Inside the sort comparator, AFTER the alwaysGoesFirst and alwaysBeforeMilitia checks but BEFORE the numeric initiative comparison (`if (b.initiative !== a.initiative)`), add the Hitler override block:
  - Guard: `if (game?.hitlerInitiativeTargetSeat != null)`
  - Determine if a combatant belongs to the targeted rebel:
    - For militia: `!combatant.isDictatorSide && combatant.ownerId === String(game.hitlerInitiativeTargetSeat)`
    - For MERCs: `!combatant.isDictatorSide && combatant.sourceElement` then check if `game.rebelPlayers.find(p => p.seat === game.hitlerInitiativeTargetSeat)?.team.some(m => m.id === combatant.sourceElement!.id)`
  - If `a.isDictatorSide && bIsTargetedRebel` return -1 (dictator goes first)
  - If `b.isDictatorSide && aIsTargetedRebel` return 1 (dictator goes first)
- Update ALL call sites of `sortByInitiative` to pass `game` parameter. There are 4 call sites:
  - Line ~138: inside `executeCombat` or nearby -- the `game` variable should already be in scope
  - Line ~1762: pass the game reference
  - Line ~1773: pass the game reference
  - Line ~3100: pass the game reference
  - Inspect each call site to find the available game variable name (likely `game` in all cases)
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `hitlerInitiativeTargetSeat` in game.ts, dictator-abilities.ts, combat.ts -- all 3 files contain it
- Grep for `case 'hitler'` in dictator-abilities.ts -- appears in both switch blocks
- Grep for `sortByInitiative(` to confirm all call sites pass game parameter
  </verify>
  <done>
- MERCGame has hitlerInitiativeTargetSeat (persistent) and hitlerInitiativeSwitchedThisTurn (per-turn, reset in advanceDay)
- applyHitlerTurnAbility hires 1 MERC and picks initiative target (AI auto-path)
- sortByInitiative gives dictator forces priority over targeted rebel forces
- All sortByInitiative call sites updated with game parameter
  </done>
</task>

<task type="auto">
  <name>Task 2: Hitler human actions, flow steps, and UI wiring</name>
  <files>
    src/rules/actions/dictator-actions.ts
    src/rules/actions/index.ts
    src/rules/flow.ts
    src/ui/components/DictatorPanel.vue
    src/ui/composables/useActionState.ts
  </files>
  <action>
**dictator-actions.ts -- Create two human actions:**

1. `createHitlerBonusHireAction(game)` -- Follow the exact `createGadafiBonusHireAction` pattern:
   - Action name: `'hitlerBonusHire'`
   - Condition: dictator is Hitler, not AI, not finished, at least one squad has room
   - Selection steps: same as Gaddafi (equipment type choice via chooseFrom, sector choice via chooseElement for sectors with dictator presence)
   - Execute: draw MERC, equip chosen type, place in chosen sector's squad, update sarge bonuses, emit map entry animation, message
   - Use the same `getGlobalCachedValue`/`setGlobalCachedValue` pattern for caching the drawn MERC across selection steps

2. `createHitlerPickInitiativeTargetAction(game)` -- New action pattern:
   - Action name: `'hitlerPickInitiativeTarget'`
   - Condition: dictator is Hitler, not AI, not finished. Do NOT check `hitlerInitiativeSwitchedThisTurn` -- the player MUST pick a target every turn (they just can't switch mid-turn after picking). If `hitlerInitiativeTargetSeat` is already set from a prior turn, this step still runs to allow switching.
   - Selection: `chooseFrom` with rebel player options. Each option shows the rebel name/seat. If there's a current target, mark it (e.g., "(current)" suffix).
   - Execute: set `game.hitlerInitiativeTargetSeat = selectedRebel.seat`, set `game.hitlerInitiativeSwitchedThisTurn = true`, message the selection.
   - Important: If only 1 rebel player, auto-select them (skip the choice UI, just set the target directly in execute without selection steps).

**index.ts -- Register both actions:**
- Import `createHitlerBonusHireAction` and `createHitlerPickInitiativeTargetAction`
- Add both to `registerAllActions` function following the existing pattern (find where Gaddafi/Stalin are registered)

**flow.ts -- Add Hitler flow steps:**
- In the `dictator-ability` actionStep (line ~1001), add `'hitlerBonusHire'` to the actions array
- Add a NEW actionStep immediately after the `dictator-ability` step (before the mao-militia-distribution loop):
  ```
  actionStep({
    name: 'hitler-pick-target',
    actions: ['hitlerPickInitiativeTarget'],
    prompt: "Hitler's Ability: Choose a rebel for auto-initiative",
    skipIf: () => game.isFinished() ||
      game.dictatorPlayer?.dictator?.combatantId !== 'hitler' ||
      game.dictatorPlayer?.isAI === true,
  }),
  ```

**DictatorPanel.vue -- Add UI routing:**
- Add `'hitlerBonusHire'` and `'hitlerPickInitiativeTarget'` to the `dictatorSpecificActions` array (line ~136)
- Add `isHitlerHiring` computed following the `isGadafiHiring` pattern (check if current action metadata matches hitler hire)
- If sector selection is conditional on hiring actions (check the existing `isGadafiHiring` or `isStalinHiring` usage), add `isHitlerHiring` to the same conditional

**useActionState.ts -- Add state tracking:**
- Add `isHitlerHiring: ComputedRef<boolean>` to the return type interface
- Add `isHitlerHiring` computed following the `isGadafiHiring` pattern
- Add to the return object
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `hitlerBonusHire` in dictator-actions.ts, index.ts, flow.ts, DictatorPanel.vue -- all 4 files contain it
- Grep for `hitlerPickInitiativeTarget` in dictator-actions.ts, index.ts, flow.ts -- all 3 files contain it
- Grep for `isHitlerHiring` in DictatorPanel.vue and useActionState.ts -- both files contain it
  </verify>
  <done>
- Human Hitler player can hire a MERC with equipment/sector choice
- Human Hitler player can pick an initiative target rebel each turn
- Both actions registered, wired into flow, and routed through DictatorPanel
- useActionState exposes isHitlerHiring for UI conditionals
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All new action names appear in flow.ts, index.ts, dictator-actions.ts, and DictatorPanel.vue
3. `hitlerInitiativeTargetSeat` is referenced in game.ts, dictator-abilities.ts, combat.ts
4. `sortByInitiative` accepts optional game parameter at all 4 call sites
5. `advanceDay()` resets `hitlerInitiativeSwitchedThisTurn`
</verification>

<success_criteria>
- AI Hitler hires 1 MERC per turn and auto-selects initiative target
- Human Hitler gets hire action with equipment/sector choices, then initiative target pick
- Initiative override makes dictator forces go before targeted rebel forces in combat
- Target persists across turns, switchable once per turn
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/60-complex-interactive-abilities/60-01-SUMMARY.md`
</output>
