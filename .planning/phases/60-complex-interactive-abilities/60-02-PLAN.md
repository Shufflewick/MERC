---
phase: 60-complex-interactive-abilities
plan: 02
type: execute
wave: 2
depends_on: ["60-01"]
files_modified:
  - src/rules/game.ts
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
  - src/ui/composables/useActionState.ts
autonomous: true

must_haves:
  truths:
    - "Noriega converts 1 militia from each rebel-controlled sector to dictator militia each turn"
    - "All converted militia are moved to one chosen non-rebel sector"
    - "Noriega hires 1 random MERC if dictator controls fewer sectors than rebels (counted AFTER conversion)"
    - "Human player chooses the destination sector for converted militia"
    - "Combat is triggered if converted militia land in a sector with rebel forces"
    - "Noriega works for both AI and human dictator players"
  artifacts:
    - path: "src/rules/game.ts"
      provides: "pendingNoriegaConversion state for human multi-step flow"
      contains: "pendingNoriegaConversion"
    - path: "src/rules/dictator-abilities.ts"
      provides: "applyNoriegaTurnAbility AI function"
      contains: "applyNoriegaTurnAbility"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "noriegaConvertMilitia and noriegaBonusHire actions"
      contains: "noriegaConvertMilitia"
    - path: "src/rules/flow.ts"
      provides: "Noriega flow steps for conversion, sector choice, and conditional hire"
      contains: "noriegaConvertMilitia"
  key_links:
    - from: "src/rules/flow.ts"
      to: "src/rules/actions/dictator-actions.ts"
      via: "action names in actionStep arrays"
      pattern: "noriegaConvertMilitia"
    - from: "src/rules/flow.ts execute block"
      to: "src/rules/dictator-abilities.ts"
      via: "AI path calls applyNoriegaTurnAbility"
      pattern: "applyNoriegaTurnAbility"
    - from: "noriegaConvertMilitia action"
      to: "sector.removeRebelMilitia + sector.addDictatorMilitia"
      via: "militia manipulation methods"
      pattern: "removeRebelMilitia.*addDictatorMilitia"
---

<objective>
Implement Noriega's complete per-turn ability: convert 1 rebel militia from each rebel sector, move all converted to a chosen non-rebel sector, and conditionally hire a MERC if losing the sector count.

Purpose: This is the second half of Phase 60 (TURN-05). Noriega's ability follows the Mussolini multi-step pattern -- initial conversion happens automatically, then human chooses destination sector, then conditional hire triggers based on post-conversion sector comparison.

Output: Working Noriega ability for AI and human players with multi-step interactive flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-complex-interactive-abilities/60-RESEARCH.md
@.planning/phases/60-complex-interactive-abilities/60-01-SUMMARY.md
@.planning/phases/59-militia-placement-abilities/59-02-SUMMARY.md

Key reference files:
@src/rules/dictator-abilities.ts (Gaddafi hire pattern, Mussolini pattern, switch blocks)
@src/rules/actions/dictator-actions.ts (Gaddafi hire action, Mussolini spread action pattern)
@src/rules/actions/index.ts (action registration)
@src/rules/flow.ts (dictator-ability actionStep, Mussolini spread loop, combat resolution sub-flow, Pol Pot conditional hire pattern)
@src/rules/game.ts (pendingMussoliniSpread pattern, getControlledSectors, advanceDay)
@src/rules/elements.ts (Sector: removeRebelMilitia, addDictatorMilitia, rebelMilitia record)
@src/ui/components/DictatorPanel.vue (dictatorSpecificActions, sector selection patterns)
@src/ui/composables/useActionState.ts (hiring computed patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Noriega AI ability and game state</name>
  <files>
    src/rules/game.ts
    src/rules/dictator-abilities.ts
  </files>
  <action>
**game.ts -- Add Noriega pending state to MERCGame:**
- Add `pendingNoriegaConversion: { convertedCount: number } | null = null` property following the `pendingMussoliniSpread` pattern. This tracks converted militia count for the human flow path.

**dictator-abilities.ts -- Add applyNoriegaTurnAbility:**

Step 1 - Convert militia:
- For each rebel player (`game.rebelPlayers`), get their controlled sectors via `game.getControlledSectors(rebel)`
- For each controlled sector, call `sector.removeRebelMilitia(String(rebel.seat), 1)` -- this returns the actual number removed (0 or 1)
- Track `totalConverted` as the sum of all removals
- Message each conversion: `Noriega converts 1 militia in ${sector.sectorName}`

Step 2 - Place converted militia:
- If `totalConverted > 0`, find all non-rebel-controlled sectors (sectors not in any rebel's `getControlledSectors` result)
- AI selects destination: prefer sectors adjacent to rebel-controlled sectors (strategic placement), fallback to any non-rebel sector. Use existing sector selection helpers if available, otherwise pick the non-rebel sector with the most adjacent rebel sectors.
- Call `targetSector.addDictatorMilitia(totalConverted)`
- Message: `Noriega moved ${totalConverted} converted militia to ${targetSector.sectorName}`
- Check for combat in destination sector: for each rebel player, if `hasEnemies(game, targetSector, rebel)` is true, call `queuePendingCombat(game, targetSector, rebel, false)`. Import `hasEnemies` and `queuePendingCombat` from combat.ts (check existing imports -- other ability functions already import these).

Step 3 - Conditional hire:
- Calculate AFTER conversion: `dictatorSectors = game.getControlledSectors(game.dictatorPlayer).length`
- Calculate total rebel sectors: sum `game.getControlledSectors(rebel).length` for all rebels
- If `dictatorSectors < totalRebelSectors`, hire 1 MERC following the exact Gaddafi hire pattern (draw, place in non-full squad, auto-equip, select sector, update sarge bonuses, emit map entry, message)
- If no hire needed, message: `Noriega controls enough sectors - no bonus hire`

**dictator-abilities.ts -- Register in switch blocks:**
- Add `case 'noriega':` returning `true` in the "has ability" switch
- Add `case 'noriega':` calling `applyNoriegaTurnAbility(game)` in the dispatch switch
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `applyNoriegaTurnAbility` in dictator-abilities.ts -- function exists
- Grep for `case 'noriega'` in dictator-abilities.ts -- appears in both switch blocks
- Grep for `pendingNoriegaConversion` in game.ts -- property exists
  </verify>
  <done>
- MERCGame has pendingNoriegaConversion state for human flow
- AI Noriega converts militia from rebel sectors, moves to strategic non-rebel sector, hires conditionally
- Both switch blocks handle 'noriega' case
  </done>
</task>

<task type="auto">
  <name>Task 2: Noriega human actions, flow steps, and UI wiring</name>
  <files>
    src/rules/actions/dictator-actions.ts
    src/rules/actions/index.ts
    src/rules/flow.ts
    src/ui/components/DictatorPanel.vue
    src/ui/composables/useActionState.ts
  </files>
  <action>
**dictator-actions.ts -- Create Noriega human actions:**

1. `createNoriegaConvertMilitiaAction(game)` -- Multi-step action:
   - Action name: `'noriegaConvertMilitia'`
   - Condition: dictator is Noriega, not AI, not finished
   - Execute (no selections needed for conversion -- it's automatic):
     - Run the same conversion logic as AI: iterate rebel players' controlled sectors, removeRebelMilitia(seat, 1) from each, track totalConverted
     - Set `game.pendingNoriegaConversion = { convertedCount: totalConverted }`
     - Message each conversion
     - If totalConverted === 0, message "No rebel militia to convert" and set pendingNoriegaConversion to null

2. `createNoriegaPlaceMilitiaAction(game)` -- Sector choice for placing converted militia:
   - Action name: `'noriegaPlaceMilitia'`
   - Condition: dictator is Noriega, not AI, not finished, `game.pendingNoriegaConversion != null` and `convertedCount > 0`
   - Selection: `chooseElement` for non-rebel-controlled sectors. Filter sectors where no rebel player has control. Label the choice: "Choose sector for ${convertedCount} converted militia"
   - Execute: `targetSector.addDictatorMilitia(game.pendingNoriegaConversion.convertedCount)`, message, set `game.pendingNoriegaConversion = null`. Queue combat for any rebel with enemies in the target sector using `queuePendingCombat`.

3. `createNoriegaBonusHireAction(game)` -- Conditional hire:
   - Action name: `'noriegaBonusHire'`
   - Condition: dictator is Noriega, not AI, not finished, `game.pendingNoriegaConversion == null` (conversion step complete), dictator controls fewer sectors than total rebel sectors. Calculate: `game.getControlledSectors(game.dictatorPlayer).length < sum of game.getControlledSectors(rebel).length for all rebels`
   - Follow the exact Gaddafi hire action pattern: equipment choice, sector choice, draw/equip/place/message
   - Use same cached value pattern as Gaddafi for the drawn MERC

**index.ts -- Register all 3 actions:**
- Import `createNoriegaConvertMilitiaAction`, `createNoriegaPlaceMilitiaAction`, `createNoriegaBonusHireAction`
- Add all 3 to `registerAllActions`

**flow.ts -- Add Noriega flow steps:**
- Add `'noriegaConvertMilitia'` to the `dictator-ability` actionStep actions array (line ~1001)
- Add these NEW steps after the hitler-pick-target step (from plan 01) but before the mao-militia-distribution loop:

```typescript
// Noriega: Choose sector for converted militia (human only)
actionStep({
  name: 'noriega-place-militia',
  actions: ['noriegaPlaceMilitia'],
  prompt: "Noriega: Choose a sector for converted militia",
  skipIf: () => game.isFinished() ||
    game.dictatorPlayer?.dictator?.combatantId !== 'noriega' ||
    game.dictatorPlayer?.isAI === true ||
    game.pendingNoriegaConversion == null ||
    game.pendingNoriegaConversion.convertedCount <= 0,
}),

// Noriega: Conditional bonus hire (human only, after conversion complete)
actionStep({
  name: 'noriega-bonus-hire',
  actions: ['noriegaBonusHire'],
  prompt: "Noriega: Hire a bonus MERC (controlling fewer sectors than rebels)",
  skipIf: () => {
    if (game.isFinished()) return true;
    if (game.dictatorPlayer?.dictator?.combatantId !== 'noriega') return true;
    if (game.dictatorPlayer?.isAI === true) return true;
    if (game.pendingNoriegaConversion != null) return true; // conversion not done yet
    const dictSectors = game.getControlledSectors(game.dictatorPlayer).length;
    let rebelSectors = 0;
    for (const r of game.rebelPlayers) rebelSectors += game.getControlledSectors(r).length;
    return dictSectors >= rebelSectors;
  },
}),
```

NOTE: The existing combat resolution sub-flow (at line ~1031-1051) already handles pending combat from any ability. Noriega's queued combat will be processed by that existing flow -- no new combat flow needed.

**DictatorPanel.vue -- Add UI routing:**
- Add `'noriegaConvertMilitia'`, `'noriegaPlaceMilitia'`, `'noriegaBonusHire'` to the `dictatorSpecificActions` array
- Add `isNoriegaHiring` computed following the existing hiring patterns (check metadata for noriegaBonusHire)
- Add to any sector selection conditionals alongside other hiring actions

**useActionState.ts -- Add state tracking:**
- Add `isNoriegaHiring: ComputedRef<boolean>` to the return type interface
- Add `isNoriegaHiring` computed following the existing pattern
- Add to the return object
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Grep for `noriegaConvertMilitia` in dictator-actions.ts, index.ts, flow.ts, DictatorPanel.vue -- all 4 files contain it
- Grep for `noriegaPlaceMilitia` in dictator-actions.ts, index.ts, flow.ts -- all 3 files contain it
- Grep for `noriegaBonusHire` in dictator-actions.ts, index.ts, flow.ts, DictatorPanel.vue -- all 4 files contain it
- Grep for `isNoriegaHiring` in DictatorPanel.vue and useActionState.ts -- both files contain it
  </verify>
  <done>
- Human Noriega converts militia automatically, then chooses destination sector, then gets conditional hire
- All 3 actions registered, wired into flow, and routed through DictatorPanel
- Combat is queued when converted militia land on rebel forces
- Conditional hire only triggers when dictator controls fewer sectors than rebels (post-conversion)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All new action names appear in flow.ts, index.ts, dictator-actions.ts, and DictatorPanel.vue
3. `pendingNoriegaConversion` is referenced in game.ts, dictator-actions.ts, flow.ts
4. AI path and human path both convert militia, place in non-rebel sector, and conditionally hire
5. Sector comparison for conditional hire uses post-conversion counts
6. Existing combat resolution sub-flow handles Noriega-triggered combat
</verification>

<success_criteria>
- AI Noriega converts rebel militia, places strategically, and hires when behind on sectors
- Human Noriega sees automatic conversion, picks destination sector, gets conditional hire UI
- Combat triggers when placing militia in rebel-occupied sectors
- Conditional hire correctly compares post-conversion sector counts
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/60-complex-interactive-abilities/60-02-SUMMARY.md`
</output>
