---
phase: 31
plan: 02
wave: 2
depends_on: [01]
files_modified:
  - src/ui/composables/useVictoryCalculations.ts (new)
autonomous: true
---

# Plan 02: Create useVictoryCalculations Composable

## Objective

Extract victory calculation functions from GameBoard.vue into `src/ui/composables/useVictoryCalculations.ts`. These functions determine game end conditions and winner.

## Tasks

<task id="1">
Create `src/ui/composables/useVictoryCalculations.ts` with the following functions extracted from GameBoard.vue lines 1186-1318:

**Functions to extract:**
1. `countTacticsCards(containerNode: any): number` — helper for counting cards
2. `calculateRebelVictoryPoints(): number` — counts rebel-controlled sectors
3. `calculateDictatorVictoryPoints(): number` — counts dictator-controlled sectors + base bonus
4. `isGameOver: ComputedRef<boolean>` — computed that checks all end conditions
5. `gameWinner: ComputedRef<'rebels' | 'dictator' | null>` — computed that determines winner

**Dependencies:**
- Imports from `useGameViewHelpers`: normalizeClassName, findAllByClassName, findByClassName, getAttr, findDictatorCombatant
</task>

<task id="2">
Implement the composable with this structure:

```typescript
import { computed, type ComputedRef } from 'vue';
import {
  normalizeClassName,
  findAllByClassName as findAllByClassNamePure,
  findByClassName as findByClassNamePure,
  getAttr,
  findDictatorCombatant as findDictatorCombatantPure,
} from './useGameViewHelpers';

/**
 * Victory calculation composable.
 * @param getGameView - Getter function that returns the current gameView
 */
export function useVictoryCalculations(getGameView: () => any) {
  // Bind helper functions to gameView
  const findByClassName = (className: string, root?: any) =>
    findByClassNamePure(className, root ?? getGameView());
  const findAllByClassName = (className: string, root?: any) =>
    findAllByClassNamePure(className, root ?? getGameView());
  const findDictatorCombatant = (root?: any) =>
    findDictatorCombatantPure(root ?? getGameView());

  // Pure helper (no gameView dependency)
  function countTacticsCards(containerNode: any): number {
    if (!containerNode?.children) return 0;
    return containerNode.children.filter(
      (c: any) => normalizeClassName(c.className) === 'TacticsCard'
    ).length;
  }

  function calculateRebelVictoryPoints(): number {
    // ... implementation
  }

  function calculateDictatorVictoryPoints(): number {
    // ... implementation
  }

  const isGameOver: ComputedRef<boolean> = computed(() => {
    // Check dictator defeat, tactics exhausted, explosives victory
    // ...
  });

  const gameWinner: ComputedRef<'rebels' | 'dictator' | null> = computed(() => {
    // Determine winner based on end condition
    // ...
  });

  return {
    countTacticsCards,
    calculateRebelVictoryPoints,
    calculateDictatorVictoryPoints,
    isGameOver,
    gameWinner,
  };
}
```
</task>

<task id="3">
Key implementation details:

**calculateRebelVictoryPoints:**
- Find all Sector nodes
- For each sector, get dictatorMilitia and sum rebelMilitia map
- Count sectors where rebelMilitia > dictatorMilitia

**calculateDictatorVictoryPoints:**
- Find DictatorPlayer to get baseSectorId
- For each sector, dictator controls if dictatorMilitia > rebelMilitia OR (tied with militia > 0)
- Base sector gives +1 bonus point

**isGameOver conditions:**
1. Dictator dead (inPlay=true AND damage >= maxHealth)
2. TacticsDeck AND TacticsHand both empty
3. explosivesVictory flag true on gameView

**gameWinner logic:**
- If dictator dead → rebels
- If explosives victory → rebels
- If tactics exhausted → compare points (dictator wins ties)

**explosivesVictory access:**
- Get from `getGameView()?.explosivesVictory` or `getGameView()?.attributes?.explosivesVictory`
</task>

## Verification

<verify>
1. File exists at src/ui/composables/useVictoryCalculations.ts
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. Imports from useGameViewHelpers work correctly
4. isGameOver and gameWinner are Vue computed refs
5. No direct props access (uses getGameView getter)
</verify>

## Must Haves

- [ ] `countTacticsCards` counts TacticsCard children in container
- [ ] `calculateRebelVictoryPoints` sums sectors with more rebel militia
- [ ] `calculateDictatorVictoryPoints` includes base sector bonus
- [ ] `isGameOver` returns true for all 3 end conditions
- [ ] `gameWinner` correctly determines winner for each condition
- [ ] Dictator wins ties in point comparison
- [ ] explosivesVictory checked in both gameView root and attributes
- [ ] All functions use getGameView() getter for tree access
- [ ] isGameOver and gameWinner are reactive (Vue computed)
