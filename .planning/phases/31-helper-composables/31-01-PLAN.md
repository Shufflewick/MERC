---
phase: 31
plan: 01
wave: 1
depends_on: []
files_modified:
  - src/ui/composables/useGameViewHelpers.ts (new)
autonomous: true
---

# Plan 01: Create useGameViewHelpers Composable

## Objective

Extract pure utility functions from GameBoard.vue into `src/ui/composables/useGameViewHelpers.ts`. These functions are used for DOM traversal and element lookup in the gameView tree.

## Tasks

<task id="1">
Create the composables directory:
```bash
mkdir -p src/ui/composables
```
</task>

<task id="2">
Create `src/ui/composables/useGameViewHelpers.ts` with the following functions extracted from GameBoard.vue lines 58-214:

**Functions to extract:**
1. `normalizeClassName(className: string): string` — strips underscore prefix
2. `findByClassName(className: string, root?: any): any` — recursive find by class
3. `findAllByClassName(className: string, root?: any): any[]` — find all matching
4. `findByRef(ref: string, root?: any): any` — find by ref attribute
5. `findElementById(id: number | string, root?: any): any` — find by element ID
6. `getAttr<T>(node: any, key: string, defaultVal: T): T` — get node attribute
7. `findDictatorCombatant(root?: any): any` — find dictator by cardType
8. `findDictatorCombatantWithParent(root?: any, parent?: any): { node: any; parent: any } | null`
9. `isMercDead(merc: any): boolean` — check if MERC is dead

**Design pattern:**
- Export a composable function `useGameViewHelpers(getGameView: () => any)` that takes a gameView getter
- Also export individual pure functions for direct use (when caller has root already)
- Composable-bound functions use the getter as default root when none provided
- Pure exports: `normalizeClassName`, `getAttr` (no gameView needed)
- Composable: all functions with gameView binding for Vue component use
</task>

<task id="3">
Implement the composable with this structure:

```typescript
/**
 * Pure utility functions for traversing and querying the gameView tree.
 * These have no Vue reactivity dependencies.
 */

// Pure function exports (can be used directly without composable)
export function normalizeClassName(className: string): string {
  return className?.replace(/^_/, '') || '';
}

export function getAttr<T>(node: any, key: string, defaultVal: T): T {
  if (node?.attributes && node.attributes[key] !== undefined) return node.attributes[key];
  if (node && node[key] !== undefined) return node[key];
  return defaultVal;
}

// ... other pure functions

/**
 * Composable that provides gameView helpers with bound context.
 * @param getGameView - Getter function that returns the current gameView
 */
export function useGameViewHelpers(getGameView: () => any) {
  // Bind functions to use getGameView() as default root
  const findByClassName = (className: string, root?: any) => {
    // ... uses getGameView() when root is undefined
  };

  // ... other bound functions

  return {
    normalizeClassName,
    findByClassName,
    findAllByClassName,
    findByRef,
    findElementById,
    getAttr,
    findDictatorCombatant,
    findDictatorCombatantWithParent,
    isMercDead,
  };
}
```
</task>

## Verification

<verify>
1. File exists at src/ui/composables/useGameViewHelpers.ts
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. All 9 functions are exported (both pure and from composable)
4. No Vue imports in the file (these are pure functions)
</verify>

## Must Haves

- [ ] `normalizeClassName` strips underscore prefix correctly
- [ ] `findByClassName` recursively searches tree and handles underscore prefix
- [ ] `findAllByClassName` returns array of all matches
- [ ] `findByRef` finds by ref attribute
- [ ] `findElementById` handles both number and string IDs
- [ ] `getAttr` checks attributes then root properties
- [ ] `findDictatorCombatant` finds CombatantModel with cardType='dictator'
- [ ] `findDictatorCombatantWithParent` returns both node and parent
- [ ] `isMercDead` checks isDead, health, damage/maxHealth, and discard container
- [ ] Composable accepts gameView getter parameter
- [ ] TypeScript types are correct
