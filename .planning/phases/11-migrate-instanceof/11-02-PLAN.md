---
phase: 11-migrate-instanceof
plan: 02
type: execute
---

<objective>
Migrate rebel-equipment.ts and rebel-economy.ts from instanceof checks to property-based type guards.

Purpose: Eliminate 32 instanceof checks in equipment and economy action files.
Output: rebel-equipment.ts and rebel-economy.ts using property-based checks.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-migrate-instanceof/11-01-SUMMARY.md

@src/rules/actions/helpers.ts
@src/rules/actions/rebel-equipment.ts
@src/rules/actions/rebel-economy.ts

**Available type guards (from Plan 01):**
- `isCombatUnitCard(element)` - checks for CombatUnitCard
- `isMercCard(element)` - checks for MercCard
- `isDictatorCard(element)` - checks for DictatorCard

**Property-based approach:**
- `element.isMerc` - boolean getter on CombatUnitCard
- `element.isDictator` - boolean getter on CombatUnitCard
- `element.unitId` - unified ID property (replaces mercId/dictatorId)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate rebel-equipment.ts instanceof checks (24 occurrences)</name>
  <files>src/rules/actions/rebel-equipment.ts</files>
  <action>
Replace all instanceof MercCard/DictatorCard checks with property-based guards.

**Pattern A: getElementById result check**
Before:
```typescript
const el = game.getElementById(unitArg);
return el instanceof MercCard ? el : undefined;
```
After:
```typescript
const el = game.getElementById(unitArg);
return isMercCard(el) ? el : undefined;
```
Or if only need CombatUnitCard:
```typescript
const el = game.getElementById(unitArg);
return isCombatUnitCard(el) && el.isMerc ? el as MercCard : undefined;
```

**Pattern B: Filter callback**
Before:
```typescript
filter: (element, ctx) => {
  if (!(element instanceof MercCard)) return false;
  // ...
}
```
After:
```typescript
filter: (element, ctx) => {
  if (!isMercCard(element)) return false;
  // ...
}
```

**Pattern C: Multiple type options with union return**
Before:
```typescript
if (el instanceof MercCard) return el;
if (el instanceof DictatorCard) return el;
return undefined;
```
After:
```typescript
if (isCombatUnitCard(el)) return el;
return undefined;
```

**Pattern D: Type check for name extraction**
Before:
```typescript
function getUnitDisplayName(unit: MercCard | DictatorCard): string {
  if (unit instanceof MercCard) return capitalize(unit.mercName);
  return capitalize(unit.dictatorName);
}
```
After:
```typescript
function getUnitDisplayName(unit: MercCard | DictatorCard): string {
  return capitalize(unit.unitName);
}
```
(unitName getter works on both via CombatUnitCard)

**Pattern E: Ownership check**
Before:
```typescript
return unit instanceof MercCard && isInPlayerTeam(unit, player as RebelPlayer);
```
After:
```typescript
return unit.isMerc && isInPlayerTeam(unit as MercCard, player as RebelPlayer);
```

Import the type guards from helpers.ts at the top of the file.
  </action>
  <verify>npm run build passes, grep for "instanceof MercCard" in rebel-equipment.ts shows 0</verify>
  <done>All instanceof checks in rebel-equipment.ts replaced</done>
</task>

<task type="auto">
  <name>Task 2: Migrate rebel-economy.ts instanceof checks (8 occurrences)</name>
  <files>src/rules/actions/rebel-economy.ts</files>
  <action>
Replace all instanceof MercCard checks with property-based guards.

Most occurrences in rebel-economy.ts follow the pattern of filtering elements:
```typescript
if (!(element instanceof MercCard)) return false;
```
Replace with:
```typescript
if (!isMercCard(element)) return false;
```

Import `isMercCard` from helpers.ts.

The DictatorCard check (1 occurrence) likely follows similar pattern to rebel-equipment.ts.
  </action>
  <verify>npm run build passes, grep for "instanceof" in rebel-economy.ts shows 0 MercCard/DictatorCard matches</verify>
  <done>All instanceof checks in rebel-economy.ts replaced</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes (may have pre-existing failures)
- [ ] `grep -c "instanceof MercCard" src/rules/actions/rebel-equipment.ts` returns 0
- [ ] `grep -c "instanceof DictatorCard" src/rules/actions/rebel-equipment.ts` returns 0
- [ ] `grep -c "instanceof MercCard" src/rules/actions/rebel-economy.ts` returns 0
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No new TypeScript errors introduced
- rebel-equipment.ts and rebel-economy.ts use property-based guards exclusively
</success_criteria>

<output>
After completion, create `.planning/phases/11-migrate-instanceof/11-02-SUMMARY.md`
</output>
