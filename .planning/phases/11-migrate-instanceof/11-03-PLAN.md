---
phase: 11-migrate-instanceof
plan: 03
type: execute
---

<objective>
Migrate remaining files from instanceof checks to property-based type guards.

Purpose: Complete the instanceof migration across all remaining files (19 occurrences).
Output: All src/rules files using property-based type guards for MercCard/DictatorCard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-migrate-instanceof/11-01-SUMMARY.md
@.planning/phases/11-migrate-instanceof/11-02-SUMMARY.md

@src/rules/actions/helpers.ts

**Files to migrate:**
- src/rules/actions/helpers.ts (5 occurrences - some already done in Plan 01)
- src/rules/ai-helpers.ts (4 occurrences)
- src/rules/ai-executor.ts (3 occurrences)
- src/rules/actions/day-one-actions.ts (3 occurrences)
- src/rules/actions/rebel-combat.ts (2 occurrences)
- src/rules/actions/dictator-actions.ts (2 occurrences)
- tests/action-conditions.test.ts (1 occurrence)

**Available type guards:**
- `isCombatUnitCard(element)` - checks for CombatUnitCard
- `isMercCard(element)` - checks for MercCard
- `isDictatorCard(element)` - checks for DictatorCard
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate helpers.ts remaining instanceof checks</name>
  <files>src/rules/actions/helpers.ts</files>
  <action>
Update remaining instanceof checks in helpers.ts (excluding the type guard functions themselves).

Functions to update:
- `getUnitName()` - use `unit.unitName` directly (works for both via CombatUnitCard)
- `getUnitSector()` - use `unit.isMerc`/`unit.isDictator` checks
- `asMercCard()` - use `isMercCard()` type guard

For `asMercCard`:
```typescript
export function asMercCard(element: unknown): MercCard {
  if (isMercCard(element)) {
    return element;
  }
  throw new Error(`Expected MercCard but got ${typeof element}`);
}
```
  </action>
  <verify>npm run build passes, grep for "instanceof MercCard" in helpers.ts shows only type guard definitions</verify>
  <done>helpers.ts uses property-based checks except in type guard definitions</done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining AI and action files</name>
  <files>src/rules/ai-helpers.ts, src/rules/ai-executor.ts, src/rules/actions/day-one-actions.ts, src/rules/actions/rebel-combat.ts, src/rules/actions/dictator-actions.ts</files>
  <action>
Migrate all remaining files to use property-based type guards.

**ai-helpers.ts (4 occurrences):**
- Import `isMercCard` from helpers
- Replace `instanceof MercCard` with `isMercCard()` or `.isMerc` checks

**ai-executor.ts (3 occurrences):**
- Import `isMercCard` from helpers
- For unit name extraction: use `unit.unitName` directly
- For type checks: use `.isMerc`/`.isDictator` properties

**day-one-actions.ts (3 occurrences):**
- Import `isMercCard` from helpers
- Replace instanceof checks with property-based guards

**rebel-combat.ts (2 occurrences):**
- Import `isMercCard` from helpers
- Replace instanceof checks with property-based guards

**dictator-actions.ts (2 occurrences):**
- Import type guards from helpers
- Replace instanceof checks with property-based guards
  </action>
  <verify>npm run build passes, grep for "instanceof MercCard" across these files shows 0 results</verify>
  <done>All AI and action files migrated to property-based checks</done>
</task>

<task type="auto">
  <name>Task 3: Migrate test file and final verification</name>
  <files>tests/action-conditions.test.ts</files>
  <action>
Update the single instanceof check in tests/action-conditions.test.ts.

Then run comprehensive grep to verify NO instanceof MercCard or DictatorCard remains anywhere in src/rules/ or tests/.

```bash
grep -r "instanceof MercCard" src/rules/
grep -r "instanceof DictatorCard" src/rules/
grep -r "instanceof MercCard" tests/
grep -r "instanceof DictatorCard" tests/
```

All should return empty (0 matches).
  </action>
  <verify>npm run build passes, npm test passes, all grep commands show 0 results</verify>
  <done>All instanceof MercCard/DictatorCard checks eliminated from codebase</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes (may have pre-existing failures)
- [ ] `grep -r "instanceof MercCard" src/rules/` returns empty
- [ ] `grep -r "instanceof DictatorCard" src/rules/` returns empty
- [ ] `grep -r "instanceof MercCard" tests/` returns empty
- [ ] `grep -r "instanceof DictatorCard" tests/` returns empty
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No new TypeScript errors introduced
- Zero instanceof MercCard/DictatorCard checks remain in codebase
- Phase 11 complete
</success_criteria>

<output>
After completion, create `.planning/phases/11-migrate-instanceof/11-03-SUMMARY.md`

Summary should note:
- Total instanceof checks migrated (107)
- Files modified
- Type guards added to helpers.ts
- Phase 11 complete, ready for Phase 12: Merge Data Files
</output>
