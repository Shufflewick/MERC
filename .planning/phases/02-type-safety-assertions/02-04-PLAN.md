---
phase: 02-type-safety-assertions
plan: 04
type: execute
---

<objective>
Fix type assertions in rebel-movement.ts.

Purpose: Eliminate 54 unsafe type assertions in rebel movement actions.
Output: Properly typed rebel-movement.ts using assertion helpers and type narrowing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./02-04-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-type-safety-assertions/02-01-SUMMARY.md

@src/rules/actions/rebel-movement.ts
@src/rules/actions/helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix rebel-movement.ts isRebelPlayer/isDictatorPlayer assertions</name>
  <files>src/rules/actions/rebel-movement.ts</files>
  <action>
Fix all instances of:
- `game.isRebelPlayer(ctx.player as any)` - Remove `as any` if method accepts base type
- `game.isDictatorPlayer(ctx.player as any)` - Same pattern

There are ~10 instances. Apply the fix from 02-02 consistently:
- If `ctx.player` type is compatible with `MERCPlayer`, remove cast entirely
- If not, use `ctx.player as MERCPlayer` (safer than `any`)

Check the imports at top of file - ensure MERCPlayer or player types are imported.
  </action>
  <verify>`grep -c "player as any" src/rules/actions/rebel-movement.ts` returns 0</verify>
  <done>All player type guard calls use proper types, no `as any`</done>
</task>

<task type="auto">
  <name>Task 2: Fix rebel-movement.ts player and element assertions</name>
  <files>src/rules/actions/rebel-movement.ts</files>
  <action>
Fix remaining assertions (~44 more):

**Player casts:**
- `player as RebelPlayer` - Use after type guard check OR use asRebelPlayer helper
- `ctx.player as RebelPlayer` - Same approach

**Element casts:**
- `element as unknown as Squad` - Create `asSquad()` helper if needed, or use inline check
- `element as unknown as Sector` - Use `asSector()` helper from 02-01
- `args.squad as Squad` - Use validation
- `args.destination as Sector` - Use validation
- `args.target as Sector` - Use validation

**Pattern for element casts in chooseElement callbacks:**
```typescript
// These are generally safe - the framework provides typed elements
// based on the filter. But we can still add runtime check:
filter: (element) => {
  const sector = element as Sector;
  return sector.hasMilitia; // Safe because filter defines element type
}

// OR create typed wrapper:
filter: (element) => {
  if (!isSector(element)) return false;
  return element.hasMilitia;
}
```

Add `isSquad(element): element is Squad` type guard to helpers if needed.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm test` passes
3. `grep -c "as any" src/rules/actions/rebel-movement.ts` returns 0
  </verify>
  <done>rebel-movement.ts assertions fixed, using proper type guards and helpers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm test` passes
- [ ] No `as any` in rebel-movement.ts
- [ ] Reduced `as unknown as` patterns where practical
</verification>

<success_criteria>

- rebel-movement.ts uses proper type assertions
- No `as any` casts
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-type-safety-assertions/02-04-SUMMARY.md`
</output>
