---
phase: 41-testing-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/merc-abilities-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Squad-conditional abilities activate/deactivate based on squad composition"
    - "Tack and Valkyrie bonuses apply to correct targets (allSquad vs squadMates)"
    - "Combat-only abilities (Max debuff, Walter militia, Vulture penalty negation) work at combat time"
  artifacts:
    - path: "tests/merc-abilities-integration.test.ts"
      provides: "Integration tests for squad-conditional and combat-only abilities"
      contains: "Squad-Conditional|Combat-Only"
  key_links:
    - from: "tests/merc-abilities-integration.test.ts"
      to: "src/rules/combat.ts"
      via: "getCombatants() for combat-time verification"
      pattern: "getCombatants"
---

<objective>
Add integration tests verifying squad-conditional and combat-only abilities use the unified stat system.

Purpose: Verify that squad composition changes trigger stat bonuses through activeStatModifiers, and that combat-only effects apply at combat time. This confirms the unified stat system handles complex conditions correctly.

Output: Extended tests/merc-abilities-integration.test.ts with tests for 10 MERCs (6 squad-conditional + 4 combat-only including Vulture)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/41-testing-verification/41-RESEARCH.md

@tests/merc-abilities-integration.test.ts
@src/rules/elements.ts
@src/rules/merc-abilities.ts
@src/rules/combat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add squad-conditional ability tests</name>
  <files>tests/merc-abilities-integration.test.ts</files>
  <action>
Add a new describe block "Squad-Conditional Ability Stats" that tests effectiveCombat/effectiveInitiative changes based on squad composition.

For each MERC, the test pattern is:
1. Find MERC in deck (skip if not found)
2. Place MERC in rebel.primarySquad
3. Set up squad condition (add/remove squad mates)
4. Call updateAbilityBonuses(squadMates) with correct squad context
5. Assert effective stat changes when condition is met
6. Assert effective stat reverts when condition is not met

Test cases (6 MERCs):

**Haarg (squadMateHigherBase):**
- Find Haarg and Sonia (Sonia has higher training/initiative than Haarg)
- Place both in squad, call updateHaargBonus(squadMates)
- Assert Haarg's effectiveTraining === baseTraining + 1 (Sonia has 4 > Haarg's 1)
- Assert Haarg's effectiveInitiative === baseInitiative + 1 (Sonia has 4 > Haarg's 1)
- Assert Haarg's effectiveCombat === baseCombat (Sonia has 2 < Haarg's 3)

**Sarge (highestInitInSquad, self bonus):**
- Find Sarge, place alone or with lower-init squadmate
- Verify has highest BASE initiative in squad
- Call updateAbilityBonuses(squadMates)
- Assert effectiveCombat/effectiveTraining/effectiveInitiative all get +1
- Test negative: add higher-init squadmate, verify bonuses disappear

**Tack (highestInitInSquad, allSquad bonus):**
- Find Tack and another MERC
- Place Tack (base init 5) with lower-init squadmate
- Call updateAbilityBonuses on BOTH - Tack's bonus applies to whole squad
- Assert BOTH Tack and squadmate get +2 initiative

**Valkyrie (always, squadMates bonus):**
- Find Valkyrie and another MERC
- Place both in squad
- Call updateAbilityBonuses on squadmate (Valkyrie is source, not target)
- Assert squadmate gets +1 initiative
- Assert Valkyrie does NOT get +1 initiative (excludes self)

**Snake (aloneInSquad):**
- Find Snake, place alone in squad
- Call updateAbilityBonuses([snake]) - only Snake in squad
- Assert effectiveCombat/effectiveTraining/effectiveInitiative all get +1
- Add second MERC to squad, call updateAbilityBonuses again
- Assert bonuses disappear

**Tavisto (womanInSquad):**
- Find Tavisto and a female MERC (e.g., Sonia, Valkyrie)
- Place both in squad
- Call updateAbilityBonuses(squadMates)
- Assert Tavisto's effective stats all get +1
- Test negative: remove female, verify bonuses disappear
  </action>
  <verify>npm test -- --reporter=verbose merc-abilities-integration | grep -E "(Squad-Conditional|Haarg|Sarge|Tack|Valkyrie|Snake|Tavisto|PASS|FAIL)"</verify>
  <done>6 squad-conditional tests pass, verifying condition activation/deactivation and correct target selection (self vs squadMates vs allSquad)</done>
</task>

<task type="auto">
  <name>Task 2: Add combat-only ability tests</name>
  <files>tests/merc-abilities-integration.test.ts</files>
  <action>
Add a new describe block "Combat-Only Ability Stats" that tests abilities applied only during combat resolution.

These tests import getCombatants from '../src/rules/combat.js' and verify combat-time application.

Test cases (4 MERCs):

**Max (enemyDebuff):**
- Set up combat scenario with Max on rebel side, enemy MERC on dictator side
- Call getCombatants() to get combat representation
- Assert enemy MERC combatant has combat reduced by 1
- Note: This is applied in applyEnemyDebuffs() during combat, not in activeStatModifiers

**Walter (militiaBonus):**
- Set up combat scenario with Walter and militia on same side
- Call getCombatants()
- Assert militia combatants have +2 initiative
- Note: Applied via applyWalterBonus() in combat.ts

**Khenn (random initiative):**
- Khenn has baseInitiative 0
- In combat, Khenn rolls D6 for initiative
- Test that Khenn's base is 0, and combat function handles the roll
- Can verify via combatant.hasRandomInit flag or similar

**Vulture (ignores initiative penalties):**
- Find Vulture, equip with heavy weapon that has initiative penalty
- Call updateAbilityBonuses([])
- Assert effectiveInitiative is NOT reduced by equipment penalty
- Note: Vulture's penalty negation is in CombatantCard.vue display logic, but effectiveInitiative should still show correct value
- The negation is stored in activeStatModifiers or handled specially

Note: These tests may need to set up more game state (sectors, dictator units). If full combat setup is too complex, verify the individual functions exist and document the combat-time-only nature.
  </action>
  <verify>npm test -- --reporter=verbose merc-abilities-integration | grep -E "(Combat-Only|Max|Walter|Khenn|Vulture|PASS|FAIL)"</verify>
  <done>4 combat-only tests pass, verifying abilities that apply at combat time are handled correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add visual verification documentation</name>
  <files>tests/merc-abilities-integration.test.ts</files>
  <action>
Add a describe.skip block "Visual Verification Checklist" with documented test stubs that describe manual visual verification steps.

This documents what a human should verify in the UI:

```typescript
describe.skip('Visual Verification Checklist', () => {
  it('Stumpy+Mortar shows no duplicate display', () => {
    // Manual verification:
    // 1. Start game with Stumpy on team
    // 2. Equip Stumpy with Mortar
    // 3. Hover over Combat stat
    // 4. Verify tooltip shows exactly:
    //    - Base: 2
    //    - Mortar: +5
    //    - Stumpy's Ability: +1
    //    (No duplicate "Ability +1" line)
  });

  it('Mayhem+Uzi combat dice match displayed value', () => {
    // Manual verification:
    // 1. Start game with Mayhem on team
    // 2. Equip Mayhem with Uzi
    // 3. Note displayed Combat value (base 3 + Uzi bonus + 2 ability = should be high)
    // 4. Enter combat
    // 5. Count dice rolled for Mayhem
    // 6. Verify dice count matches displayed Combat
  });

  it('Tack squad bonus shows on all squad members', () => {
    // Manual verification:
    // 1. Start game with Tack (base init 5) and lower-init squadmate
    // 2. Place both in same squad
    // 3. Hover over Initiative on squadmate
    // 4. Verify tooltip shows "Tack's Ability: +2"
  });
});
```

This serves as documentation for STAT-05 visual verification requirement without requiring Puppeteer/browser automation.
  </action>
  <verify>grep -c "Visual Verification" tests/merc-abilities-integration.test.ts</verify>
  <done>Visual verification checklist documented as skipped tests</done>
</task>

</tasks>

<verification>
1. Run full test suite: `npm test`
2. All existing tests still pass (580+)
3. Squad-conditional tests verify both condition activation and deactivation
4. Combat-only tests verify combat-time application
5. Visual verification documented as skipped test stubs
</verification>

<success_criteria>
- 10 new tests pass (6 squad-conditional + 4 combat-only)
- Squad-conditional tests verify bonus targets correctly (self vs squadMates vs allSquad)
- Combat-only tests verify abilities work at combat resolution time
- Visual verification checklist documented
- All 580+ existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/41-testing-verification/41-02-SUMMARY.md`
</output>
