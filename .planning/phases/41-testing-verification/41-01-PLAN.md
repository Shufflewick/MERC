---
phase: 41-testing-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/merc-abilities-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Equipment-conditional abilities increase effectiveCombat/effectiveInitiative when equipment is equipped"
    - "Passive abilities (Shooter, Juicer, Ewok) have correct effective stats from game start"
    - "activeStatModifiers array is populated with correct bonus and label for each ability"
  artifacts:
    - path: "tests/merc-abilities-integration.test.ts"
      provides: "Integration tests for equipment-conditional and passive abilities"
      contains: "effectiveCombat.*baseCombat"
  key_links:
    - from: "tests/merc-abilities-integration.test.ts"
      to: "src/rules/elements.ts"
      via: "updateAbilityBonuses() call"
      pattern: "updateAbilityBonuses"
---

<objective>
Add integration tests verifying equipment-conditional and passive abilities use the unified stat system.

Purpose: Verify that equipping items triggers stat bonuses through activeStatModifiers, and that effective stats reflect these bonuses. This confirms the unified stat system from Phases 37-40 works correctly.

Output: Extended tests/merc-abilities-integration.test.ts with tests for 11 MERCs (8 equipment-conditional + 3 passive)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/41-testing-verification/41-RESEARCH.md

@tests/merc-abilities-integration.test.ts
@src/rules/elements.ts
@src/rules/merc-abilities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add equipment-conditional ability tests</name>
  <files>tests/merc-abilities-integration.test.ts</files>
  <action>
Add a new describe block "Equipment-Conditional Ability Stats" that tests effectiveCombat/effectiveInitiative changes when equipment is equipped.

For each MERC, the test pattern is:
1. Find MERC in deck (skip if not found)
2. Record baseCombat before equipment
3. Find required equipment using existing helpers (isHandgun, isUzi, etc from equipment-effects.js)
4. Equip the item
5. Call updateAbilityBonuses([])
6. Assert effectiveCombat === baseCombat + weaponBonus + abilityBonus
7. Assert activeStatModifiers includes correct modifier with label

Test cases (8 MERCs):
- Bouba: +1 combat with handgun
- Mayhem: +2 combat with Uzi
- Rozeske: +1 combat with armor
- Stumpy: +1 combat with explosive (grenade or mortar)
- Vandradi: +1 combat with multi-target weapon
- Dutch: +1 combat and +1 initiative without weapon (or with sword)
- Moe: +1 targets with SMAW (test via activeStatModifiers since targets not in effectiveStats)
- Ra: +1 targets with any weapon (test via activeStatModifiers)

Import isHandgun, isUzi, isExplosive, isSword, isSmaw from '../src/rules/equipment-effects.js' for equipment lookup.

Each test should verify BOTH effectiveStat value AND activeStatModifiers content.
  </action>
  <verify>npm test -- merc-abilities-integration && echo "TESTS PASSED"</verify>
  <done>8 equipment-conditional tests pass, verifying effectiveCombat/effectiveInitiative changes AND activeStatModifiers populated</done>
</task>

<task type="auto">
  <name>Task 2: Add passive ability tests</name>
  <files>tests/merc-abilities-integration.test.ts</files>
  <action>
Add tests to verify passive (always-on) abilities are active from game start.

For each MERC, the test pattern is:
1. Find MERC in deck (skip if not found)
2. Call updateAbilityBonuses([]) - may already be called by game setup
3. Assert effective stat equals base + ability bonus

Test cases (3 MERCs):
- Shooter: effectiveCombat === baseCombat + 3, activeStatModifiers includes {stat: 'combat', bonus: 3}
- Juicer: Already tested (maxHealth === 5) - enhance to also check activeStatModifiers
- Ewok: Already tested (actionsRemaining === 3) - enhance to also check activeStatModifiers

Note: Juicer and Ewok tests already exist - update them to also verify activeStatModifiers array contains the correct modifier. Shooter test needs to be added completely.

For Shooter specifically:
- Shooter has baseCombat of 0, ability gives +3
- Test that effectiveCombat === 3 (not just that it exists)
  </action>
  <verify>npm test -- merc-abilities-integration && echo "TESTS PASSED"</verify>
  <done>3 passive ability tests verify effective stats AND activeStatModifiers, including new Shooter test</done>
</task>

</tasks>

<verification>
1. Run full test suite: `npm test`
2. All existing tests still pass (580+)
3. New tests verify both effective stats AND activeStatModifiers
4. No tests depend on specific deck order (handle "not in deck" gracefully)
</verification>

<success_criteria>
- 11 new/enhanced tests pass (8 equipment-conditional + 3 passive)
- Each test verifies effectiveStat value AND activeStatModifiers content
- Tests use updateAbilityBonuses() to trigger unified stat calculation
- No hardcoded stat values - tests use baseCombat + bonus pattern
</success_criteria>

<output>
After completion, create `.planning/phases/41-testing-verification/41-01-SUMMARY.md`
</output>
