---
phase: 37-extend-ability-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/merc-abilities.ts
autonomous: true

must_haves:
  truths:
    - "StatModifier interface exists with stat, bonus, condition, label, target fields"
    - "All 18 stat-modifying MERCs have statModifiers arrays defined"
    - "getActiveStatModifiers(merc, context) returns correct modifiers"
    - "Existing tests still pass (no behavioral changes)"
  artifacts:
    - path: "src/rules/merc-abilities.ts"
      provides: "StatModifier interface, statModifiers field on MercAbility, all 18 MERC definitions, getActiveStatModifiers function"
      contains: "export interface StatModifier"
  key_links:
    - from: "StatModifier.stat"
      to: "stat union type"
      via: "type definition"
      pattern: "stat: 'combat' \\| 'training'"
    - from: "statModifiers array"
      to: "MERC_ABILITIES entries"
      via: "MercAbility interface"
      pattern: "statModifiers\\?:"
---

<objective>
Add unified StatModifier interface to merc-abilities.ts and migrate all 18 stat-modifying MERCs to use declarative statModifiers arrays.

Purpose: Create single source of truth for ability stat bonuses, enabling unified calculation in Phase 38 and unified display in Phase 39. This phase is purely additive - existing fields remain until migration is complete.

Output: Extended merc-abilities.ts with StatModifier types, 18 MERC definitions with statModifiers, and getActiveStatModifiers() helper function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-extend-ability-registry/37-RESEARCH.md
@src/rules/merc-abilities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StatModifier interface and extend BonusTarget type</name>
  <files>src/rules/merc-abilities.ts</files>
  <action>
1. Extend BonusTarget type to include 'militia' (line 33):
   ```typescript
   export type BonusTarget = 'self' | 'squadMates' | 'allSquad' | 'enemyMercs' | 'militia';
   ```

2. Add new condition type for Haarg (extend AbilityCondition, line 28):
   ```typescript
   | 'squadMateHigherBase';   // Squad mate has higher BASE stat (Haarg)
   ```

3. Add StatModifier interface after EnemyDebuff (after line 79):
   ```typescript
   /**
    * Unified stat modifier for declarative ability definitions.
    * Single source of truth for stat bonuses - used by calculation and display.
    */
   export interface StatModifier {
     /** Which stat is modified */
     stat: 'combat' | 'training' | 'initiative' | 'health' | 'targets' | 'actions';
     /** Bonus amount (positive for buff, negative for debuff) */
     bonus: number;
     /** Condition for modifier to apply (defaults to 'always') */
     condition?: AbilityCondition;
     /** Label for UI display (defaults to "[Name]'s Ability") */
     label?: string;
     /** Who receives the modifier (defaults to 'self') */
     target?: BonusTarget;
   }
   ```

4. Add statModifiers field to MercAbility interface (after line 191):
   ```typescript
   /** Unified stat modifiers - single source of truth for stat bonuses */
   statModifiers?: StatModifier[];
   ```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/rules/merc-abilities.ts`</verify>
  <done>StatModifier interface exported, BonusTarget includes 'militia', AbilityCondition includes 'squadMateHigherBase', MercAbility has optional statModifiers field</done>
</task>

<task type="auto">
  <name>Task 2: Add statModifiers to all 18 stat-modifying MERCs</name>
  <files>src/rules/merc-abilities.ts</files>
  <action>
Add statModifiers arrays to each MERC entry in MERC_ABILITIES. Keep existing fields (combatModifiers, squadBonus, etc.) - they remain until Phase 38.

**Equipment-Conditional (8 MERCs):**

bouba (line 207-210):
```typescript
bouba: {
  id: 'bouba',
  combatModifiers: { combatBonus: 1, condition: 'hasHandgun' },
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'hasHandgun' }
  ],
},
```

mayhem (line 212-215):
```typescript
mayhem: {
  id: 'mayhem',
  combatModifiers: { combatBonus: 2, condition: 'hasUzi' },
  statModifiers: [
    { stat: 'combat', bonus: 2, condition: 'hasUzi' }
  ],
},
```

rozeske (line 217-220):
```typescript
rozeske: {
  id: 'rozeske',
  combatModifiers: { combatBonus: 1, condition: 'hasArmor' },
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'hasArmor' }
  ],
},
```

stumpy (line 222-225):
```typescript
stumpy: {
  id: 'stumpy',
  combatModifiers: { combatBonus: 1, condition: 'hasExplosive' },
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'hasExplosive' }
  ],
},
```

vandradi (line 227-230):
```typescript
vandradi: {
  id: 'vandradi',
  combatModifiers: { combatBonus: 1, condition: 'hasMultiTargetWeapon' },
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'hasMultiTargetWeapon' }
  ],
},
```

moe (line 232-235):
```typescript
moe: {
  id: 'moe',
  combatModifiers: { targetBonus: 1, condition: 'hasSmaw' },
  statModifiers: [
    { stat: 'targets', bonus: 1, condition: 'hasSmaw' }
  ],
},
```

dutch (line 237-244):
```typescript
dutch: {
  id: 'dutch',
  combatModifiers: {
    combatBonus: 1,
    initiativeBonus: 1,
    condition: 'hasSwordOrUnarmed',
  },
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'hasSwordOrUnarmed' },
    { stat: 'initiative', bonus: 1, condition: 'hasSwordOrUnarmed' }
  ],
},
```

ra (line 256-259):
```typescript
ra: {
  id: 'ra',
  combatModifiers: { targetBonus: 1, condition: 'hasWeapon' },
  statModifiers: [
    { stat: 'targets', bonus: 1, condition: 'hasWeapon' }
  ],
},
```

**Squad-Conditional Self Bonuses (4 MERCs):**

snake (line 246-254):
```typescript
snake: {
  id: 'snake',
  combatModifiers: {
    combatBonus: 1,
    initiativeBonus: 1,
    trainingBonus: 1,
    condition: 'aloneInSquad',
  },
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'aloneInSquad' },
    { stat: 'initiative', bonus: 1, condition: 'aloneInSquad' },
    { stat: 'training', bonus: 1, condition: 'aloneInSquad' }
  ],
},
```

sarge (line 263-271):
```typescript
sarge: {
  id: 'sarge',
  combatModifiers: {
    combatBonus: 1,
    initiativeBonus: 1,
    trainingBonus: 1,
    condition: 'highestInitInSquad',
  },
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'highestInitInSquad' },
    { stat: 'initiative', bonus: 1, condition: 'highestInitInSquad' },
    { stat: 'training', bonus: 1, condition: 'highestInitInSquad' }
  ],
},
```

tavisto (line 273-281):
```typescript
tavisto: {
  id: 'tavisto',
  combatModifiers: {
    combatBonus: 1,
    initiativeBonus: 1,
    trainingBonus: 1,
    condition: 'womanInSquad',
  },
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'womanInSquad' },
    { stat: 'initiative', bonus: 1, condition: 'womanInSquad' },
    { stat: 'training', bonus: 1, condition: 'womanInSquad' }
  ],
},
```

haarg (line 283-288) - Uses special condition:
```typescript
haarg: {
  id: 'haarg',
  // Special: +1 to any skill someone in squad has higher
  // Implemented in elements.ts CombatantModel.updateHaargBonus()
  passive: {},
  statModifiers: [
    { stat: 'combat', bonus: 1, condition: 'squadMateHigherBase' },
    { stat: 'initiative', bonus: 1, condition: 'squadMateHigherBase' },
    { stat: 'training', bonus: 1, condition: 'squadMateHigherBase' }
  ],
},
```

**Squad-Wide Bonuses (2 MERCs):**

tack (line 292-300):
```typescript
tack: {
  id: 'tack',
  isFemale: true,
  squadBonus: {
    initiative: 2,
    condition: 'highestInitInSquad',
    appliesTo: 'allSquad',
  },
  statModifiers: [
    { stat: 'initiative', bonus: 2, condition: 'highestInitInSquad', target: 'allSquad' }
  ],
},
```

valkyrie (line 302-310):
```typescript
valkyrie: {
  id: 'valkyrie',
  isFemale: true,
  squadBonus: {
    initiative: 1,
    condition: 'always',
    appliesTo: 'squadMates',
  },
  statModifiers: [
    { stat: 'initiative', bonus: 1, target: 'squadMates' }
  ],
},
```

**Passive Always-On (3 MERCs):**

shooter (line 516-519):
```typescript
shooter: {
  id: 'shooter',
  passive: { extraCombat: 3 },
  statModifiers: [
    { stat: 'combat', bonus: 3 }
  ],
},
```

juicer (line 445-448):
```typescript
juicer: {
  id: 'juicer',
  passive: { extraHealth: 2 },
  statModifiers: [
    { stat: 'health', bonus: 2 }
  ],
},
```

ewok (line 433-437):
```typescript
ewok: {
  id: 'ewok',
  isFemale: true,
  passive: { extraActions: 1 },
  statModifiers: [
    { stat: 'actions', bonus: 1 }
  ],
},
```

**Combat-Only / Special Target (2 MERCs):**

max (line 319-328):
```typescript
max: {
  id: 'max',
  // Max's ability: "Opposing MERCs have -1 to all skills when attacking his squad"
  // Training doesn't apply in combat, so we apply -1 combat and -1 initiative
  enemyDebuff: {
    combat: -1,
    initiative: -1,
    appliesTo: 'enemyMercs',
  },
  statModifiers: [
    { stat: 'combat', bonus: -1, target: 'enemyMercs', label: "Max's Intimidation" },
    { stat: 'initiative', bonus: -1, target: 'enemyMercs', label: "Max's Intimidation" }
  ],
},
```

walter (line 312-315):
```typescript
walter: {
  id: 'walter',
  passive: { militiaInitiativeBonus: 2 },
  statModifiers: [
    { stat: 'initiative', bonus: 2, target: 'militia', label: "Walter's Leadership" }
  ],
},
```

**Note:** Vulture (ignoresInitiativePenalties) is NOT a stat modifier - it's a behavior flag. Do NOT add statModifiers to Vulture.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/rules/merc-abilities.ts` and run existing tests: `npm test`</verify>
  <done>All 18 stat-modifying MERCs have statModifiers arrays. Vulture remains unchanged (behavior flag, not stat modifier).</done>
</task>

<task type="auto">
  <name>Task 3: Add getActiveStatModifiers helper function</name>
  <files>src/rules/merc-abilities.ts</files>
  <action>
Add getActiveStatModifiers function at end of file (after line 847):

```typescript
/**
 * Context required for evaluating stat modifier conditions.
 * Passed to getActiveStatModifiers to determine which modifiers are active.
 */
export interface StatModifierContext {
  /** Equipment currently equipped (for hasWeapon, hasUzi, etc.) */
  equipment?: {
    weapon?: { name: string; type?: string; targets?: number };
    armor?: { name: string };
    accessory?: { name: string };
  };
  /** Squad mates (for squad-conditional abilities) */
  squadMates?: Array<{
    combatantId: string;
    baseCombat: number;
    baseInitiative: number;
    baseTraining: number;
  }>;
  /** Is this MERC alone in their squad? */
  isAlone?: boolean;
  /** Does squad have a female MERC? */
  hasWomanInSquad?: boolean;
  /** Is this MERC the highest initiative in squad? */
  isHighestInitInSquad?: boolean;
}

/**
 * Evaluate if an ability condition is met.
 * Returns true if the condition is satisfied given the context.
 */
function evaluateCondition(condition: AbilityCondition | undefined, context: StatModifierContext): boolean {
  if (!condition || condition === 'always') return true;

  const { equipment, squadMates, isAlone, hasWomanInSquad, isHighestInitInSquad } = context;

  switch (condition) {
    case 'hasWeapon':
      return !!equipment?.weapon;
    case 'hasHandgun':
      return equipment?.weapon?.type === 'handgun';
    case 'hasUzi':
      return equipment?.weapon?.name?.toLowerCase().includes('uzi') ?? false;
    case 'hasArmor':
      return !!equipment?.armor;
    case 'hasAccessory':
      return !!equipment?.accessory;
    case 'hasExplosive':
      return equipment?.weapon?.type === 'grenade' || equipment?.weapon?.type === 'mortar';
    case 'hasMultiTargetWeapon':
      return (equipment?.weapon?.targets ?? 0) > 0;
    case 'hasSmaw':
      return equipment?.weapon?.name?.toLowerCase().includes('smaw') ?? false;
    case 'hasSwordOrUnarmed':
      return !equipment?.weapon || equipment?.weapon?.type === 'sword';
    case 'aloneInSquad':
      return isAlone ?? false;
    case 'womanInSquad':
      return hasWomanInSquad ?? false;
    case 'highestInitInSquad':
      return isHighestInitInSquad ?? false;
    case 'squadMateHigherBase':
      // This is Haarg-specific: returns true if ANY squad mate has higher base stat
      // The actual check happens per-stat in the calculation layer (Phase 38)
      // Here we just return true to indicate the modifier exists and should be evaluated
      return (squadMates?.length ?? 0) > 0;
    default:
      return false;
  }
}

/**
 * Get active stat modifiers for a MERC given the current context.
 * Returns array of StatModifier objects that are currently active.
 *
 * @param combatantId - The MERC's ID
 * @param context - Current game context for condition evaluation
 * @returns Array of active StatModifier objects (empty if none or MERC not found)
 */
export function getActiveStatModifiers(
  combatantId: string,
  context: StatModifierContext = {}
): StatModifier[] {
  const ability = MERC_ABILITIES[combatantId];
  if (!ability?.statModifiers) return [];

  return ability.statModifiers.filter(mod =>
    evaluateCondition(mod.condition, context)
  );
}

/**
 * Get all stat modifiers for a MERC (ignoring conditions).
 * Useful for displaying "potential" bonuses in UI.
 */
export function getAllStatModifiers(combatantId: string): StatModifier[] {
  const ability = MERC_ABILITIES[combatantId];
  return ability?.statModifiers ?? [];
}
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit src/rules/merc-abilities.ts`
2. Existing tests pass: `npm test`
3. Manual verification in REPL:
   ```
   node -e "const m = require('./src/rules/merc-abilities'); console.log(m.getActiveStatModifiers('bouba', { equipment: { weapon: { name: 'Handgun', type: 'handgun' } } }))"
   ```
   Should output array with combat +1 modifier.
  </verify>
  <done>
- getActiveStatModifiers(combatantId, context) returns active modifiers based on conditions
- getAllStatModifiers(combatantId) returns all modifiers ignoring conditions
- evaluateCondition() handles all 13 condition types
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
1. **Type Check:** `npx tsc --noEmit` passes with no errors
2. **Existing Tests:** `npm test` passes (no behavioral changes in this phase)
3. **Interface Verification:**
   - StatModifier interface has: stat, bonus, condition?, label?, target?
   - BonusTarget includes 'militia'
   - AbilityCondition includes 'squadMateHigherBase'
4. **MERC Coverage:** Verify all 18 MERCs have statModifiers:
   - Equipment-conditional: bouba, mayhem, rozeske, stumpy, vandradi, dutch, moe, ra
   - Squad-conditional: snake, sarge, tavisto, haarg
   - Squad-wide: tack, valkyrie
   - Passive: shooter, juicer, ewok
   - Special target: max, walter
5. **Function Test:** getActiveStatModifiers returns correct modifiers
</verification>

<success_criteria>
- [ ] StatModifier interface exported from merc-abilities.ts
- [ ] All 18 stat-modifying MERCs have statModifiers arrays
- [ ] getActiveStatModifiers() returns correct modifiers for any MERC
- [ ] Existing tests still pass (no behavioral changes)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/37-extend-ability-registry/37-01-SUMMARY.md`
</output>
