---
phase: 16-abilities-for-controller
plan: 01
type: execute
---

<objective>
Make merc special abilities (docHeal, feedbackDiscard, squidheadDisarm/Arm, hagnessDraw) available to whoever controls the merc, not just rebel players.

Purpose: Currently these abilities only work for rebels. If the dictator hires Doc, Feedback, Squidhead, or Hagness, they should be able to use their abilities too.

Output: All five ability actions work for both rebel and dictator controllers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@src/rules/actions/rebel-equipment.ts - Contains docHeal, feedbackDiscard, squidheadDisarm, squidheadArm, hagnessDraw actions
@src/rules/flow.ts - Game flow with rebel and dictator action steps
@src/rules/game.ts - MERCPlayer class with team property that works for both roles

**Current state:**
- All five actions have `'is rebel player': (ctx) => game.isRebelPlayer(ctx.player)` condition
- These actions are registered in rebel action step (flow.ts:375-391) but NOT in dictator action step (flow.ts:660-673)
- MERCPlayer.team works for both rebels and dictators, returning living mercs

**Pattern to follow:**
- Replace `isRebelPlayer` check with a check that the current player has the relevant merc on their team
- Both rebel and dictator players have a `team` property that returns living mercs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update action conditions to work for any controller</name>
  <files>src/rules/actions/rebel-equipment.ts</files>
  <action>
Update all five ability actions to check if the current player (rebel OR dictator) has the relevant merc:

1. **docHeal** (line ~617-629):
   - Remove `'is rebel player'` condition
   - Update `'has living Doc with damaged squad members'` to work with any MERCPlayer:
     - Get player as MERCPlayer (not RebelPlayer)
     - Find Doc on player.team (works for both roles)
     - Rest of logic stays same (getSquadContaining, check damage)

2. **feedbackDiscard** (line ~671-688):
   - Remove `'is rebel player'` condition
   - Update `'has living Feedback with actions'` to work with MERCPlayer
   - Update execute to cast player as MERCPlayer

3. **squidheadDisarm** (line ~741-756):
   - Remove `'is rebel player'` condition
   - Update condition to work with MERCPlayer
   - Update execute to cast player as MERCPlayer

4. **squidheadArm** (line ~806-818):
   - Remove `'is rebel player'` condition
   - Update condition to work with MERCPlayer
   - Update execute to cast player as MERCPlayer

5. **hagnessDraw** (line ~910-913):
   - Remove `'is rebel player'` condition
   - Update `'has living Hagness with actions'` to work with MERCPlayer
   - Update execute to cast player as MERCPlayer

For each action, the pattern is:
```typescript
// Before:
'is rebel player': (ctx) => game.isRebelPlayer(ctx.player),
'has living Doc': (ctx) => {
  if (!game.isRebelPlayer(ctx.player)) return false;
  const player = ctx.player as RebelPlayer;
  ...
}

// After:
'has living Doc': (ctx) => {
  const player = ctx.player as MERCPlayer;
  const doc = player.team.find(m => m.mercId === 'doc' && !m.isDead);
  ...
}
```

Import MERCPlayer at the top if not already imported.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>All five action conditions work with MERCPlayer instead of requiring isRebelPlayer</done>
</task>

<task type="auto">
  <name>Task 2: Add ability actions to dictator action step</name>
  <files>src/rules/flow.ts</files>
  <action>
Add the five ability actions to the dictator-merc-action step around line 660-673.

Current dictator actions:
```typescript
actions: [
  'move',
  'explore',
  'train',
  'reEquip',
  'dropEquipment',
  'hospital',
  'armsDealer',
  'repairKit',
  'mortar',
  'splitSquad',
  'mergeSquads',
  'endTurn',
],
```

Add after `hospital`:
```typescript
'docHeal',        // Doc's free heal ability
'feedbackDiscard', // Feedback discard retrieval
'squidheadDisarm', // Squidhead disarm mines
'squidheadArm',    // Squidhead arm mines
'hagnessDraw',     // Hagness draw equipment
```

This matches the same order used in rebel-action step (lines 387-391).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Dictator action step includes all five ability actions</done>
</task>

<task type="auto">
  <name>Task 3: Verify existing tests still pass</name>
  <files>tests/</files>
  <action>
Run the test suite to ensure existing ability tests still pass.

The changes are backward compatible since:
- Rebel players still have access to all abilities (they have the team property)
- The logic for finding mercs and squads is unchanged
- Only the player type check is broadened

Run: `npm test`

If any tests fail, investigate and fix. Most likely causes would be:
- Test mocking that assumes RebelPlayer type
- Missing MERCPlayer import
  </action>
  <verify>`npm test` passes with no failures related to these abilities</verify>
  <done>All existing tests pass</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` succeeds without errors
- [ ] `npm test` passes
- [ ] docHeal, feedbackDiscard, squidheadDisarm, squidheadArm, hagnessDraw conditions don't require isRebelPlayer
- [ ] All five actions listed in dictator-merc-action step in flow.ts
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- No test regressions
- Dictator can use Doc/Feedback/Squidhead/Hagness abilities if they hire those mercs
</success_criteria>

<output>
After completion, create `.planning/phases/16-abilities-for-controller/16-01-SUMMARY.md`
</output>
