---
phase: 59-militia-placement-abilities
plan: 02
type: execute
wave: 2
depends_on: ["59-01"]
files_modified:
  - src/rules/game.ts
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
autonomous: true

must_haves:
  truths:
    - "Mussolini adds militia equal to rebel count to a chosen controlled sector each turn"
    - "After placing, Mussolini can optionally spread militia from that sector to adjacent sectors"
    - "Spread step is optional - dictator can skip it"
    - "AI Mussolini places and spreads militia automatically"
    - "Combat triggers when militia placed or spread to rebel-occupied sectors"
  artifacts:
    - path: "src/rules/dictator-abilities.ts"
      provides: "applyMussoliniTurnAbility AI function"
      contains: "applyMussoliniTurnAbility"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "createMussoliniBonusMilitiaAction and createMussoliniSpreadMilitiaAction"
      contains: "createMussoliniSpreadMilitiaAction"
    - path: "src/rules/game.ts"
      provides: "pendingMussoliniSpread state field"
      contains: "pendingMussoliniSpread"
    - path: "src/rules/flow.ts"
      provides: "Mussolini spread loop"
      contains: "mussolini-spread"
  key_links:
    - from: "src/rules/dictator-abilities.ts"
      to: "applyDictatorTurnAbilities switch"
      via: "case 'mussolini' in switch statement"
      pattern: "case 'mussolini'"
    - from: "src/rules/actions/index.ts"
      to: "registerAllActions"
      via: "createMussoliniBonusMilitiaAction and createMussoliniSpreadMilitiaAction"
      pattern: "createMussolini"
    - from: "src/rules/flow.ts"
      to: "dictator-ability actionStep"
      via: "mussoliniBonusMilitia in actions array"
      pattern: "mussoliniBonusMilitia"
---

<objective>
Implement Mussolini's per-turn militia placement ability: add militia equal to rebel count to a chosen controlled sector, then optionally spread militia from that sector to adjacent sectors.

Purpose: Mussolini's two-step ability (place then spread) is unique among the militia abilities. The spread step uses a loop pattern similar to Mao/Lockdown, with an explicit "done spreading" skip option.
Output: Working Mussolini militia placement and spread for both AI and human paths, wired into flow, actions, and UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-militia-placement-abilities/59-RESEARCH.md
@.planning/phases/59-militia-placement-abilities/59-01-SUMMARY.md

Key source files (read these fresh - they were modified by Plan 01):
@src/rules/dictator-abilities.ts
@src/rules/actions/dictator-actions.ts
@src/rules/actions/index.ts
@src/rules/flow.ts
@src/rules/game.ts
@src/ui/components/DictatorPanel.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mussolini AI path and game state</name>
  <files>src/rules/game.ts, src/rules/dictator-abilities.ts</files>
  <action>
1. In `src/rules/game.ts`, add a `pendingMussoliniSpread` state field following the pattern of `pendingLockdownMilitia`:
   ```typescript
   pendingMussoliniSpread: {
     sourceSectorId: string;
     remaining: number;  // militia available to move from source to adjacent
   } | null = null;
   ```
   Add getter: `get hasMussoliniSpreadPending(): boolean`.

2. In `src/rules/dictator-abilities.ts`, add `applyMussoliniTurnAbility(game: MERCGame): DictatorAbilityResult`:
   - Guard: combatantId !== 'mussolini'
   - Count: `game.rebelCount` (number of rebel players, NOT rebel sectors)
   - If count is 0, message and return
   - Get sectors the dictator controls: sectors where `s.dictatorMilitia > 0` OR the dictator has MERCs present (use `game.getDictatorMercsInSector(s).length > 0`). Also include the dictator's base sector if revealed.
   - If no controlled sectors, message and return
   - AI picks target sector using `selectMilitiaPlacementSector(game, controlledSectors, 'dictator')`
   - Place militia: `targetSector.addDictatorMilitia(rebelCount)` (standard cap, no bypass)
   - Message placement
   - AI spread: Get adjacent sectors via `game.getAdjacentSectors(targetSector)`. For each adjacent sector with room, move 1 militia from source to adjacent (source `removeDictatorMilitia(1)`, target `addDictatorMilitia(1)`). Check for rebel presence on each target and `queuePendingCombat` if found. Stop when no militia to move or no more adjacent sectors with room. AI spreads opportunistically - prioritize adjacent rebel sectors for combat, then neutral, then skip.
   - Return result

3. Add `case 'mussolini': applyMussoliniTurnAbility(game); break;` to the `applyDictatorTurnAbilities` switch.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>applyMussoliniTurnAbility exists and is called from dispatcher. pendingMussoliniSpread field exists on MERCGame.</done>
</task>

<task type="auto">
  <name>Task 2: Mussolini human actions, flow, and registration</name>
  <files>src/rules/actions/dictator-actions.ts, src/rules/actions/index.ts, src/rules/flow.ts, src/ui/components/DictatorPanel.vue</files>
  <action>
1. In `src/rules/actions/dictator-actions.ts`, add TWO actions:

   **a) `createMussoliniBonusMilitiaAction`** - Step 1: Place militia on controlled sector
   - Action name: `'mussoliniBonusMilitia'`
   - Prompt: `"Mussolini's Ability: Add militia to a controlled sector"`
   - Conditions: is dictator, combatantId === 'mussolini', not AI, `game.pendingMussoliniSpread == null` (hasn't placed yet this turn)
   - `chooseFrom<string>('targetSector')`: Filter to sectors where dictator has presence (dictatorMilitia > 0 OR dictator MERCs present), map to sectorName
   - Execute: Count `game.rebelCount`, place militia via `sector.addDictatorMilitia(rebelCount)`, set up spread state: `game.pendingMussoliniSpread = { sourceSectorId: sector.sectorId, remaining: sector.dictatorMilitia }` (the remaining is the TOTAL militia in that sector that can be spread, not just what was placed). Message the placement. Check for combat and queue if rebels present.

   IMPORTANT: The `remaining` for spread should be the total dictator militia in the source sector AFTER placement. The dictator can choose to move ANY militia from the source, not just the newly placed ones.

   **b) `createMussoliniSpreadMilitiaAction`** - Step 2: Spread from source to adjacent
   - Action name: `'mussoliniSpreadMilitia'`
   - Prompt: `"Mussolini: Spread militia to adjacent sectors (or skip)"`
   - Conditions: is dictator, combatantId === 'mussolini', not AI, `game.pendingMussoliniSpread != null && game.pendingMussoliniSpread.remaining > 0`
   - `chooseFrom<string>('targetSector')`: Get source sector from `game.pendingMussoliniSpread.sourceSectorId`, get adjacent sectors via `game.getAdjacentSectors(sourceSector)`, filter to those with room (`dictatorMilitia < 10`), map to sectorName. ALSO add a `'Done spreading'` option at the beginning of the choices array.
   - `chooseFrom<string>('amount')`: If previous selection was 'Done spreading', return `['0']`. Otherwise return choices from 1 to `Math.min(remaining, 10 - targetSector.dictatorMilitia, sourceSector.dictatorMilitia)`. Since we don't have the target resolved, use `Math.min(game.pendingMussoliniSpread?.remaining ?? 0, 10)`.
   - Execute: If targetSector is 'Done spreading', clear `game.pendingMussoliniSpread = null` and return success. Otherwise: find source and target sectors, compute actual amount respecting both source availability and target cap, call `sourceSector.removeDictatorMilitia(amount)` and `targetSector.addDictatorMilitia(amount)`, decrement `pending.remaining` by amount, check for combat on target. If source sector has 0 militia left or remaining is 0, clear pending.

2. In `src/rules/flow.ts`:
   - In the execute step before dictator-ability (where Mao init was added in Plan 01), add NO initialization for Mussolini. The first action (mussoliniBonusMilitia) sets up the pending state itself.
   - Add `'mussoliniBonusMilitia'` to the dictator-ability actionStep actions array
   - After the Mao distribution loop (added in Plan 01), add a Mussolini spread loop:
     ```typescript
     loop({
       name: 'mussolini-spread',
       while: () => game.pendingMussoliniSpread != null && game.pendingMussoliniSpread.remaining > 0 && !game.isFinished(),
       maxIterations: 50,
       do: actionStep({
         name: 'mussolini-spread-militia',
         actions: ['mussoliniSpreadMilitia'],
         prompt: "Mussolini: Move militia to adjacent sectors (or done)",
         skipIf: () => game.isFinished() || game.pendingMussoliniSpread == null || game.pendingMussoliniSpread.remaining <= 0,
       }),
     }),
     ```
   - Add `'mussoliniSpreadMilitia'` to the SAME loop's actions array (NOT to the main dictator-ability step - the spread loop handles it)

3. In `src/rules/actions/index.ts`:
   - Import both: `createMussoliniBonusMilitiaAction, createMussoliniSpreadMilitiaAction`
   - Register both after Mao's registration

4. In `src/ui/components/DictatorPanel.vue`:
   - Add `'mussoliniBonusMilitia'` and `'mussoliniSpreadMilitia'` to `dictatorSpecificActions` array
   - Add both action names to `isSelectingSector` check with `sel.name === 'targetSector'`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Start a game as Mussolini (human), verify the two-step ability appears: first place on controlled sector, then optional spread to adjacent sectors with "Done spreading" skip option.</verify>
  <done>Human Mussolini sees step 1 (place on controlled sector), then step 2 loop (spread to adjacent or skip). Spread is optional via "Done spreading" choice. Combat triggers on rebel-occupied sectors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. AI game with Mussolini: militia placed on controlled sector equal to rebel count, then some spread to adjacent sectors
3. Human game with Mussolini: step 1 shows controlled sectors, step 2 shows adjacent sectors + "Done spreading" option, loop continues until done or no militia left
4. Spread moves militia from source (removeDictatorMilitia) to target (addDictatorMilitia) - does NOT create new militia
5. Combat triggers when militia placed or spread to rebel-occupied sectors
</verification>

<success_criteria>
- Mussolini AI places militia equal to rebel count on a controlled sector and spreads to adjacent
- Mussolini human path presents two-step interactive flow: place then spread
- Spread is optional (dictator can choose "Done spreading" immediately)
- Spread moves existing militia, does not create new ones
- Standard 10 per sector cap enforced
- Combat triggers on rebel-occupied sectors
- All registrations complete (index.ts, flow.ts, DictatorPanel.vue)
</success_criteria>

<output>
After completion, create `.planning/phases/59-militia-placement-abilities/59-02-SUMMARY.md`
</output>
