---
phase: 59-militia-placement-abilities
plan: 03
type: execute
wave: 3
depends_on: ["59-02"]
files_modified:
  - src/rules/game.ts
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
autonomous: true

must_haves:
  truths:
    - "Pol Pot adds militia equal to rebel-controlled sector count to any one rebel sector each turn (max 10 per sector)"
    - "If dictator loses the combat triggered by this ability (rebel victory only, not retreat), Pol Pot hires 1 random MERC"
    - "Dictator CHOOSES which squad to place the hired MERC in (interactive, not auto-place)"
    - "AI Pol Pot places militia and auto-hires on combat loss"
  artifacts:
    - path: "src/rules/dictator-abilities.ts"
      provides: "applyPolpotTurnAbility AI function"
      contains: "applyPolpotTurnAbility"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "createPolpotBonusMilitiaAction and createPolpotBonusHireAction"
      contains: "createPolpotBonusHireAction"
    - path: "src/rules/game.ts"
      provides: "lastAbilityCombatOutcome tracking field"
      contains: "lastAbilityCombatOutcome"
    - path: "src/rules/flow.ts"
      provides: "Post-combat Pol Pot hire step"
      contains: "polpot-bonus-hire"
  key_links:
    - from: "src/rules/flow.ts"
      to: "combat resolution"
      via: "lastAbilityCombatOutcome set before clearActiveCombat"
      pattern: "lastAbilityCombatOutcome"
    - from: "src/rules/flow.ts"
      to: "post-combat hire step"
      via: "execute step after combat resolution checks lastAbilityCombatOutcome"
      pattern: "polpotBonusHire"
---

<objective>
Implement Pol Pot's per-turn militia placement ability: add militia equal to rebel-controlled sector count to any one rebel sector (max 10 per sector), and hire 1 random MERC if the dictator loses the resulting combat. The MERC hire is interactive - dictator chooses the squad.

Purpose: Pol Pot is the most complex militia ability because it has a conditional post-combat MERC hire. This requires tracking combat outcomes across the flow boundary.
Output: Working Pol Pot militia placement with conditional MERC hire for both AI and human paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-militia-placement-abilities/59-RESEARCH.md
@.planning/phases/59-militia-placement-abilities/59-01-SUMMARY.md
@.planning/phases/59-militia-placement-abilities/59-02-SUMMARY.md

Key source files (read these fresh - modified by Plans 01 and 02):
@src/rules/dictator-abilities.ts
@src/rules/actions/dictator-actions.ts
@src/rules/actions/index.ts
@src/rules/flow.ts
@src/rules/game.ts
@src/rules/combat.ts (for combat outcome tracking - look at executeCombat and clearActiveCombat)
@src/ui/components/DictatorPanel.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Combat outcome tracking and Pol Pot AI path</name>
  <files>src/rules/game.ts, src/rules/dictator-abilities.ts, src/rules/flow.ts</files>
  <action>
1. In `src/rules/game.ts`, add a combat outcome tracking field:
   ```typescript
   // Track the outcome of combat triggered by a dictator ability (for Pol Pot's conditional hire)
   lastAbilityCombatOutcome: {
     rebelVictory: boolean;
     sectorId: string;
   } | null = null;
   ```

2. In `src/rules/flow.ts`, find the combat resolution flow for dictator abilities (the `combatResolutionFlow(game, 'kim-militia-combat')` at approximately line 1012, though the exact line may have shifted due to Plans 01/02 additions). BEFORE the `clearCombatAnimations` step in this combat resolution sub-flow (or right after combat completes but before activeCombat is cleared), add an execute step that captures the outcome:

   IMPORTANT: The combat resolution flow is a reusable sub-flow. Rather than modifying it internally, add an execute step AFTER the combat resolution flow returns but BEFORE the next step:
   ```typescript
   // Capture combat outcome for Pol Pot's conditional hire
   execute(() => {
     if (game.isFinished()) return;
     const dictator = game.dictatorPlayer?.dictator;
     if (dictator?.combatantId !== 'polpot') return;
     // After combat resolution, check if there was a rebel victory
     // The activeCombat will have been cleared by now, so check sector control:
     // If the sector where Pol Pot placed militia is still rebel-controlled, dictator lost
     if (game._polpotTargetSectorId) {
       const sector = game.getSector(game._polpotTargetSectorId);
       if (sector) {
         // Check if any rebel controls this sector
         const rebelControls = game.rebelPlayers.some(r =>
           game.getControlledSectors(r).some(s => s.sectorId === sector.sectorId)
         );
         if (rebelControls) {
           game.lastAbilityCombatOutcome = { rebelVictory: true, sectorId: sector.sectorId };
         }
       }
       game._polpotTargetSectorId = null;
     }
   }),
   ```

   ALTERNATIVELY (and simpler): Instead of tracking via sector control, use a dedicated `_polpotTargetSectorId` field AND check the combat outcome directly. Read `src/rules/combat.ts` to understand how `activeCombat` outcome is determined. The approach depends on timing -- read the combat resolution flow carefully to find where combat outcome is available.

   The SIMPLEST approach: Add `_polpotTargetSectorId: string | null = null` to game.ts. When Pol Pot places militia (in both AI and human paths), set this field. After the combat resolution flow completes, check if rebels still control that sector. If yes, dictator lost.

3. In `src/rules/game.ts`, add:
   ```typescript
   // Pol Pot: track which sector the ability targeted for post-combat loss detection
   _polpotTargetSectorId: string | null = null;
   ```

4. In `src/rules/dictator-abilities.ts`, add `applyPolpotTurnAbility(game: MERCGame): DictatorAbilityResult`:
   - Guard: combatantId !== 'polpot'
   - Count rebel-controlled sectors across all rebels (same loop as Kim/Mao)
   - If count is 0, message and return
   - Get rebel-controlled sectors: use `getRebelControlledSectors(game)` from ai-helpers
   - Filter to sectors with room (`dictatorMilitia < Sector.MAX_MILITIA_PER_SIDE`)
   - If no valid targets, message and return
   - AI picks target using `selectMilitiaPlacementSector(game, rebelSectors, 'rebel')`
   - Place militia: `sector.addDictatorMilitia(rebelSectorCount)` (NO bypass cap - standard 10 max)
   - Set `game._polpotTargetSectorId = sector.sectorId` for post-combat tracking
   - Message placement
   - Queue combat: always triggers since target is a rebel sector. Find the rebel who controls it and `queuePendingCombat(game, sector, rebel, false)`
   - Return result

5. Add `case 'polpot': applyPolpotTurnAbility(game); break;` to `applyDictatorTurnAbilities` switch.

6. In the flow.ts execute step after combat resolution (the one added above), also handle the AI Pol Pot hire:
   ```typescript
   if (game.dictatorPlayer?.isAI && game.lastAbilityCombatOutcome?.rebelVictory) {
     // AI auto-hire: same pattern as Gaddafi AI hire
     const merc = game.drawMerc();
     if (merc) {
       // Place in primary squad if room, else secondary
       const squad = !game.dictatorPlayer.primarySquad.isFull
         ? game.dictatorPlayer.primarySquad
         : game.dictatorPlayer.secondarySquad;
       merc.putInto(squad);
       equipNewHire(game, merc, 'Weapon');
       const sectorId = squad.sectorId;
       if (sectorId) {
         const sector = game.getSector(sectorId);
         if (sector) {
           emitMapCombatantEntries(game, [buildMapCombatantEntry(merc, sector)]);
         }
       }
       game.message(`Pol Pot lost combat - hired ${merc.combatantName} as consolation`);
     }
     game.lastAbilityCombatOutcome = null;
   }
   ```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>applyPolpotTurnAbility exists, combat outcome tracking works via _polpotTargetSectorId + sector control check, AI path auto-hires on combat loss.</done>
</task>

<task type="auto">
  <name>Task 2: Pol Pot human actions, flow hire step, and registration</name>
  <files>src/rules/actions/dictator-actions.ts, src/rules/actions/index.ts, src/rules/flow.ts, src/ui/components/DictatorPanel.vue</files>
  <action>
1. In `src/rules/actions/dictator-actions.ts`, add TWO actions:

   **a) `createPolpotBonusMilitiaAction`** - Place militia on a rebel sector
   - Action name: `'polpotBonusMilitia'`
   - Prompt: `"Pol Pot's Ability: Place militia on a rebel sector"`
   - Conditions: is dictator, combatantId === 'polpot', not AI
   - `chooseFrom<string>('targetSector')`: Get all rebel-controlled sectors across all rebels. Filter to those with `dictatorMilitia < Sector.MAX_MILITIA_PER_SIDE`. Map to sectorName. Use `getRebelControlledSectors(game)` if available as import, or iterate rebels and collect controlled sectors.
   - Execute: Count rebel-controlled sectors, find sector by name, place militia via `sector.addDictatorMilitia(rebelSectorCount)` (no bypass), set `game._polpotTargetSectorId = sector.sectorId`, find the rebel who controls this sector and `queuePendingCombat`, message result.

   **b) `createPolpotBonusHireAction`** - Conditional MERC hire after combat loss (human interactive)
   - Action name: `'polpotBonusHire'`
   - Prompt: `"Pol Pot: Hire a MERC (combat loss consolation)"`
   - Conditions: is dictator, combatantId === 'polpot', not AI, `game.lastAbilityCombatOutcome?.rebelVictory === true`
   - Follow the Gaddafi hire pattern (line 842) closely:
     - `chooseFrom<string>('selectedMerc')`: Draw 1 MERC using the global cached value pattern (DRAWN_MERC_KEY = '_polpot_drawn_merc'). Return the MERC name as the only choice.
     - `chooseFrom<string>('targetSquad')`: Present squad choices: 'Primary Squad' and 'Secondary Squad' (filter to squads that aren't full). This is the USER DECISION from the planning context - dictator CHOOSES which squad.
     - `chooseFrom<string>('equipmentType')`: 'Weapon', 'Armor', 'Accessory'
     - Execute: Find the drawn MERC by cached ID, put into chosen squad, call `equipNewHire(game, merc, equipType)`, emit map combatant entry animation, clear `game.lastAbilityCombatOutcome = null`, clear the cached MERC value, message the hire.

2. In `src/rules/flow.ts`, after the combat resolution flow and the execute step that sets lastAbilityCombatOutcome (added in Task 1), add a human Pol Pot hire action step:
   ```typescript
   // Pol Pot: Human conditional hire after combat loss
   actionStep({
     name: 'polpot-bonus-hire',
     actions: ['polpotBonusHire'],
     prompt: "Pol Pot lost combat - hire a consolation MERC",
     skipIf: () => game.isFinished() ||
       game.dictatorPlayer?.dictator?.combatantId !== 'polpot' ||
       game.dictatorPlayer?.isAI === true ||
       !game.lastAbilityCombatOutcome?.rebelVictory,
   }),
   // Clear outcome after human hire step (whether it ran or not)
   execute(() => {
     if (game.lastAbilityCombatOutcome) {
       game.lastAbilityCombatOutcome = null;
     }
   }),
   ```
   - Add `'polpotBonusMilitia'` to the main dictator-ability actionStep actions array

3. In `src/rules/actions/index.ts`:
   - Import both: `createPolpotBonusMilitiaAction, createPolpotBonusHireAction`
   - Register both

4. In `src/ui/components/DictatorPanel.vue`:
   - Add `'polpotBonusMilitia'` and `'polpotBonusHire'` to `dictatorSpecificActions` array
   - Add `'polpotBonusMilitia'` to `isSelectingSector` check with `sel.name === 'targetSector'`
   - For `'polpotBonusHire'`, check if it needs special UI handling for squad selection. If the existing chooseFrom renders correctly in the DictatorPanel's default selection UI, no additional isSelecting* check is needed. If it uses sector selection for placement, add to isSelectingSector. Based on the Gaddafi pattern, the chooseFrom selections render in the default DictatorPanel choice UI, so likely no additional isSelecting check needed for polpotBonusHire.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Start a game as Pol Pot (human), verify: militia placement shows rebel sectors only, combat triggers, and if rebels win the combat, the hire step appears with squad choice.</verify>
  <done>Human Pol Pot places militia on rebel sectors, combat resolves, and on rebel victory the hire action presents squad selection. Retreat does NOT trigger hire. All registrations complete.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. AI game with Pol Pot: militia placed on rebel sector, combat triggers, MERC hired on rebel victory
3. Human game with Pol Pot: sector selection shows rebel-controlled sectors only, combat triggers, hire step appears only on rebel victory with squad choice
4. Retreat (not rebel victory) does NOT trigger the hire
5. Max 10 militia per sector enforced (standard cap)
6. No combat = no hire (Pol Pot only hires on combat LOSS)
</verification>

<success_criteria>
- Pol Pot AI places militia equal to rebel-controlled sector count on any one rebel sector
- Pol Pot human path presents rebel sector choices with standard cap enforcement
- Combat always triggers (target is always a rebel sector)
- Rebel victory (only) triggers conditional MERC hire
- Retreat does NOT count as a loss
- Human dictator chooses squad for hired MERC (interactive)
- AI auto-places hired MERC in available squad
- All registrations complete (index.ts, flow.ts, DictatorPanel.vue)
</success_criteria>

<output>
After completion, create `.planning/phases/59-militia-placement-abilities/59-03-SUMMARY.md`
</output>
