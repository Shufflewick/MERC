---
phase: 59-militia-placement-abilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/game.ts
  - src/rules/dictator-abilities.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/actions/index.ts
  - src/rules/flow.ts
  - src/ui/components/DictatorPanel.vue
autonomous: true

must_haves:
  truths:
    - "Mao places militia equal to rebel-controlled sector count into wilderness sectors each turn"
    - "Human Mao player can distribute militia across multiple wilderness sectors interactively"
    - "AI Mao distributes militia across wilderness sectors automatically"
    - "Placing militia on rebel-occupied wilderness triggers combat"
  artifacts:
    - path: "src/rules/dictator-abilities.ts"
      provides: "applyMaoTurnAbility AI function"
      contains: "applyMaoTurnAbility"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "createMaoBonusMilitiaAction human action"
      contains: "createMaoBonusMilitiaAction"
    - path: "src/rules/game.ts"
      provides: "pendingMaoMilitia state field"
      contains: "pendingMaoMilitia"
    - path: "src/rules/flow.ts"
      provides: "Mao militia distribution loop and action registration"
      contains: "mao-militia-distribution"
  key_links:
    - from: "src/rules/dictator-abilities.ts"
      to: "applyDictatorTurnAbilities switch"
      via: "case 'mao' in switch statement"
      pattern: "case 'mao'"
    - from: "src/rules/actions/index.ts"
      to: "registerAllActions"
      via: "game.registerAction(createMaoBonusMilitiaAction(game))"
      pattern: "createMaoBonusMilitiaAction"
    - from: "src/rules/flow.ts"
      to: "dictator-ability actionStep"
      via: "maoBonusMilitia in actions array"
      pattern: "maoBonusMilitia"
    - from: "src/ui/components/DictatorPanel.vue"
      to: "dictatorSpecificActions and isSelectingSector"
      via: "maoBonusMilitia in both arrays"
      pattern: "maoBonusMilitia"
---

<objective>
Implement Mao's per-turn militia placement ability: place militia equal to rebel-controlled sector count into any wilderness sectors, distributed across multiple sectors interactively.

Purpose: Mao is the first of three militia placement dictators in Phase 59. His ability uses the Lockdown multi-sector loop pattern for human players and automatic distribution for AI.
Output: Working Mao militia placement for both AI and human paths, wired into flow, actions, and UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-militia-placement-abilities/59-RESEARCH.md

Key source files:
@src/rules/dictator-abilities.ts (Kim AI path at line 402 is the template; applyDictatorTurnAbilities dispatcher at line 658)
@src/rules/actions/dictator-actions.ts (Kim human action at line 504; Lockdown loop action at line 764 is the multi-sector template)
@src/rules/actions/index.ts (registration at line 131)
@src/rules/flow.ts (dictator-ability step at line 986; Lockdown loop at line 1083 is the template)
@src/rules/game.ts (pendingLockdownMilitia at line 634 is the template for pendingMaoMilitia)
@src/ui/components/DictatorPanel.vue (dictatorSpecificActions at line 136; isSelectingSector at line 165)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mao AI path and game state</name>
  <files>src/rules/game.ts, src/rules/dictator-abilities.ts</files>
  <action>
1. In `src/rules/game.ts`, add a `pendingMaoMilitia` state field following the exact pattern of `pendingLockdownMilitia` (line 634):
   ```typescript
   pendingMaoMilitia: {
     remaining: number;
   } | null = null;
   ```
   Add a getter `get hasMaoMilitiaPending(): boolean` that returns `this.pendingMaoMilitia !== null`.

2. In `src/rules/dictator-abilities.ts`, add `applyMaoTurnAbility(game: MERCGame): DictatorAbilityResult` following Kim's pattern (line 402):
   - Guard: `dictator.combatantId !== 'mao'` returns early
   - Count rebel-controlled sectors across all rebels using the same loop as Kim (lines 408-412)
   - If count is 0, message and return
   - Filter to wilderness sectors only: `game.gameMap.getAllSectors().filter(s => s.isWilderness)`
   - If no wilderness sectors, message and return
   - AI distribution: Loop remaining militia. For each iteration, filter wilderness sectors with room (`s.dictatorMilitia < Sector.MAX_MILITIA_PER_SIDE`), use `selectMilitiaPlacementSector(game, wildernessSectors, 'neutral')` to pick a target, place militia with `sector.addDictatorMilitia(1)` one at a time (to spread across sectors), check for rebel presence and `queuePendingCombat` if found
   - Message the total placed

3. In `applyDictatorTurnAbilities` (line 658), add `case 'mao': applyMaoTurnAbility(game); break;` to the switch statement.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` passes with no new errors</verify>
  <done>applyMaoTurnAbility exists and is called from the dispatcher. pendingMaoMilitia field exists on MERCGame.</done>
</task>

<task type="auto">
  <name>Task 2: Mao human action, flow loop, and registration</name>
  <files>src/rules/actions/dictator-actions.ts, src/rules/actions/index.ts, src/rules/flow.ts, src/ui/components/DictatorPanel.vue</files>
  <action>
1. In `src/rules/actions/dictator-actions.ts`, add `createMaoBonusMilitiaAction(game: MERCGame): ActionDefinition` following the Lockdown pattern (line 764):
   - Action name: `'maoBonusMilitia'`
   - Prompt: `"Mao's Ability: Place militia in wilderness sectors"`
   - Conditions: is dictator player, combatantId === 'mao', not AI, `game.pendingMaoMilitia != null && game.pendingMaoMilitia.remaining > 0`
   - `chooseFrom<string>('targetSector')`: Filter `game.gameMap.getAllSectors()` to sectors where `s.isWilderness && s.dictatorMilitia < Sector.MAX_MILITIA_PER_SIDE`, map to `s.sectorName`
   - `chooseFrom<string>('amount')`: Generate choices from 1 to `Math.min(remaining, 10 - targetSector.dictatorMilitia)`. Since the target sector isn't resolved yet at this point, use `Math.min(game.pendingMaoMilitia?.remaining ?? 0, 10)` for the upper bound (the execute step will enforce the actual cap)
   - Execute: Find sector by name, compute actual amount respecting sector cap (`10 - sector.dictatorMilitia`), call `sector.addDictatorMilitia(amount)`, decrement `pending.remaining`, check for rebel presence and `queuePendingCombat` if found (same pattern as Lockdown lines 813-823), clear `pendingMaoMilitia` if remaining <= 0

2. In `src/rules/flow.ts`:
   - In the execute step before dictator-ability (line 977), add Mao initialization for human players:
     ```typescript
     if (!game.dictatorPlayer?.isAI && game.dictatorPlayer?.dictator?.combatantId === 'mao') {
       let rebelSectorCount = 0;
       for (const rebel of game.rebelPlayers) {
         rebelSectorCount += game.getControlledSectors(rebel).length;
       }
       if (rebelSectorCount > 0) {
         const hasWilderness = game.gameMap.getAllSectors().some(s => s.isWilderness && s.dictatorMilitia < Sector.MAX_MILITIA_PER_SIDE);
         if (hasWilderness) {
           game.pendingMaoMilitia = { remaining: rebelSectorCount };
         }
       }
     }
     ```
   - Add `'maoBonusMilitia'` to the dictator-ability actionStep actions array (line 988)
   - After the dictator-ability actionStep (line 990) but BEFORE the combat resolution execute step (line 993), add a Mao distribution loop following the Lockdown loop pattern (line 1083-1092):
     ```typescript
     loop({
       name: 'mao-militia-distribution',
       while: () => game.pendingMaoMilitia != null && game.pendingMaoMilitia.remaining > 0 && !game.isFinished(),
       maxIterations: 50,
       do: actionStep({
         name: 'mao-place-militia',
         actions: ['maoBonusMilitia'],
         prompt: "Mao's Ability: Distribute militia to wilderness sectors",
         skipIf: () => game.isFinished() || game.pendingMaoMilitia == null || game.pendingMaoMilitia.remaining <= 0,
       }),
     }),
     ```
   - IMPORTANT: The first maoBonusMilitia in the dictator-ability actionStep handles the first placement. The loop handles subsequent placements until remaining is 0. This matches how Lockdown works (first placement in main step, loop for rest).

3. In `src/rules/actions/index.ts`:
   - Add import: `createMaoBonusMilitiaAction`
   - Add registration: `game.registerAction(createMaoBonusMilitiaAction(game));` after the existing dictator action registrations

4. In `src/ui/components/DictatorPanel.vue`:
   - Add `'maoBonusMilitia'` to `dictatorSpecificActions` array (line 136)
   - Add `currentAction === 'maoBonusMilitia'` to the `isSelectingSector` check (line 170), using the same pattern: `return sel.name === 'targetSector'`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` passes. Start a game as Mao (human) and verify the militia placement step appears during the dictator ability phase with wilderness sector choices.</verify>
  <done>Human Mao player sees interactive militia placement with wilderness sector filtering. Loop continues until all militia are distributed. Combat triggers if rebels present.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. AI game with Mao: militia placed on wilderness sectors each turn, count matches rebel-controlled sectors
3. Human game with Mao: dictator-ability step shows "Mao's Ability: Place militia in wilderness sectors" with wilderness-only sector choices and amount selection, loop continues until all placed
4. Militia on rebel-occupied wilderness sector triggers combat via pending combat queue
</verification>

<success_criteria>
- Mao AI path distributes militia across wilderness sectors equal to rebel-controlled sector count
- Mao human path presents multi-step interactive placement with wilderness filtering
- Standard 10 per sector cap enforced (no bypassCap)
- Combat triggers when militia placed on rebel-occupied sectors
- All registrations complete (index.ts, flow.ts actionStep + loop, DictatorPanel.vue)
</success_criteria>

<output>
After completion, create `.planning/phases/59-militia-placement-abilities/59-01-SUMMARY.md`
</output>
