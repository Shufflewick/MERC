---
phase: 48-landmine-system
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/rules/landmine.ts
  - tests/landmine.test.ts
autonomous: true

must_haves:
  truths:
    - "A detonated landmine deals 1 damage to every enemy combatant and kills ALL enemy militia in the sector"
    - "After detonation, the landmine is removed from the sector stash and discarded"
    - "When Squidhead is present in the entering squad, the landmine does not detonate"
    - "When Squidhead auto-disarms, the mine goes to the discard pile"
    - "Landmine damages the ENTERING player's units, not the defending player's units"
    - "If no mine is in stash, nothing happens"
    - "Friendly mines do not trigger when entering player controls the sector"
  artifacts:
    - path: "src/rules/landmine.ts"
      provides: "checkLandMines() function - shared bidirectional landmine trigger logic"
      exports: ["checkLandMines", "LandmineResult"]
    - path: "tests/landmine.test.ts"
      provides: "Unit tests for landmine detonation, Squidhead disarm, edge cases"
      min_lines: 80
  key_links:
    - from: "src/rules/landmine.ts"
      to: "src/rules/equipment-effects.ts"
      via: "isLandMine(), getMineDamage()"
      pattern: "isLandMine|getMineDamage"
    - from: "src/rules/landmine.ts"
      to: "src/rules/merc-abilities.ts"
      via: "handlesLandMines()"
      pattern: "handlesLandMines"
    - from: "src/rules/landmine.ts"
      to: "src/rules/game.ts"
      via: "game.animate(), game.message(), game.getEquipmentDiscard()"
      pattern: "game\\.animate|game\\.message|getEquipmentDiscard"
---

<objective>
Create the `checkLandMines()` function with TDD -- a shared, bidirectional landmine trigger function that handles detonation, Squidhead counter-ability, animation, and discard.

Purpose: This is the core logic for MINE-01 through MINE-04. The function must work for both rebel-entering-dictator-sector and dictator-entering-rebel-sector cases. Plan 02 will wire it into the movement actions.

Output: `src/rules/landmine.ts` with tested `checkLandMines()` function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-landmine-system/48-RESEARCH.md

IMPORTANT -- Research Open Question 2 is RESOLVED. The research suggests "equip on Squidhead or leave in stash" but the binding decision is: auto-disarm ALWAYS discards the mine. Do NOT equip on Squidhead, do NOT leave in stash. The disarm path removes from stash and sends to the accessory discard pile, period.

@src/rules/ai-combat-helpers.ts (lines 143-198 -- existing detonateLandMines)
@src/rules/equipment-effects.ts (isLandMine, getMineDamage at lines 445-448, 549-552)
@src/rules/merc-abilities.ts (handlesLandMines at lines 878-881)
@src/rules/elements.ts (Sector stash ops, CombatantModel.takeDamage, Squad.getLivingMercs)
@src/rules/game.ts (getMercsInSector, getDictatorMercsInSector, isDictatorInSector, animate, message, getEquipmentDiscard)
</context>

<tasks>

<task type="tdd">
  <name>Task 1: checkLandMines -- bidirectional landmine trigger</name>
  <files>src/rules/landmine.ts, tests/landmine.test.ts</files>
  <behavior>
    The function takes: game, destination sector, entering squad(s), and a flag indicating whether the entering player is rebel.

    Cases (input -> expected output):

    1. No mine in stash -> { detonated: false, disarmed: false }
    2. Mine in stash, no Squidhead in entering squad, entering player is rebel ->
       deals 1 damage to EVERY rebel merc in sector, kills ALL rebel militia in sector,
       removes mine from stash, discards mine -> { detonated: true, disarmed: false }
    3. Mine in stash, no Squidhead, entering player is dictator ->
       deals 1 damage to EVERY dictator merc in sector, kills ALL dictator militia in sector,
       removes mine from stash, discards mine -> { detonated: true, disarmed: false }
    4. Mine in stash, Squidhead IS in entering squad ->
       mine removed from stash, mine goes to discard pile, NO damage dealt ->
       { detonated: false, disarmed: true, disarmedBy: 'Squidhead' }
    5. Mine in stash but entering player controls the sector (friendly mine) ->
       { detonated: false, disarmed: false } -- friendly mines don't trigger

    Result interface:
    ```typescript
    interface LandmineResult {
      detonated: boolean;
      disarmed: boolean;
      disarmedBy?: string;
    }
    ```
  </behavior>
  <implementation>
    Create `src/rules/landmine.ts`:

    ```typescript
    import type { MERCGame } from './game.js';
    import type { Sector, Squad } from './elements.js';
    import { isLandMine, getMineDamage } from './equipment-effects.js';
    import { handlesLandMines } from './merc-abilities.js';

    export interface LandmineResult {
      detonated: boolean;
      disarmed: boolean;
      disarmedBy?: string;
    }

    export function checkLandMines(
      game: MERCGame,
      sector: Sector,
      enteringSquads: Squad[],
      enteringPlayerIsRebel: boolean,
    ): LandmineResult
    ```

    Key implementation details:

    1. Find first land mine in sector stash using `sector.getStashContents()` + `isLandMine()`.
    2. Early return `{ detonated: false, disarmed: false }` if no mine found.
    3. Determine if the mine is hostile to the entering player. The mine damages the ENTERING player's units (the entering player walked into a trap). If entering player is rebel, damage rebel units. If entering player is dictator, damage dictator units. This is the bidirectional key insight -- the mine always hurts whoever walks into it.
    4. Check Squidhead: iterate `enteringSquads` -> `getLivingMercs()` -> find any merc where `handlesLandMines(merc.combatantId)` is true. If found, disarm path.
    5. Disarm path: remove mine from stash via `sector.takeFromStash(idx)`, discard it via `game.getEquipmentDiscard('Accessory')` + `mine.putInto(discard)`. Call `game.animate('landmine-disarm', {...}, () => { /* mutations */ })`. Return `{ detonated: false, disarmed: true, disarmedBy: squidhead.combatantName }`.
       RESOLVED DECISION: Auto-disarm ALWAYS discards the mine. Do NOT try to equip on Squidhead, do NOT leave in stash. Remove from stash -> discard pile.
    6. Detonate path: Pre-compute targets BEFORE `game.animate()` call.
       - If entering player is rebel: targets = all rebel mercs in sector (via `game.getMercsInSector(sector, rebel)` for each rebel player) + rebel militia.
       - If entering player is dictator: targets = all dictator mercs in sector (via `game.getDictatorMercsInSector(sector)`) + dictator combatant (if in sector via `game.isDictatorInSector(sector)`) + dictator militia.
    7. Inside `game.animate('landmine-detonate', {...}, () => { ... })` callback:
       - `takeDamage(getMineDamage(mine.equipmentId))` on each target combatant
       - Kill ALL militia per faction (rebel: `sector.removeRebelMilitia(playerId, count)` for full count per rebel player; dictator: `sector.removeDictatorMilitia(count)` for full count)
       - Remove mine from stash: `sector.takeFromStash(idx)`
       - Discard mine: `game.getEquipmentDiscard('Accessory')` + `mine.putInto(discard)`
    8. Call `game.message()` for each damage event for text feedback.

    IMPORTANT: Use `getMineDamage(mine.equipmentId)` not hardcoded `1` -- use the existing helper.
    IMPORTANT: Use `handlesLandMines(combatantId)` not `=== 'squidhead'` -- use the ability registry.
    IMPORTANT: Pre-compute animation data (target names, sector name) BEFORE the `game.animate()` call. Mutations inside the callback are for state changes only.
    IMPORTANT: The dictator combatant card (`game.dictatorPlayer.dictator`) is a valid damage target if it is in the sector and alive. Check `game.isDictatorInSector(sector)` and then access `game.dictatorPlayer.dictator` to apply damage.
  </implementation>
  <verify>
    `npm test -- tests/landmine.test.ts` passes. Tests cover all 5 cases: no mine (no-op), rebel detonation, dictator detonation, Squidhead disarm to discard, friendly mine no-trigger. `npx tsc --noEmit` passes.
  </verify>
  <done>
    checkLandMines() exported, handles all 5 cases including friendly mine no-trigger, Squidhead always discards mine on auto-disarm, all tests pass, TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
- `npm test -- tests/landmine.test.ts` passes
- Tests cover: no mine (no-op), detonation damages entering player's units, mine discarded after detonation, Squidhead prevents detonation, Squidhead disarm sends mine to discard, friendly mine does not trigger
- `npx tsc --noEmit` passes (no type errors)
</verification>

<success_criteria>
- `checkLandMines()` exported from `src/rules/landmine.ts`
- Function handles bidirectional damage (rebel and dictator entering)
- Squidhead counter-ability prevents detonation and discards mine
- Friendly mines do not trigger when entering player controls the sector
- Uses existing helpers: `isLandMine()`, `getMineDamage()`, `handlesLandMines()`
- All tests pass
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/48-landmine-system/48-01-SUMMARY.md`
</output>
