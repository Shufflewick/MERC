---
phase: 06-test-coverage
plan: 02
type: execute
---

<objective>
Add tests for state persistence patterns (cache helpers, game.settings) to ensure state survives correctly and doesn't corrupt.

Purpose: Cover the test gap for state persistence - the cache helpers and game.settings patterns were established in Phase 3-4 but aren't directly tested.
Output: New test file `tests/state-persistence.test.ts` verifying cache helper behavior.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-coverage/06-01-SUMMARY.md

**Cache helpers to test:**
@src/rules/actions/helpers.ts

The helpers to test:
- `getCachedValue<T>(game, prefix, playerId)` - player-scoped cache read
- `setCachedValue<T>(game, prefix, playerId, value)` - player-scoped cache write
- `clearCachedValue(game, prefix, playerId)` - player-scoped cache clear
- `getGlobalCachedValue<T>(game, key)` - global cache read
- `setGlobalCachedValue<T>(game, key, value)` - global cache write
- `clearGlobalCachedValue(game, key)` - global cache clear

**Real usage patterns from codebase:**
- Arms dealer drawn equipment caching (rebel-economy.ts)
- Selected equipment/merc caching during flows
- Tactics card selection caching (dictator-actions.ts)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state-persistence.test.ts with cache helper tests</name>
  <files>tests/state-persistence.test.ts</files>
  <action>
Create new test file for state persistence testing.

1. Test player-scoped cache helpers:
   - `setCachedValue` stores value at correct key
   - `getCachedValue` retrieves stored value
   - `getCachedValue` returns undefined for missing key
   - `clearCachedValue` removes the value
   - Different players don't interfere (isolation)
   - Type parameter works (stores/retrieves typed values)

2. Test global cache helpers:
   - `setGlobalCachedValue` stores value at key
   - `getGlobalCachedValue` retrieves stored value
   - `getGlobalCachedValue` returns undefined for missing key
   - `clearGlobalCachedValue` removes the value

3. Test key patterns:
   - Player-scoped key format is `prefix:playerId`
   - Global key is used directly

Use `createTestGame` to get a real game instance for testing.
  </action>
  <verify>npm test -- tests/state-persistence.test.ts --run passes</verify>
  <done>Cache helper tests pass, covering read/write/clear for both player-scoped and global variants</done>
</task>

<task type="auto">
  <name>Task 2: Add game.settings persistence behavior tests</name>
  <files>tests/state-persistence.test.ts</files>
  <action>
Add tests verifying game.settings behavior that the cache helpers depend on:

1. Test game.settings object behavior:
   - Setting a key stores value
   - Getting a key retrieves value
   - Deleting a key removes it
   - Multiple keys coexist

2. Test real caching scenarios from the codebase:
   - Arms dealer "drawn equipment" caching pattern
   - Selected MERC caching during hire flow
   - Verify cache is cleared at expected points

3. Test edge cases:
   - Setting undefined vs deleting key
   - Setting null value
   - Overwriting existing value

This validates the underlying storage mechanism the helpers use.
  </action>
  <verify>npm test -- tests/state-persistence.test.ts --run passes</verify>
  <done>Game.settings behavior tests pass, covering storage semantics and real caching scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- tests/state-persistence.test.ts --run` passes
- [ ] Tests cover all 6 cache helper functions
- [ ] Tests verify player isolation (different players don't interfere)
- [ ] Tests verify game.settings underlying behavior
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Cache helpers tested for read/write/clear operations
- Player isolation verified
- Real caching patterns from codebase validated
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-coverage/06-02-SUMMARY.md`
</output>
