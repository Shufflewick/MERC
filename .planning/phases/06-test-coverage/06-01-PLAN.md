---
phase: 06-test-coverage
plan: 01
type: execute
---

<objective>
Add tests for action `.condition()` validation logic to ensure actions are only available when game state permits.

Purpose: Cover the test gap identified in CONCERNS.md - action validation conditions are not currently tested, risking invalid actions slipping through.
Output: New test file `tests/action-conditions.test.ts` with comprehensive condition coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior Phase Context:**
- Phase 5 complete - debug cleanup done
- Type guards and helpers established in Phase 2-3
- Cache helpers established in Phase 3-4

**Existing Test Patterns:**
@tests/game.test.ts
@tests/smoke.test.ts

**Key patterns from existing tests:**
- Use `createTestGame` from `@boardsmith/testing`
- Use `vitest` (describe, it, expect, beforeEach)
- Use `traceAction` for action availability debugging
- Use `assertActionAvailable` for action assertions

**Action files with conditions to test:**
- `src/rules/actions/rebel-movement.ts` - move conditions (combat check, player type, movable squads)
- `src/rules/actions/rebel-economy.ts` - explore, train, hire conditions (action points, game state)
- `src/rules/actions/day-one-actions.ts` - Day 1 specific conditions (placement, hiring order)
- `src/rules/actions/rebel-equipment.ts` - equip conditions (ownership, equipment availability)
- `src/rules/actions/dictator-actions.ts` - dictator action conditions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create action-conditions.test.ts with movement action tests</name>
  <files>tests/action-conditions.test.ts</files>
  <action>
Create new test file for action condition testing. Start with movement action conditions since they're well-defined:

1. Test `move` action condition:
   - Returns false during active combat
   - Returns false for non-rebel/non-dictator players
   - Returns false when no squads can move (no living mercs, no actions remaining)
   - Returns true when conditions met

2. Test `splitSquad` action condition:
   - Returns false when squad too small to split
   - Returns true when squad has 2+ members

3. Test `mergeSquads` action condition:
   - Returns false when squads not in same sector
   - Returns true when squads colocated

Use existing test helpers: `createTestGame`, `traceAction`, game state manipulation.
Follow existing test file patterns from game.test.ts and smoke.test.ts.
  </action>
  <verify>npm test -- tests/action-conditions.test.ts --run passes</verify>
  <done>Movement action condition tests pass, covering combat check, player type, and squad availability</done>
</task>

<task type="auto">
  <name>Task 2: Add economy and hiring action condition tests</name>
  <files>tests/action-conditions.test.ts</files>
  <action>
Add tests for economy-related action conditions:

1. Test `explore` action condition:
   - Returns false when no MERC has actions remaining
   - Returns false in wrong game phase
   - Returns true when MERC has actions and sector unexplored

2. Test `train` action condition:
   - Returns false when no actions remaining
   - Returns false when sector has no militia to recruit
   - Returns true when conditions met

3. Test `hireMerc` action condition:
   - Returns false when insufficient actions (needs 2)
   - Returns false when no credits
   - Returns false when MERC deck empty
   - Returns true when all conditions met

Test MERC incompatibilities from helpers.ts (Borris/Squirrel, Natasha/Moose).
  </action>
  <verify>npm test -- tests/action-conditions.test.ts --run passes</verify>
  <done>Economy action condition tests pass, covering action points, credits, deck state, and MERC compatibility</done>
</task>

<task type="auto">
  <name>Task 3: Add Day 1 and equipment action condition tests</name>
  <files>tests/action-conditions.test.ts</files>
  <action>
Add tests for remaining action conditions:

1. Test Day 1 action conditions:
   - `placeLanding` - returns false when landing already placed
   - `hireFirstMerc` - returns false before landing placed
   - `equipStarting` - returns false before MERCs hired

2. Test equipment action conditions:
   - `reEquip` - returns false when no equipment to swap
   - Equipment filtering (correct type, ownership)

3. Test dictator action conditions (if time permits):
   - `playTactics` - returns false when hand empty
   - `reinforce` - returns false when no militia available

Focus on the most important conditions that protect game integrity.
  </action>
  <verify>npm test -- tests/action-conditions.test.ts --run passes with all new tests green</verify>
  <done>Day 1 and equipment action condition tests pass, covering setup sequence and equipment constraints</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- tests/action-conditions.test.ts --run` passes
- [ ] Tests cover movement, economy, Day 1, and equipment conditions
- [ ] No TypeScript errors in test file
- [ ] Tests follow existing patterns from game.test.ts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- New test file tests 10+ different action conditions
- Tests cover positive (condition met) and negative (condition not met) cases
- Tests are maintainable and follow existing patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-coverage/06-01-SUMMARY.md`
</output>
