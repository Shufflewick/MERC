---
phase: 40-unify-combat-time-application
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/combat.ts
  - src/rules/elements.ts
autonomous: true

must_haves:
  truths:
    - "Combat stats match displayed stats (no double-counting)"
    - "Equipment-conditional bonuses (Bouba, Mayhem, etc.) applied once from CombatantModel"
    - "Squad-conditional bonuses (Sarge, Tack, Valkyrie) applied once from CombatantModel"
    - "Combat-only effects (Max debuff, Walter militia, Khenn roll, Haarg all-combatant, Golem) still work"
  artifacts:
    - path: "src/rules/combat.ts"
      provides: "Combat execution without duplicate bonus functions"
      contains: "applyEnemyDebuffs"
    - path: "src/rules/elements.ts"
      provides: "Unified targets getter"
      contains: "getAbilityBonus('targets')"
  key_links:
    - from: "src/rules/combat.ts"
      to: "src/rules/elements.ts"
      via: "mercToCombatant reads merc.combat, merc.initiative, merc.targets"
      pattern: "merc\\.(combat|initiative|targets)"
---

<objective>
Remove duplicate bonus functions from combat.ts that double-count abilities already calculated in CombatantModel's stat getters.

Purpose: After Phase 38 unified server-side stat calculation, `merc.combat`, `merc.initiative`, and `merc.targets` already include all ability bonuses. The combat.ts bonus functions now DOUBLE-COUNT these. This phase removes the duplicates while preserving combat-time-only effects.

Output: combat.ts with ~400 fewer lines, combat stats match displayed stats exactly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-unify-combat-time-application/40-RESEARCH.md
@src/rules/combat.ts
@src/rules/elements.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove duplicate bonus functions from combat.ts</name>
  <files>src/rules/combat.ts</files>
  <action>
Remove these duplicate bonus FUNCTIONS (they duplicate what CombatantModel stat getters already calculate):

1. Equipment-conditional (lines ~318-906):
   - `applyBoubaBonus` (line 318) - combat +1 with handgun
   - `applyMayhemBonus` (line 598) - combat +2 with uzi
   - `applyRozeskeBonus` (line 609) - combat +1 with armor
   - `applyRaBonus` (line 620) - targets +1 with weapon
   - `applyStumpyBonus` (line 648) - combat +1 with explosive
   - `applyVandradiBonus` (line 659) - combat +1 with multi-target weapon
   - `applyDutchBonus` (line 887) - combat/initiative +1 unarmed/sword
   - `applyMoeBonus` (line 900) - targets +1 with SMAW

2. Squad-conditional (lines ~671-820):
   - `applySargeBonus` (line 671) - combat/initiative +1 highest init
   - `applyTackBonus` (line 708) - initiative +2 to squad
   - `applyValkyrieBonus` (line 749) - initiative +1 to squad mates
   - `applyTavistoBonus` (line 787) - combat/initiative +1 woman in squad
   - `applyVultureBonus` (line 826) - initiative penalty negate
   - `applySnakeBonus` (line 1250) - combat/initiative +1 alone in squad

Remove associated HELPER FUNCTIONS that are only used by removed bonus functions:
   - `isBouba`, `hasHandgun` (lines 296-313)
   - `isMayhem`, `hasUzi` (lines 349-366)
   - `isRozeske`, `hasArmor` (lines 403-418)
   - `isRa` (lines 393-398)
   - `isStumpy`, `hasExplosive` (lines 443-466)
   - `isVandradi`, `hasMultiTargetWeapon` (lines 499-517)
   - `isSarge` (lines 432-438)
   - `isTack` (lines 469-476)
   - `isValkyrie` (lines 489-496)
   - `isTavisto` (lines 479-486)
   - `isVulture` (lines 521-527)
   - `isDutch`, `isDutchUsingFists` (lines 552-571)
   - `isMoe`, `hasSmaw` (lines 576-593)
   - `isSnake` (lines 1226-1231)

Remove CALLS to these functions in executeCombatRound (lines ~1749-1796):
   - Remove: applyBoubaBonus, applyMayhemBonus, applyRozeskeBonus, applyRaBonus
   - Remove: applyStumpyBonus, applyVandradiBonus, applyDutchBonus, applyMoeBonus
   - Remove: applySargeBonus, applyTackBonus, applyValkyrieBonus, applyTavistoBonus
   - Remove: applyVultureBonus, applySnakeBonus

DO NOT REMOVE these combat-time-only functions (they apply effects that DON'T appear on cards):
   - `applyEnemyDebuffs` - Max's -1 combat to ENEMIES only during combat
   - `applyWalterBonus` - militia +2 initiative (militia created at combat time)
   - `applyKhennInitiative` - random D6 roll at combat start
   - `applyHaargBonus` - compares to ALL combatants per rules (card shows squad comparison)
   - `executeGolemPreCombat` - pre-combat attack

Keep helper functions used by retained functions:
   - `isWalter` (used by applyWalterBonus)
   - `isKhenn` (used by applyKhennInitiative)
   - `isHaarg` (used by applyHaargBonus)
   - `isGolem` (used by executeGolemPreCombat)
  </action>
  <verify>
Run `npm test` - all tests pass. Search for removed function names - no hits.
Verify executeCombatRound only calls: refreshCombatantStats, applyHaargBonus, applyEnemyDebuffs, applyWalterBonus, applyKhennInitiative, executeGolemPreCombat
  </verify>
  <done>
14 duplicate bonus functions removed. 14+ helper functions removed. ~400 lines of dead code eliminated.
All calls to removed functions removed from executeCombatRound.
Combat-time-only functions preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix targets getter to use unified getAbilityBonus</name>
  <files>src/rules/elements.ts</files>
  <action>
Update the `targets` getter in CombatantModel (line 728) to use the unified ability bonus system.

Current (line 736-737):
```typescript
value += this.moeSmawTargetBonus || 0;
value += this.raWeaponTargetBonus || 0;
```

Change to:
```typescript
// Unified ability bonus from activeStatModifiers
value += this.getAbilityBonus('targets');
```

Also remove the now-unused properties from CombatantBase:
- `moeSmawTargetBonus` (line 148)
- `raWeaponTargetBonus` (line 149)

Remove their initialization in `updateIndividualEquipmentBonuses()` (lines 585-586, 611-612).
  </action>
  <verify>
Run `npm test` - all tests pass.
Check targets getter uses getAbilityBonus('targets').
Check moeSmawTargetBonus and raWeaponTargetBonus properties removed.
  </verify>
  <done>
targets getter uses unified getAbilityBonus('targets').
Individual bonus fields removed.
Ra and Moe targets bonuses work via activeStatModifiers.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Run `npm test` - all 580+ tests pass
2. Verify no duplicate bonus function calls in executeCombatRound:
   ```bash
   grep -n "applyBouba\|applyMayhem\|applyRozeske\|applyRa\|applyStumpy\|applyVandradi\|applySarge\|applyTack\|applyValkyrie\|applyTavisto\|applyVulture\|applyDutch\|applyMoe\|applySnake" src/rules/combat.ts
   ```
   Should return no matches.

3. Verify combat-time functions preserved:
   ```bash
   grep -n "applyEnemyDebuffs\|applyWalterBonus\|applyKhennInitiative\|applyHaargBonus\|executeGolemPreCombat" src/rules/combat.ts
   ```
   Should return matches for function definitions AND calls.

4. Verify targets getter uses unified system:
   ```bash
   grep -n "getAbilityBonus.*targets" src/rules/elements.ts
   ```
   Should return match in targets getter.
</verification>

<success_criteria>
- All tests pass (580+)
- combat.ts reduced by ~400 lines
- No duplicate bonus application in combat
- Combat stats match displayed card stats
- Combat-time-only effects (Max, Walter, Khenn, Haarg-all-combatants, Golem) preserved
- targets getter uses unified getAbilityBonus('targets')
</success_criteria>

<output>
After completion, create `.planning/phases/40-unify-combat-time-application/40-01-SUMMARY.md`
</output>
