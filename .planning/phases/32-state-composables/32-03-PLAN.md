---
phase: 32
plan: 03
wave: 2
depends_on: [32-01, 32-02]
files_modified:
  - src/ui/composables/useSquadState.ts (new)
autonomous: true
---

# Plan 03: Create useSquadState Composable

## Objective

Extract squad-related state derivation from GameBoard.vue into `src/ui/composables/useSquadState.ts`. This composable provides squad objects for both rebel and dictator players.

## Context

**Source:** GameBoard.vue lines 480-591, 653-870

**Requirement:** STATE-03 - primarySquad, secondarySquad, dictatorPrimarySquad, dictatorSecondarySquad, dictatorBaseSquad, buildDictatorSquad

**Dependencies:** Uses currentPlayerIsDictator from STATE-01, sectors from STATE-02

## Tasks

<task id="1">
Read GameBoard.vue to locate the exact code for:
- `getSquadPlayerPosition` helper function
- `primarySquad` computed (lines ~673-699)
- `secondarySquad` computed (lines ~701-727)
- `buildDictatorSquad` function (lines ~730-771)
- `dictatorPrimarySquad` computed (lines ~774-789)
- `dictatorSecondarySquad` computed (lines ~792-807)
- `dictatorBaseSquad` computed (lines ~811-870)
- `dictatorSquad` computed
- `allMercs` computed
</task>

<task id="2">
Create `src/ui/composables/useSquadState.ts` with this structure:

```typescript
import { computed, type ComputedRef, type Ref, unref } from 'vue';
import { useGameViewHelpers } from './useGameViewHelpers';
import type { Sector } from './useSectorState';

export interface SquadState {
  squadId: string;
  isPrimary: boolean;
  sectorId: string;
  sectorName?: string;
  mercs: any[];
}

export interface SquadStateReturn {
  primarySquad: ComputedRef<SquadState | null>;
  secondarySquad: ComputedRef<SquadState | null>;
  dictatorPrimarySquad: ComputedRef<SquadState | null>;
  dictatorSecondarySquad: ComputedRef<SquadState | null>;
  dictatorBaseSquad: ComputedRef<SquadState | null>;
  dictatorSquad: ComputedRef<SquadState | null>;
  allMercs: ComputedRef<any[]>;
}

export function useSquadState(
  getGameView: () => any,
  playerPosition: Ref<number> | number,
  currentPlayerIsDictator: ComputedRef<boolean>,
  sectors: ComputedRef<Sector[]>
): SquadStateReturn {
  const {
    findAllByClassName,
    getAttr,
    findDictatorCombatant,
    isMercDead
  } = useGameViewHelpers(getGameView);

  // Helper to get squad player position
  function getSquadPlayerPosition(squad: any): number {
    // ...
  }

  // Helper to build dictator squad with dictator card
  function buildDictatorSquad(squad: any): SquadState | null {
    // ...
  }

  const primarySquad = computed(() => {
    // ...
  });

  const secondarySquad = computed(() => {
    // ...
  });

  const dictatorPrimarySquad = computed(() => {
    // ...
  });

  const dictatorSecondarySquad = computed(() => {
    // ...
  });

  const dictatorBaseSquad = computed(() => {
    // ...
  });

  const dictatorSquad = computed(() => {
    // ...
  });

  const allMercs = computed(() => {
    // ...
  });

  return {
    primarySquad,
    secondarySquad,
    dictatorPrimarySquad,
    dictatorSecondarySquad,
    dictatorBaseSquad,
    dictatorSquad,
    allMercs,
  };
}
```
</task>

<task id="3">
Extract exact logic from GameBoard.vue:

**Squad Structure:**
```typescript
{
  squadId: string,
  isPrimary: boolean,
  sectorId: string,
  sectorName?: string,  // looked up from sectors
  mercs: any[]          // CombatantModel elements, filtered for dead
}
```

**buildDictatorSquad special handling:**
- Include dictator card when `inPlay=true`
- Map dictator to merc-like format with `isDictator: true`

**Key patterns:**
- Filter dead MERCs with `isMercDead` check
- Use `currentPlayerIsDictator` to conditionally return dictator squads
- Look up sector names from `sectors` array
</task>

<task id="4">
Verify TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
</task>

## Verification

<verify>
1. File exists at src/ui/composables/useSquadState.ts
2. TypeScript compiles without errors
3. Exports: useSquadState function
4. Returns all squad computeds: primarySquad, secondarySquad, dictatorPrimarySquad, dictatorSecondarySquad, dictatorBaseSquad, dictatorSquad, allMercs
5. Depends on currentPlayerIsDictator and sectors from other composables
</verify>

## Must Haves

- [ ] `primarySquad` returns rebel player's primary squad
- [ ] `secondarySquad` returns rebel player's secondary squad
- [ ] `dictatorPrimarySquad` includes dictator card when in play
- [ ] `dictatorSecondarySquad` returns dictator's secondary squad
- [ ] `dictatorBaseSquad` returns dictator's base/third squad
- [ ] `dictatorSquad` returns whichever dictator squad is relevant
- [ ] `allMercs` returns all living MERCs across all squads
- [ ] Dead MERCs are filtered out using isMercDead
- [ ] Dictator card mapped to merc-like format when included
- [ ] TypeScript types exported for SquadState
