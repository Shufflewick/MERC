---
phase: 32
plan: 05
wave: 4
depends_on: [32-01, 32-02, 32-03, 32-04]
files_modified:
  - src/ui/components/GameBoard.vue
autonomous: true
---

# Plan 05: Integrate State Composables into GameBoard.vue

## Objective

Update GameBoard.vue to import and use all four state composables created in plans 01-04. Remove extracted definitions from GameBoard.vue while preserving all functionality.

## Context

**Source:** GameBoard.vue (currently ~3,093 lines)

**Requirements:**
- STATE-01 integration: usePlayerState
- STATE-02 integration: useSectorState
- STATE-03 integration: useSquadState
- STATE-04 integration: useActionState

**Target:** Significant line reduction as state derivation moves to composables.

## Tasks

<task id="1">
Add imports for all state composables at top of script setup:

```typescript
import { usePlayerState } from '@/ui/composables/usePlayerState';
import { useSectorState } from '@/ui/composables/useSectorState';
import { useSquadState } from '@/ui/composables/useSquadState';
import { useActionState } from '@/ui/composables/useActionState';
```
</task>

<task id="2">
Initialize all composables in the correct order (dependencies flow down):

```typescript
// Player state (independent)
const {
  players,
  currentPlayerColor,
  playerColorMap,
  dictatorPlayerColor,
  currentPlayerIsDictator,
  positionToColor,
} = usePlayerState(
  () => props.gameView,
  () => props.playerPosition
);

// Sector state (uses helpers only)
const {
  sectors,
  selectedSectorId,
  selectedSector,
  actionContextSectorId,
  actionContextSector,
  activeSector,
  selectedSectorStash,
  selectedSectorMercs,
  controlMap,
  hasDoc,
  hasSquidhead,
  hasMortar,
  hasDamagedMercs,
  hasLandMinesInStash,
  squidheadHasLandMine,
} = useSectorState(
  () => props.gameView,
  {
    state: props.state,
    actionArgs: props.actionArgs,
  },
  () => allMercs.value
);

// Squad state (depends on player, sector)
const {
  primarySquad,
  secondarySquad,
  dictatorPrimarySquad,
  dictatorSecondarySquad,
  dictatorBaseSquad,
  dictatorSquad,
  allMercs,
} = useSquadState(
  () => props.gameView,
  () => props.playerPosition,
  currentPlayerIsDictator,
  sectors
);

// Action state (depends on all)
const {
  actionChoices,
  currentActionMetadata,
  currentSelection,
  allSelectionsComplete,
  getCurrentActionName,
  isHiringMercs,
  isSelectingDictator,
  isHagnessDrawActive,
  isPlacingLanding,
  isSelectingRetreatSector,
  isEquipping,
  isSelectingEquipmentType,
  isCastroHiring,
  isSelectingSector,
  showAssignToSquad,
  isHagnessSelectingType,
  isHagnessSelectingRecipient,
  retreatSectorChoices,
  sectorChoices,
  landingZoneMetadata,
  selectedMercForEquipment,
  hagnessEquipmentTypeChoices,
  hagnessEquipmentTypeSelection,
  hagnessDrawnEquipmentToAssign,
  hagnessRecipientChoices,
  deferredChoicesLoading,
  fetchedDeferredChoices,
  showHiringMercModal,
  assignToSquadDelayedHide,
} = useActionState(
  {
    availableActions: props.availableActions,
    actionController: props.actionController,
    actionArgs: props.actionArgs,
    state: props.state,
  },
  sectors,
  primarySquad,
  secondarySquad,
  fetchDeferredChoicesFn
);
```
</task>

<task id="3">
Remove extracted definitions from GameBoard.vue:

**From STATE-01 (~108 lines):**
- Remove `players` computed
- Remove `currentPlayerColor` computed
- Remove `playerColorMap` computed
- Remove `dictatorPlayerColor` computed
- Remove `currentPlayerIsDictator` computed
- Remove `positionToColor` function

**From STATE-02 (~287 lines):**
- Remove `sectors` computed
- Remove `selectedSectorId` ref
- Remove `selectedSector` computed
- Remove `actionContextSectorId` computed
- Remove `actionContextSector` computed
- Remove `activeSector` computed
- Remove `selectedSectorStash` computed
- Remove `selectedSectorMercs` computed
- Remove `controlMap` computed
- Remove ability flag computeds (hasDoc, etc.)

**From STATE-03 (~197 lines):**
- Remove `getSquadPlayerPosition` function
- Remove `primarySquad` computed
- Remove `secondarySquad` computed
- Remove `buildDictatorSquad` function
- Remove dictator squad computeds
- Remove `allMercs` computed

**From STATE-04 (~533 lines):**
- Remove all action type flag computeds
- Remove `actionChoices` computed
- Remove `currentActionMetadata` computed
- Remove `currentSelection` computed
- Remove derived state computeds
- Remove UI state refs (move to composable)
- Evaluate which watch handlers to keep vs move
</task>

<task id="4">
Keep event handlers in GameBoard.vue that use composable state:
- `handleSectorClick` - sets selectedSectorId.value
- `closeSectorPanel` - clears selectedSectorId.value
- Action selection handlers that call props.actionController methods

These stay in GameBoard because they interact with component props/emit.
</task>

<task id="5">
Verify game still works:
```bash
npm run dev
```

Test in browser:
- New game starts correctly
- Player colors display correctly
- Sector selection works
- Squad display works
- Hiring flow works
- Combat works
</task>

<task id="6">
Verify TypeScript compiles:
```bash
npx tsc --noEmit
```
</task>

## Verification

<verify>
1. All state composables imported and initialized
2. Extracted definitions removed from GameBoard.vue
3. TypeScript compiles without errors
4. Game runs without runtime errors
5. All UI functionality preserved:
   - Player colors work
   - Sector selection works
   - Squad display works
   - Action flows work
   - Ability flags work
6. Line count significantly reduced
</verify>

## Must Haves

- [ ] All four composables imported and destructured
- [ ] Composables initialized in correct dependency order
- [ ] All STATE-01 definitions removed from GameBoard.vue
- [ ] All STATE-02 definitions removed from GameBoard.vue
- [ ] All STATE-03 definitions removed from GameBoard.vue
- [ ] All STATE-04 definitions removed from GameBoard.vue
- [ ] Event handlers that modify state still work
- [ ] Template bindings unchanged (same variable names)
- [ ] No runtime errors in browser console
- [ ] TypeScript compiles cleanly
