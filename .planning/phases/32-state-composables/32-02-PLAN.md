---
phase: 32
plan: 02
wave: 1
depends_on: []
files_modified:
  - src/ui/composables/useSectorState.ts (new)
autonomous: true
---

# Plan 02: Create useSectorState Composable

## Objective

Extract sector-related state derivation from GameBoard.vue into `src/ui/composables/useSectorState.ts`. This composable provides sector data, selection state, control map, and sector ability flags.

## Context

**Source:** GameBoard.vue lines 81-315, 604-651

**Requirement:** STATE-02 - sectors, selectedSector, activeSector, controlMap, selectedSectorStash, sector ability flags

## Tasks

<task id="1">
Read GameBoard.vue to locate the exact code for:
- `sectors` computed (lines ~81-126)
- `selectedSectorId` ref (line ~41)
- `selectedSector` computed (lines ~129-132)
- `actionContextSectorId` computed (lines ~135-170)
- `actionContextSector` computed (lines ~173-176)
- `activeSector` computed (lines ~179-182)
- `selectedSectorStash` computed (lines ~184-238)
- `selectedSectorMercs` computed (lines ~241-244)
- `controlMap` computed (lines ~604-651)
- Ability flags: hasDoc, hasSquidhead, hasMortar, hasDamagedMercs, hasLandMinesInStash, squidheadHasLandMine (lines ~247-315)
</task>

<task id="2">
Create `src/ui/composables/useSectorState.ts` with this structure:

```typescript
import { computed, ref, type ComputedRef, type Ref } from 'vue';
import { useGameViewHelpers } from './useGameViewHelpers';

export interface Sector {
  sectorId: string;
  sectorName: string;
  coordinates: { q: number; r: number };
  militias: { color: string; count: number }[];
  // ... other sector properties
}

export interface SectorState {
  sectors: ComputedRef<Sector[]>;
  selectedSectorId: Ref<string | null>;
  selectedSector: ComputedRef<Sector | null>;
  actionContextSectorId: ComputedRef<string | null>;
  actionContextSector: ComputedRef<Sector | null>;
  activeSector: ComputedRef<Sector | null>;
  selectedSectorStash: ComputedRef<any[]>;
  selectedSectorMercs: ComputedRef<any[]>;
  controlMap: ComputedRef<Record<string, string>>;
  // Ability flags
  hasDoc: ComputedRef<boolean>;
  hasSquidhead: ComputedRef<boolean>;
  hasMortar: ComputedRef<boolean>;
  hasDamagedMercs: ComputedRef<boolean>;
  hasLandMinesInStash: ComputedRef<boolean>;
  squidheadHasLandMine: ComputedRef<boolean>;
}

export function useSectorState(
  getGameView: () => any,
  props: {
    state?: any;
    actionArgs?: any;
  },
  getMercsForSectorCheck?: () => any[]
): SectorState {
  const { findAllByClassName, findByRef, getAttr, findByClassName } = useGameViewHelpers(getGameView);

  const selectedSectorId = ref<string | null>(null);

  const sectors = computed(() => {
    // ... extract from GameBoard.vue
  });

  // ... other computeds

  return {
    sectors,
    selectedSectorId,
    selectedSector,
    actionContextSectorId,
    actionContextSector,
    activeSector,
    selectedSectorStash,
    selectedSectorMercs,
    controlMap,
    hasDoc,
    hasSquidhead,
    hasMortar,
    hasDamagedMercs,
    hasLandMinesInStash,
    squidheadHasLandMine,
  };
}
```
</task>

<task id="3">
Extract exact logic from GameBoard.vue for each computed:

**sectors:**
- Find all Sector elements
- Map to sector objects with sectorId, sectorName, coordinates, militias, loot

**controlMap:**
- Iterate sectors, determine control by militia counts and MERC positions
- Return Record<sectorId, controllingColor>

**Ability flags:**
- Check active sector for specific MERCs (Doc, Squidhead, etc.)
- Check for conditions like damaged mercs, land mines in stash
</task>

<task id="4">
Note: `selectedSectorId` is a writable ref - expose it so GameBoard can set it from click handlers.
</task>

<task id="5">
Verify TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
</task>

## Verification

<verify>
1. File exists at src/ui/composables/useSectorState.ts
2. TypeScript compiles without errors
3. Exports: useSectorState function
4. Returns all sector-related computed refs plus selectedSectorId ref
5. selectedSectorId is a writable Ref<string | null>
6. Uses useGameViewHelpers for tree queries
</verify>

## Must Haves

- [ ] `sectors` returns array of sector objects with all properties
- [ ] `selectedSectorId` is writable ref for UI state
- [ ] `selectedSector` derives from selectedSectorId
- [ ] `activeSector` returns either selectedSector or actionContextSector
- [ ] `controlMap` correctly determines sector control
- [ ] `selectedSectorStash` returns equipment in active sector's stash
- [ ] All ability flags (hasDoc, hasSquidhead, etc.) computed correctly
- [ ] TypeScript types exported for Sector and SectorState
