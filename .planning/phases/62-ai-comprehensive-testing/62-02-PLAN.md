---
phase: 62-ai-comprehensive-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/dictator-setup-reactive.test.ts
autonomous: true

must_haves:
  truths:
    - "Mao and Mussolini setup abilities correctly add bonus MERCs with squad placement"
    - "Hussein setup ability expands tactics deck to 10 cards"
    - "Gaddafi loot processing equips dictator MERCs with dead rebel equipment"
    - "Pinochet pending hires trigger when sector control is lost"
    - "Pol Pot conditional hire triggers after lost combat"
  artifacts:
    - path: "tests/dictator-setup-reactive.test.ts"
      provides: "Unit tests for setup and reactive abilities"
      min_lines: 150
  key_links:
    - from: "tests/dictator-setup-reactive.test.ts"
      to: "src/rules/dictator-abilities.ts"
      via: "direct function imports"
      pattern: "import.*(applyMaoSetup|applyMussoliniSetup|applyHusseinSetup|processGaddafiLoot|applyPinochetPending)"
---

<objective>
Write unit tests for dictator setup-phase abilities (Mao, Mussolini, Hussein) and reactive abilities (Gaddafi loot, Pinochet pending hires, Pol Pot conditional hire).

Purpose: Verify that setup abilities correctly modify initial game state and reactive abilities respond correctly to combat/control-change triggers.

Output: `tests/dictator-setup-reactive.test.ts` with test suites for all setup and reactive abilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-ai-comprehensive-testing/62-RESEARCH.md

@src/rules/dictator-abilities.ts (setup + reactive ability functions)
@src/rules/game.ts (MERCGame, MERCPlayer types)
@src/rules/elements.ts (CombatantModel, Sector, Equipment)
@tests/smoke.test.ts (createTestGame pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for setup abilities</name>
  <files>tests/dictator-setup-reactive.test.ts</files>
  <action>
Create `tests/dictator-setup-reactive.test.ts` with two top-level describe blocks: "Setup Abilities" and "Reactive Abilities".

**IMPORTANT:** Use internal combatant IDs: `mao`, `mussolini`, `hussein`, `gadafi`, `pinochet`, `polpot`.

**Setup Abilities tests:**

`describe('Setup Abilities')`:

1. **Hussein setup** (`applyHusseinSetupAbility`): Create game, set dictator to Hussein, call the setup function. Verify the dictator player's tactics deck/hand size increased to 10 (Hussein gets 10 tactics cards instead of the normal 5). Seed: `hussein-setup-test`.

2. **Mao setup** (`applyMaoSetupAbility`): Create game with 2 players (1 rebel), set dictator to Mao, ensure MERC deck has cards. Call setup function. Verify dictator hired MERCs increased by 1 (1 per rebel player). The AI path should auto-assign squad placement. Seed: `mao-setup-test`.

3. **Mussolini setup** (`applyMussoliniSetupAbility`): Same pattern as Mao. Create game, set dictator to Mussolini, call setup. Verify MERC count increased by 1 per rebel. Seed: `mussolini-setup-test`.

**Key:** These setup functions check `game.dictatorPlayer.isAI` to decide AI vs human path. Ensure the dictator player has `isAI = true`. You may need to use GameRunner with `dictatorIsAI: true` and `isAI: true` in playerConfigs (see ai-rebel-batching.test.ts pattern) instead of createTestGame.

**Key:** The setup functions may need to be called at the right time in game initialization. Read each function's code to understand what game state it expects. If `applyMaoSetupAbility` needs rebel players to exist with seats, ensure game is started first.
  </action>
  <verify>`npx vitest run tests/dictator-setup-reactive.test.ts` - setup tests pass.</verify>
  <done>Setup ability tests pass for Hussein (10 tactics), Mao (bonus MERCs), and Mussolini (bonus MERCs).</done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for reactive abilities</name>
  <files>tests/dictator-setup-reactive.test.ts</files>
  <action>
Add reactive ability tests to the same file under `describe('Reactive Abilities')`:

1. **Gaddafi loot** (`processGaddafiLoot`): Set up game with Gaddafi as dictator (AI). Manually set `game._gaddafiLootableEquipment` to an array with equipment data (see Research: `Array<{ equipmentId: number; sectorId: string }>`). Place a dictator MERC in the matching sector. Call `processGaddafiLoot(game)`. Verify the dictator MERC received equipment (check equipment slots). Seed: `gadafi-loot-test`.

2. **Pinochet pending hires** (`applyPinochetPendingHires`): Set up game with Pinochet as dictator (AI). Set `game._pinochetPendingHires = 1`. Call `applyPinochetPendingHires(game)`. Verify a MERC was hired (count increases). Verify `_pinochetPendingHires` is decremented/cleared. Seed: `pinochet-hire-test`.

3. **Pinochet damage spread** (`applyPinochetDamageSpread`): Set up game with Pinochet. Ensure rebel-controlled sectors exist and rebel MERCs are in play. Call `applyPinochetDamageSpread(game)`. Verify damage was applied to rebel combatants (sum of damage across rebels > 0). Seed: `pinochet-damage-test`.

4. **Pol Pot conditional hire**: Set `game.lastAbilityCombatOutcome = { rebelVictory: true, sectorId: 'some-sector' }`. The conditional hire is checked in flow.ts, not directly testable as a standalone function. Instead, test the Pol Pot turn ability with the combat outcome set - if `applyPolpotTurnAbility` has a branch for this, test it. If the conditional hire is purely flow-driven, add a comment noting it's covered by integration tests in Plan 03.

**Key constraint:** For Gaddafi loot, you need actual Equipment elements in the game. Equipment is drawn from decks. Either draw equipment first and record its element ID, or find existing equipment on a MERC. The `equipmentId` in `_gaddafiLootableEquipment` is the BoardSmith element ID (number), not the string equipment name.

**Key constraint:** For Pinochet damage spread, rebel MERCs need to be alive and in sectors. Use `game.gameMap.getAllSectors()` to find sectors, and ensure rebels have team members placed.
  </action>
  <verify>`npx vitest run tests/dictator-setup-reactive.test.ts` - all tests pass.</verify>
  <done>All reactive ability tests pass: Gaddafi loot equips MERCs, Pinochet hires and spreads damage, Pol Pot conditional hire covered.</done>
</task>

</tasks>

<verification>
- `npx vitest run tests/dictator-setup-reactive.test.ts` passes all tests
- Setup tests verify: Hussein 10 tactics, Mao bonus MERCs, Mussolini bonus MERCs
- Reactive tests verify: Gaddafi loot, Pinochet hires + damage, Pol Pot (or noted as flow-only)
</verification>

<success_criteria>
- tests/dictator-setup-reactive.test.ts exists with Setup Abilities and Reactive Abilities describe blocks
- At least 6 passing tests covering all setup and reactive abilities
- Tests verify actual game state mutations, not just "no throw"
</success_criteria>

<output>
After completion, create `.planning/phases/62-ai-comprehensive-testing/62-02-SUMMARY.md`
</output>
