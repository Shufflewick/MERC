---
phase: 01-type-safety-combat
plan: 01
type: execute
---

<objective>
Replace all `any[]` types in combat state with proper `Combatant[]`, `CombatResult[]`, and `Equipment[]` types.

Purpose: Restore type safety to combat state, enabling IDE autocomplete and catching type errors at compile time instead of runtime.
Output: Zero `any[]` usages in game.ts and actions/index.ts, all combat state properly typed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md

**Key files:**
@src/rules/game.ts - Main file with `activeCombat` state using any[]
@src/rules/combat.ts - Defines `Combatant` and `CombatResult` interfaces (lines 63-97)
@src/rules/elements.ts - Defines `Equipment` class (line 833)
@src/rules/actions/index.ts - Debug helpers with any[] casts

**Current state:**
- `combat.ts` exports `Combatant`, `CombatResult`, `CombatRound`, `CombatOutcome` interfaces
- `game.ts` imports from `combat.ts` is NOT circular (combat.ts imports types from game.ts, type-only imports break cycles)
- 9 `any[]` usages in game.ts (lines 448-451, 453-454, 457-458, 462, 542)
- 4 `any[]` usages in actions/index.ts (lines 231, 332-335)

**Why `any[]` was used:**
- Comments like `// Combatant[]` suggest the developer knew the correct type
- Likely a workaround for perceived circular dependency (which TypeScript type imports handle fine)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add type imports and fix activeCombat state types in game.ts</name>
  <files>src/rules/game.ts</files>
  <action>
1. Add type-only import at top of file (after existing imports, before JSON imports):
   `import type { Combatant, CombatResult } from './combat.js';`

2. Replace all `any[]` in `activeCombat` property (lines 444-500 region):
   - Line 448: `rebelCombatants: any[]` → `rebelCombatants: Combatant[]`
   - Line 449: `dictatorCombatants: any[]` → `dictatorCombatants: Combatant[]`
   - Line 450: `rebelCasualties: any[]` → `rebelCasualties: Combatant[]`
   - Line 451: `dictatorCasualties: any[]` → `dictatorCasualties: Combatant[]`
   - Line 453: `dogAssignments?: Array<[string, any]>` → `dogAssignments?: Array<[string, Combatant]>`
   - Line 454: `dogs?: any[]` → `dogs?: Combatant[]`
   - Line 457: `roundResults?: any[]` → `roundResults?: CombatResult[]`
   - Line 458: `roundCasualties?: any[]` → `roundCasualties?: Combatant[]`
   - Line 462: `validTargets: any[]` → `validTargets: Combatant[]`

3. Remove inline comments that documented the intended types (e.g., `// Combatant[]`) - they're now redundant.

4. Fix pendingLoot type (line 542):
   - `pendingLoot: { sectorId: string; equipment: any[] }` → `pendingLoot: { sectorId: string; equipment: Equipment[] }`
   - Equipment is already imported from './elements.js'

**Avoid:** Don't change any runtime behavior. These are purely type annotations.
**Why type-only import:** Using `import type` ensures no runtime circular dependency, only compile-time type information.
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>All 10 `any[]` usages in game.ts replaced with proper types, type check passes</done>
</task>

<task type="auto">
  <name>Task 2: Remove unnecessary casts in actions/index.ts</name>
  <files>src/rules/actions/index.ts</files>
  <action>
1. Line 231: Replace `const result: any[]` with properly typed array:
   ```typescript
   const result: Array<{
     player: number;
     squad: 'primary' | 'secondary';
     sectorId: string;
     mercs: Array<{ name: string; actions: number }>;
   }> = [];
   ```

2. Lines 332-335: Remove redundant `as any[]` casts since game.activeCombat is now properly typed:
   - Line 332: `(game.activeCombat.rebelCombatants as any[])?.length` → `game.activeCombat.rebelCombatants?.length`
   - Line 333: `(game.activeCombat.dictatorCombatants as any[])?.length` → `game.activeCombat.dictatorCombatants?.length`
   - Line 334: `(game.activeCombat.rebelCasualties as any[])?.length` → `game.activeCombat.rebelCasualties?.length`
   - Line 335: `(game.activeCombat.dictatorCasualties as any[])?.length` → `game.activeCombat.dictatorCasualties?.length`

**Avoid:** Don't add imports - these are debug helpers that just read `.length`, no type imports needed.
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>All `any[]` usages in actions/index.ts removed, type check passes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm test` passes (no regressions)
- [ ] `grep -r "any\[\]" src/rules/game.ts` returns no matches
- [ ] `grep -r "any\[\]" src/rules/actions/index.ts` returns no matches
</verification>

<success_criteria>

- All tasks completed
- Zero `any[]` usages remain in game.ts and actions/index.ts
- Type check passes
- All existing tests pass
- IDE autocomplete works on activeCombat properties
</success_criteria>

<output>
After completion, create `.planning/phases/01-type-safety-combat/01-01-SUMMARY.md`
</output>
