---
phase: 17-hiring-unification
plan: 01
type: execute
---

<objective>
Unify MERC hiring logic so dictator hires get the same special ability handling as rebel hires.

Purpose: Currently Apeiron (won't use grenades/mortars) and Vrbansk (free accessory) abilities only trigger when rebels hire them. Dictator hiring paths bypass this logic, creating inconsistent gameplay.
Output: Shared hire helper function used by both rebel and dictator paths, ensuring all MERC-specific hiring abilities trigger correctly.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-abilities-for-controller/16-01-SUMMARY.md

# Prior decisions:
# - Phase 10: Equipment overrides (Apeiron/Gunther/Genesis) moved to CombatUnitCard using unitId checks
# - Phase 11: Use isMerc property with type cast for Apeiron special cases

# Key files:
@src/rules/day-one.ts - hireDictatorMerc() at line 243 - Day 1 hire (no Apeiron/Vrbansk handling)
@src/rules/dictator-abilities.ts - castroBonusHireAI() at line 110 - AI Castro hire (no Apeiron/Vrbansk handling)
@src/rules/actions/dictator-actions.ts - createCastroBonusHireAction() at line 342 - Human Castro hire (no Apeiron/Vrbansk handling)
@src/rules/actions/rebel-economy.ts - lines 241-287 - Rebel hire HAS Apeiron/Vrbansk handling

# The problem:
# Rebel hire path (rebel-economy.ts lines 241-287) has:
# - MERC-70a: Apeiron grenade/mortar redraw logic
# - MERC-9mxd: Vrbansk free accessory logic
#
# Dictator hire paths have NONE of this:
# - hireDictatorMerc (day-one.ts) - Day 1 random hire
# - castroBonusHireAI (dictator-abilities.ts) - AI Castro per-turn
# - createCastroBonusHireAction (dictator-actions.ts) - Human Castro per-turn
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared equipNewHire helper function</name>
  <files>src/rules/actions/helpers.ts</files>
  <action>
Create a new exported function `equipNewHire(game: MERCGame, merc: MercCard, equipType: 'Weapon' | 'Armor' | 'Accessory'): void` in helpers.ts that encapsulates the Apeiron/Vrbansk hiring logic.

Extract the logic from rebel-economy.ts lines 241-287:
1. Draw equipment of specified type
2. MERC-70a: If Apeiron and equipment is grenade/mortar, discard and redraw (up to 3 attempts)
3. Equip the equipment
4. MERC-9mxd: If Vrbansk and no accessory equipped, draw and equip free accessory

Import isGrenadeOrMortar from elements.ts for the Apeiron check.

The function should handle messages via game.message() just like the existing code.
  </action>
  <verify>grep -n "equipNewHire" src/rules/actions/helpers.ts shows the new function</verify>
  <done>New equipNewHire function exists in helpers.ts with Apeiron/Vrbansk logic</done>
</task>

<task type="auto">
  <name>Task 2: Update all dictator hire paths to use equipNewHire</name>
  <files>src/rules/day-one.ts, src/rules/dictator-abilities.ts, src/rules/actions/dictator-actions.ts</files>
  <action>
Update the 3 dictator hire paths to use the new equipNewHire helper:

1. **hireDictatorMerc in day-one.ts** (lines 262-271):
   - Import equipNewHire from './actions/helpers.js'
   - Replace the simple equipment draw/equip with: `equipNewHire(game, merc, equipType)`
   - Remove the old freeEquipment draw and equip lines

2. **castroBonusHireAI in dictator-abilities.ts** (lines 140-149):
   - Import equipNewHire from './actions/helpers.js'
   - Replace the simple equipment draw/equip with: `equipNewHire(game, bestMerc, equipType)`
   - Remove the old freeEquipment draw and equip lines

3. **createCastroBonusHireAction in dictator-actions.ts** (lines 485-490):
   - Import equipNewHire from './helpers.js'
   - Replace the simple equipment draw/equip with: `equipNewHire(game, selectedMerc, equipType)`
   - Remove the old freeEquipment draw and equip lines

NOTE: Keep the existing equipType selection logic (prioritize weapon if no weapon, etc.) - only replace the actual draw/equip.
  </action>
  <verify>grep -rn "equipNewHire" src/rules/ shows 4 occurrences (1 definition + 3 calls)</verify>
  <done>All dictator hire paths use equipNewHire helper</done>
</task>

<task type="auto">
  <name>Task 3: Update rebel hire path to use shared helper</name>
  <files>src/rules/actions/rebel-economy.ts</files>
  <action>
Refactor the rebel hire path (hireMerc action, lines ~240-290) to use the new equipNewHire helper:

1. Import equipNewHire (it's in the same directory, so './helpers.js')
2. Replace the inline Apeiron/Vrbansk handling (lines 241-287) with a call to `equipNewHire(game, merc, equipType)`
3. Keep the equipType selection logic that precedes it

This ensures all hire paths share the exact same implementation, preventing future divergence.
  </action>
  <verify>grep -n "equipNewHire" src/rules/actions/rebel-economy.ts shows the function is used</verify>
  <done>Rebel hire path uses shared equipNewHire helper</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `equipNewHire` function exists in helpers.ts
- [ ] grep -rn "equipNewHire" src/rules/ shows exactly 5 occurrences (1 definition, 4 calls)
- [ ] npm run build succeeds without errors
- [ ] grep -n "MERC-70a" src/rules/actions/helpers.ts confirms Apeiron logic is in helper
- [ ] grep -n "MERC-9mxd" src/rules/actions/helpers.ts confirms Vrbansk logic is in helper
</verification>

<success_criteria>

- equipNewHire helper function created with Apeiron/Vrbansk special handling
- All 4 hire paths (rebel + 3 dictator) use the shared helper
- No duplicate Apeiron/Vrbansk logic in any file
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-hiring-unification/17-01-SUMMARY.md`
</output>
