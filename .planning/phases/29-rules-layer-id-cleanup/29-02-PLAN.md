---
phase: 29-rules-layer-id-cleanup
plan: 02
type: execute
---

<objective>
Update action layer to use combatantId in args, display, and local variables.

Purpose: Complete the rules layer cleanup by updating action definitions that use mercId.
Output: All action files use consistent combatantId naming in args and variables.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-rules-layer-id-cleanup/29-01-SUMMARY.md

**Prior work:** Plan 01 updated core state types and combat utilities to use combatantId.

**Files to update in this plan:**
- src/rules/actions/rebel-economy.ts (~10 changes)
- src/rules/actions/rebel-equipment.ts (~21 changes)
- src/rules/actions/day-one-actions.ts (~5 changes)

**Files to SKIP (semantically correct):**
- src/rules/actions/helpers.ts - `canHireMercWithTeam(mercId)` is specifically for hiring a MERC, not generic combatant
- src/rules/merc-abilities.ts - all functions are MERC-specific ability lookups
- src/rules/setup.ts - `dictatorId` selects which dictator character to use
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update rebel-economy.ts</name>
  <files>src/rules/actions/rebel-economy.ts</files>
  <action>
Update the following patterns:

1. **collectEquipment action followUp args** (lines 400-408):
   Change:
   ```
   args: {
     mercId: actingUnit.id,
     sectorId: sector.id,
   },
   display: {
     mercId: capitalize(unitName),
     sectorId: sector.sectorName,
   },
   ```
   To:
   ```
   args: {
     combatantId: actingUnit.id,
     sectorId: sector.id,
   },
   display: {
     combatantId: capitalize(unitName),
     sectorId: sector.sectorName,
   },
   ```

2. **getUnit helper** (lines 458-462):
   Change:
   ```
   const mercArg = ctx.args?.mercId;
   ```
   To:
   ```
   const combatantArg = ctx.args?.combatantId;
   ```
   Update variable name `mercArg` to `combatantArg` throughout the function.

3. **takeFromStash action followUp args** (lines 545-553):
   Change `mercId:` to `combatantId:` in both args and display objects.

4. **findExplorerUnit** (line 576):
   Change `const unitId = game.lastExplorer.mercId;`
   To: `const unitId = game.lastExplorer.combatantId;`

5. **lastExplorer assignments** (lines 670, 675):
   Change `{ mercId: String(targetUnit.id), sectorId: ... }`
   To: `{ combatantId: String(targetUnit.id), sectorId: ... }`
  </action>
  <verify>npm run build passes</verify>
  <done>rebel-economy.ts uses combatantId in all action args and variables</done>
</task>

<task type="auto">
  <name>Task 2: Update rebel-equipment.ts</name>
  <files>src/rules/actions/rebel-equipment.ts</files>
  <action>
Update the following patterns:

1. **reEquip action followUp args** (lines 232-242):
   Change `mercId:` to `combatantId:` in both args and display objects.

2. **getUnit helper** (lines 262-268):
   Change `const mercArg = ctx.args?.mercId;`
   To: `const combatantArg = ctx.args?.combatantId;`
   Update variable name throughout the function.

3. **Condition check** (line 302):
   Change `ctx.args?.mercId == null`
   To: `ctx.args?.combatantId == null`

4. **reEquipContinue followUp args** (lines 376-386):
   Change `mercId:` to `combatantId:` in both args and display objects.

5. **getMercOrNull helper variables** (lines 433-447):
   Change local variable `let mercId: number | undefined;`
   To: `let combatantId: number | undefined;`
   Update all references in the function.

6. **equipToMerc conditions/options** (lines 519-530):
   Change local `let mercId: number | undefined;`
   To: `let combatantId: number | undefined;`
   Update all references.

7. **equipToMerc execute block** (lines 541-551):
   Change local `let mercId: number | undefined;`
   To: `let combatantId: number | undefined;`
   Update all references.
  </action>
  <verify>npm run build passes</verify>
  <done>rebel-equipment.ts uses combatantId in all action args and variables</done>
</task>

<task type="auto">
  <name>Task 3: Update day-one-actions.ts</name>
  <files>src/rules/actions/day-one-actions.ts</files>
  <action>
Update the following patterns:

1. **Lines 622-627** - getDrawnMerc helper:
   Change `const mercId = getGlobalCachedValue<number>(game, DRAWN_MERC_KEY);`
   To: `const combatantId = getGlobalCachedValue<number>(game, DRAWN_MERC_KEY);`
   Update references: `if (!combatantId) return null;`
   And: `const el = game.getElementById(combatantId);`

2. **Lines 677-680** - selectMercForHire execute:
   Change `const mercId = getGlobalCachedValue<number>(game, DRAWN_MERC_KEY);`
   To: `const combatantId = getGlobalCachedValue<number>(game, DRAWN_MERC_KEY);`
   Update: `const mercEl = combatantId ? game.getElementById(combatantId) : null;`

Search for any other `mercId` local variables and update to `combatantId`.
  </action>
  <verify>npm run build && npm test</verify>
  <done>day-one-actions.ts uses combatantId in all local variables</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all 524+ tests
- [ ] `grep "args?.mercId" src/rules/actions/` returns empty
- [ ] `grep "mercId:" src/rules/actions/rebel-economy.ts` returns empty (except comments)
- [ ] `grep "mercId:" src/rules/actions/rebel-equipment.ts` returns empty (except comments)
- [ ] Phase 29 complete - all rules layer files updated
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Action args use combatantId consistently
- Local variables use combatantId naming
- No TypeScript errors
- No test regressions
- Phase 29 fully complete
</success_criteria>

<output>
After completion, create `.planning/phases/29-rules-layer-id-cleanup/29-02-SUMMARY.md`

Then update STATE.md:
- Current position: Phase 29 complete, ready for Phase 30
- Progress: 67% (2 of 3 v1.6 phases)
</output>
