---
phase: 29-rules-layer-id-cleanup
plan: 01
type: execute
---

<objective>
Update core state types and combat functions to use combatantId instead of mercId.

Purpose: Establish consistent naming in type definitions that propagate to the entire codebase.
Output: Clean state interfaces and combat utilities using canonical combatantId naming.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-remove-legacy-comments/28-01-SUMMARY.md

**Prior work:** Phase 28 removed legacy comments. Now cleaning up the remaining mercId/dictatorId variable names in rules layer.

**Key insight:** The merc-abilities.ts file uses `mercId` semantically correctly (functions only apply to MERCs). Same for `dictatorId` in setup (selects dictator character). These should NOT be renamed.

**Files to update in this plan:**
- src/rules/game.ts (~7 changes in state types)
- src/rules/combat.ts (~13 changes in utilities)

**Reference for consistency:**
- src/rules/actions/rebel-combat.ts already uses `combatantId` at line 1048
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update game.ts state types</name>
  <files>src/rules/game.ts</files>
  <action>
Update the following state type definitions:

1. **lastExplorer type** (line 573):
   Change `lastExplorer: { mercId: string; sectorId: string } | null`
   To: `lastExplorer: { combatantId: string; sectorId: string } | null`

2. **pendingEpinephrine type** (lines 525-528):
   Change:
   ```
   pendingEpinephrine?: {
     dyingMercId: number;
     dyingMercName: string;
     dyingMercSide: 'rebel' | 'dictator';
     availableSavers: Array<{ mercId: number; mercName: string }>;
   };
   ```
   To:
   ```
   pendingEpinephrine?: {
     dyingCombatantId: number;
     dyingCombatantName: string;
     dyingCombatantSide: 'rebel' | 'dictator';
     availableSavers: Array<{ combatantId: number; combatantName: string }>;
   };
   ```

**DO NOT change:**
- `dictatorId` in MERCGameOptions (line 65) - semantically correct, selects which dictator character
- `dictatorId` in performSetup parameter (line 932) - same, selects dictator
- `dictatorId` in setupDictator (line 984) - same

These are configuration options that specify "which dictator to use", not identity fields.
  </action>
  <verify>npm run build passes (TypeScript will catch all usages that need updating)</verify>
  <done>State types in game.ts use combatantId/combatantName consistently</done>
</task>

<task type="auto">
  <name>Task 2: Update combat.ts utilities</name>
  <files>src/rules/combat.ts</files>
  <action>
Update the following:

1. **Rename getCombatantMercId function** (lines 92-98):
   Change function name from `getCombatantMercId` to `getCombatantId`
   Update the JSDoc comment to: "Get combatantId from a combatant (undefined if militia/other)"

2. **Update isMerc function parameter** (lines 112-116):
   Change parameter from `mercId` to `combatantId`
   Update JSDoc: "Check if combatant has a specific combatantId"
   Update implementation: `return getCombatantId(combatant) === combatantId;`

3. **Update local variables** in countHitsForCombatant (lines 142-154):
   Change `const mercId = ...` to `const combatantId = ...`
   Update reference: `const threshold = combatantId ? getHitThreshold(combatantId) : ...`

4. **Update local variables** in shouldUseReroll (lines 163-169):
   Change `const mercId = ...` to `const combatantId = ...`
   Update all references in that block

5. **Update sortByInitiative local variables** (lines 942-946):
   Change `aMercId` and `bMercId` to `aCombatantId` and `bCombatantId`
   Update all references in the sort function

6. **Update selectTarget local variable** (line 1362):
   Change `const mercId = getCombatantMercId(t)` to `const combatantId = getCombatantId(t)`
   Update reference on line 1363

7. **Update sortedForTargeting local variables** (lines 1435-1438):
   Change `aMercId`/`bMercId` to `aCombatantId`/`bCombatantId`
   Update all references

8. **Update pendingHitAllocation** (lines 1979-1992):
   Change `const mercId = getCombatantMercId(attacker)` to `const combatantId = getCombatantId(attacker)`
   Update references in canUseReroll check
   Change `attackerMercId: mercId ?? ''` to `attackerCombatantId: combatantId ?? ''`

9. **Update pendingEpinephrine assignments** (lines 2116-2121, 2174-2179):
   Change field names to match new type:
   - `dyingMercId` → `dyingCombatantId`
   - `dyingMercName` → `dyingCombatantName`
   - `dyingMercSide` → `dyingCombatantSide`
   - `availableSavers` array: `mercId` → `combatantId`, `mercName` → `combatantName`

**Note:** The `getHitThreshold(combatantId)` and similar merc-abilities.ts function calls remain semantically correct - they accept a combatant ID and internally only work for MERCs.
  </action>
  <verify>npm run build passes, npm test passes</verify>
  <done>combat.ts uses combatantId consistently, functions renamed appropriately</done>
</task>

<task type="auto">
  <name>Task 3: Update combat action usages</name>
  <files>src/rules/actions/rebel-combat.ts</files>
  <action>
Update usages of the renamed pendingEpinephrine fields:

1. **Line 1048** - already uses `s.combatantId` (no change needed, validates type works)

2. **Line 1060** - Update reference:
   Change `pending.dyingMercId` → `pending.dyingCombatantId`

3. **Line 1070-1086** area - Update any references to dyingMerc* fields

4. **Lines around 1120-1162** - Update any remaining references

Search for all `pending.dyingMerc` and `pending.availableSavers` references and update field names.

Also check if `attackerMercId` is used anywhere:
- If pendingHitAllocation is accessed, update `attackerMercId` → `attackerCombatantId`
  </action>
  <verify>npm run build && npm test</verify>
  <done>All combat action files use updated field names</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all 524+ tests
- [ ] `grep -r "mercId" src/rules/game.ts` returns only dictatorId setup context (lines 65, 754-757, 932, 984-989)
- [ ] `grep "getCombatantMercId" src/rules/` returns empty (function renamed)
- [ ] `grep "dyingMercId" src/rules/` returns empty (field renamed)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- State types use combatantId/combatantName
- Combat utilities use combatantId naming
- No TypeScript errors
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/29-rules-layer-id-cleanup/29-01-SUMMARY.md`
</output>
