---
phase: 55-simultaneous-play-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/flow.ts
  - src/ui/components/GameTable.vue
autonomous: false

must_haves:
  truths:
    - "PlayersPanel shows all active rebels during simultaneous step (not one at a time)"
    - "ActionPanel shows 'Waiting for [Name1], [Name2]' when current player finishes"
    - "All players see game state updates in real-time during simultaneous play"
    - "When combat barrier activates, a brief overlay explains why actions paused before combat panel appears"
  artifacts:
    - path: "src/rules/flow.ts"
      provides: "combat-barrier animation event fired before combat resolution in rebel phase"
      contains: "combat-barrier"
    - path: "src/ui/components/GameTable.vue"
      provides: "Combat barrier overlay handler and template"
      contains: "combat-barrier"
  key_links:
    - from: "src/rules/flow.ts"
      to: "src/ui/components/GameTable.vue"
      via: "game.animate('combat-barrier', ...) -> animationEvents.registerHandler('combat-barrier', ...)"
      pattern: "combat-barrier"
---

<objective>
Add a combat barrier transition overlay so players understand why simultaneous actions paused when combat triggers. Also verify that UI-01 (turn indicators), UI-02 (waiting messages), and UI-03 (real-time visibility) already work correctly via existing BoardSmith infrastructure.

Purpose: Complete the v2.0 simultaneous play experience with clear visual feedback at every state transition.
Output: Combat barrier overlay in GameTable.vue, animation event in flow.ts, all four UI requirements verified.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-simultaneous-play-ui/55-RESEARCH.md
@src/rules/flow.ts
@src/ui/components/GameTable.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fire combat-barrier animation event from flow.ts</name>
  <files>src/rules/flow.ts</files>
  <action>
In the rebel-phase loop (around line 620), add a `game.animate('combat-barrier', ...)` call BEFORE the pending combat initiation block. This fires when the rebel-phase loop re-enters after the simultaneous step exits due to a barrier condition.

The key insight: The rebel-phase loop's `while` condition keeps the loop running when `pendingCombat`, `activeCombat`, `coordinatedAttack`, or `pendingMortarAttack` is set. When the simultaneous step's `allDone` returns true due to one of these conditions, control flows to the next iteration of the rebel-phase loop. That means the top of the loop body (the `sequence(...)` starting around line 620) is where we detect we're in a barrier transition.

Add an `execute()` block at the very start of the rebel-phase loop's `sequence(...)`, BEFORE the existing pending combat initiation block (line 622). This new block should:

1. Check if we're re-entering due to a combat barrier (not first entry, not all-rebels-done):
   ```typescript
   execute(() => {
     const hasCombatBarrier =
       (game.pendingCombat !== null || game.pendingCombatQueue.length > 0) ||
       (game.activeCombat !== null && !game.activeCombat.combatComplete) ||
       game.coordinatedAttack !== null ||
       game.pendingMortarAttack != null;
     if (hasCombatBarrier) {
       game.animate('combat-barrier', {}, () => {});
     }
   }),
   ```

Use the empty callback pattern `() => {}` since this is a pure UI signal with no state mutations.

Do NOT add this event to the Day 1 flow (lines 314-457 area) -- Day 1 landing does not have combat barriers.
  </action>
  <verify>
Run `grep -n 'combat-barrier' src/rules/flow.ts` to confirm the animation event is added.
Run `npx vitest run tests/` to confirm no tests break.
  </verify>
  <done>flow.ts fires a `combat-barrier` animation event when the rebel-phase loop re-enters due to a combat barrier condition, and all existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Register combat-barrier handler and add overlay in GameTable.vue</name>
  <files>src/ui/components/GameTable.vue</files>
  <action>
Add a combat barrier overlay to GameTable.vue following the established tactics banner pattern.

**1. Add reactive ref** (near other animation-related refs like `combatSnapshot`, `activeTacticEvent`):
```typescript
const combatBarrierActive = ref(false);
```

**2. Register animation handler** (near the other registerHandler calls, around line 666):
```typescript
animationEvents.registerHandler('combat-barrier', async () => {
  combatBarrierActive.value = true;
  await new Promise<void>((resolve) => {
    setTimeout(() => {
      combatBarrierActive.value = false;
      resolve();
    }, 2000);
  });
}, { skip: 'drop' });
```

Use `skip: 'drop'` (same as tactics events) so skipping animations drops the barrier banner entirely.

Display for 2000ms (same duration as sector-targeted tactics events) -- long enough to read, short enough not to delay combat.

**3. Add overlay template** BEFORE the CombatPanel (around line 1400, after the tactics banner overlay and before the CombatPanel):
```vue
<!-- Combat Barrier Banner - shown when simultaneous actions pause for combat -->
<GameOverlay :active="combatBarrierActive" :backdrop-opacity="0.5">
  <div class="combat-barrier-content" @click.stop>
    <div class="combat-barrier-label">Combat Detected</div>
    <div class="combat-barrier-description">Simultaneous actions paused while combat resolves</div>
  </div>
</GameOverlay>
```

**4. Add styles** (in the `<style>` section, near the `.tactics-banner-*` styles):
```css
.combat-barrier-content {
  text-align: center;
  color: white;
  animation: barrier-fade-in 0.3s ease-out;
}

.combat-barrier-label {
  font-size: 2rem;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #ff6b6b;
  text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
}

.combat-barrier-description {
  font-size: 1.1rem;
  margin-top: 0.5rem;
  opacity: 0.85;
}

@keyframes barrier-fade-in {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
```

Use a red-tinted color scheme to visually distinguish from the yellow/gold tactics banners and signal "combat/danger."
  </action>
  <verify>
Run `npx vue-tsc --noEmit` (or the project's type check command) to verify no type errors.
Visually inspect the template structure -- GameOverlay should appear BEFORE CombatPanel in the template order so the barrier banner shows first, then combat panel replaces it.
  </verify>
  <done>GameTable.vue has a combat-barrier animation handler that shows a 2-second overlay banner, styled with red accent colors, positioned before the CombatPanel in template order.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Combat barrier transition overlay (UI-04) plus verification that existing BoardSmith infrastructure handles UI-01, UI-02, and UI-03.
  </what-built>
  <how-to-verify>
Start a multiplayer game with 2+ rebel players (can use AI rebels).

1. **UI-01 - Turn indicators**: During the rebel phase simultaneous step, confirm PlayersPanel shows ALL active rebels with the blue glow/pulsing dot (not cycling through one at a time).

2. **UI-02 - Waiting message**: Have one rebel end their turn while others still have actions. Confirm that rebel's ActionPanel shows "Waiting for [Name1], [Name2]" with the remaining rebel names.

3. **UI-03 - Real-time visibility**: While rebels act simultaneously, confirm that one rebel's actions (movement, equipment changes) are immediately visible to other players' game views (map updates, squad changes appear in real-time).

4. **UI-04 - Combat barrier**: Move a rebel into a sector with dictator units to trigger combat. Confirm:
   - A "Combat Detected / Simultaneous actions paused while combat resolves" overlay appears briefly (~2 seconds)
   - The overlay uses red-tinted styling (distinct from gold tactics banners)
   - After the overlay fades, the combat panel appears normally
   - After combat resolves, remaining rebels can continue their simultaneous actions
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues with any of the four requirements.</resume-signal>
</task>

</tasks>

<verification>
- All existing tests pass (no regressions from flow.ts changes)
- Type checking passes (no errors from GameTable.vue additions)
- Combat barrier overlay appears during barrier transitions in live gameplay
- UI-01, UI-02, UI-03 confirmed working through manual verification
</verification>

<success_criteria>
1. PlayersPanel shows all active rebels during simultaneous step
2. ActionPanel shows specific player names when waiting
3. All players see real-time state updates during simultaneous play
4. Combat barrier produces a brief, styled overlay before combat panel appears
</success_criteria>

<output>
After completion, create `.planning/phases/55-simultaneous-play-ui/55-01-SUMMARY.md`
</output>
