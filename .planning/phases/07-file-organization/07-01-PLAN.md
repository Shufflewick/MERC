---
phase: 07-file-organization
plan: 01
type: execute
---

<objective>
Split combat.ts (2,879 lines) into logical modules for better maintainability.

Purpose: Reduce file size for faster IDE navigation, clearer code organization, and easier future maintenance.
Output: Multiple focused combat modules with a barrel export file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/rules/combat.ts

**Constraints from v1.0:**
- Must maintain all existing exports
- Must not break any imports from other files
- All tests must continue to pass
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create combat-types.ts with interfaces and constants</name>
  <files>src/rules/combat-types.ts</files>
  <action>
    Extract from combat.ts (lines 59-112):
    - Combatant interface
    - CombatResult interface
    - CombatRound interface
    - CombatOutcome interface

    Keep imports minimal (only what's needed for the interfaces).
    Export all interfaces.
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>combat-types.ts exists with all 4 interfaces exported, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Create combat-retreat.ts with retreat logic</name>
  <files>src/rules/combat-retreat.ts</files>
  <action>
    Extract from combat.ts (lines 1335-1411):
    - getValidRetreatSectors function
    - canRetreat function
    - executeRetreat function

    Import Combatant from combat-types.ts.
    Import game types and elements as needed.
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>combat-retreat.ts exists with 3 functions exported, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 3: Update combat.ts to use new modules and re-export</name>
  <files>src/rules/combat.ts</files>
  <action>
    1. Remove the extracted interfaces and functions from combat.ts
    2. Import from new modules:
       - import { Combatant, CombatResult, CombatRound, CombatOutcome } from './combat-types.js'
       - import { getValidRetreatSectors, canRetreat, executeRetreat } from './combat-retreat.js'
    3. Re-export everything for backwards compatibility:
       - export { Combatant, CombatResult, CombatRound, CombatOutcome } from './combat-types.js'
       - export { getValidRetreatSectors, canRetreat, executeRetreat } from './combat-retreat.js'
    4. Keep all other code in combat.ts (main combat resolution is tightly coupled)
  </action>
  <verify>npm run build && npm test</verify>
  <done>combat.ts reduced by ~180 lines, all imports still work, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm test` passes all tests
- [ ] All existing imports of combat.ts work unchanged
- [ ] combat.ts is smaller than before (~2,700 lines)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No breaking changes to public API
- Code organization improved
</success_criteria>

<output>
After completion, create `.planning/phases/07-file-organization/07-01-SUMMARY.md`
</output>
