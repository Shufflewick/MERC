---
phase: 50-tactics-card-audit
plan: 04
type: execute
wave: 3
depends_on: ["50-03"]
files_modified:
  - src/rules/tactics-effects.ts
  - src/rules/game.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/flow.ts
autonomous: true

must_haves:
  truths:
    - "Lockdown places 5 * rebelCount militia on base or adjacent sectors"
    - "AI dictator auto-distributes militia evenly across base + adjacent sectors"
    - "Human dictator interactively picks sector and quantity for each placement"
    - "Militia placement respects the 10-per-sector cap"
    - "Lockdown reveals the dictator's base before placing militia"
    - "Combat is triggered if rebels are present in sectors receiving militia"
  artifacts:
    - path: "src/rules/tactics-effects.ts"
      provides: "Rewritten lockdown() that sets pendingLockdownMilitia"
      contains: "pendingLockdownMilitia"
    - path: "src/rules/game.ts"
      provides: "pendingLockdownMilitia state type and property"
      contains: "pendingLockdownMilitia"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "lockdownPlaceMilitia action following kimBonusMilitia pattern"
      contains: "lockdownPlaceMilitia"
    - path: "src/rules/flow.ts"
      provides: "Flow loop for lockdown militia placement after generalissimo loop"
      contains: "lockdown-militia"
  key_links:
    - from: "src/rules/tactics-effects.ts"
      to: "src/rules/game.ts"
      via: "sets pendingLockdownMilitia state"
      pattern: "game\\.pendingLockdownMilitia"
    - from: "src/rules/flow.ts"
      to: "src/rules/actions/dictator-actions.ts"
      via: "flow step lists lockdownPlaceMilitia action"
      pattern: "actions.*lockdownPlaceMilitia"
    - from: "src/rules/actions/dictator-actions.ts"
      to: "src/rules/game.ts"
      via: "decrements pendingLockdownMilitia.remaining and clears when 0"
      pattern: "pendingLockdownMilitia"
---

<objective>
Completely rewrite Lockdown to place 5 * rebelCount militia on base or adjacent sectors, per the authoritative CSV rules.

Purpose: The current Lockdown implementation is completely wrong — it sets a fabricated +1 armor bonus flag instead of placing militia. The correct behavior per "dictator tactics.csv" is: reveal base, get 5 extra militia per rebel player, place them on base or adjacent sectors.

Output: Working Lockdown card that places militia interactively (human) or auto-distributes (AI) on base and adjacent sectors, triggering combat when rebels are present.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-tactics-card-audit/50-RESEARCH.md
@.planning/phases/50-tactics-card-audit/50-01-SUMMARY.md
@.planning/phases/50-tactics-card-audit/50-02-SUMMARY.md
@.planning/phases/50-tactics-card-audit/50-03-SUMMARY.md
@src/rules/tactics-effects.ts (lockdown function)
@src/rules/actions/dictator-actions.ts (createKimBonusMilitiaAction at lines 533-597 — THE TEMPLATE to follow)
@src/rules/flow.ts (the generalissimo-hire loop added by plan 03 — add lockdown loop after it)
@src/rules/game.ts (pendingGeneralissimoHire added by plan 03 — add pendingLockdownMilitia nearby)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pending state and rewrite Lockdown effect</name>
  <files>
    src/rules/game.ts
    src/rules/tactics-effects.ts
  </files>
  <action>
**In src/rules/game.ts:**

Add a `pendingLockdownMilitia` property near `pendingGeneralissimoHire` (added by plan 03):

```typescript
// Pending Lockdown militia placement — dictator places militia on base/adjacent sectors
pendingLockdownMilitia: {
  remaining: number;           // Militia left to place
  validSectorIds: string[];    // Base sector + adjacent sector IDs
} | null = null;
```

Add a getter:
```typescript
get hasLockdownPending(): boolean {
  return this.pendingLockdownMilitia !== null;
}
```

**In src/rules/tactics-effects.ts:**

Completely rewrite the `lockdown()` function. Remove the old implementation that sets `lockdownActive = true`.

New implementation:
1. Call `revealBase(game)` first — base reveal is still part of this card. IMPORTANT: revealBase must complete BEFORE computing adjacent sectors, because the base location may be set during revealBase (Pitfall 3 from research).
2. Compute total militia: `const totalMilitia = 5 * game.rebelCount;`
3. Get base sector: `const baseSector = game.gameMap.getAllSectors().find(s => s.sectorId === game.dictatorPlayer.baseSectorId);`
4. If no base sector found (shouldn't happen after revealBase), return error.
5. Get adjacent sectors: `const adjacentSectors = game.getAdjacentSectors(baseSector);`
6. Build valid sector IDs: `[baseSector.sectorId, ...adjacentSectors.map(s => s.sectorId)]`

For AI dictator (`game.dictatorPlayer.isAI`):
- Auto-distribute evenly across base + adjacent sectors, respecting 10-per-sector cap
- Prioritize base sector first, then adjacent sectors
- Fire `game.animate('tactic-lockdown', { cardName: 'Lockdown', totalMilitia, sectors: placedSectors }, () => { /* placement mutations */ })`
- After placement, check each sector for rebel presence and call `queuePendingCombat` if needed (same pattern as reinforcements/kimBonusMilitia)

For human dictator:
- Set `game.pendingLockdownMilitia = { remaining: totalMilitia, validSectorIds }` and return
- The flow step + action will handle interactive placement
- Fire `game.animate('tactic-lockdown', { cardName: 'Lockdown', totalMilitia }, () => {})` as a UI signal

Remove the line `game.lockdownActive = true;` — this flag no longer exists (removed in plan 01).
  </action>
  <verify>
    `npx vitest run` passes. TypeScript compiles without errors. The lockdown function no longer references lockdownActive.
  </verify>
  <done>
    Lockdown effect computes correct militia count and valid sectors. AI auto-distributes. Human sets pending state for interactive flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create lockdownPlaceMilitia action and flow step</name>
  <files>
    src/rules/actions/dictator-actions.ts
    src/rules/flow.ts
  </files>
  <action>
**In src/rules/actions/dictator-actions.ts:**

Create `createLockdownPlaceMilitiaAction(game: MERCGame)` following the `createKimBonusMilitiaAction` pattern. This is a repeated placement action — the dictator picks a sector and places militia there, repeating until all militia are placed.

Key difference from Kim: Kim places ALL militia in one sector. Lockdown should let the player place a chosen quantity per sector (or place all remaining in one sector). The simplest approach that matches board game feel: each execution of the action places militia in one sector. The player picks sector and amount per iteration.

Action builder chain:
```typescript
Action.create('lockdownPlaceMilitia')
  .prompt('Lockdown: Place militia on base or adjacent sectors')
  .condition({
    'is dictator player': (ctx) => game.isDictatorPlayer(ctx.player),
    'has pending militia': () => game.pendingLockdownMilitia != null && game.pendingLockdownMilitia.remaining > 0,
    'is human player': () => !game.dictatorPlayer?.isAI,
  })
  .chooseFrom<string>('targetSector', {
    prompt: () => `Choose sector (${game.pendingLockdownMilitia?.remaining ?? 0} militia remaining)`,
    choices: () => {
      const pending = game.pendingLockdownMilitia;
      if (!pending) return [];
      return pending.validSectorIds
        .map(id => game.gameMap.getAllSectors().find(s => s.sectorId === id))
        .filter((s): s is Sector => s != null && s.dictatorMilitia < 10) // Respect 10 cap
        .map(s => `${s.sectorName} (${s.dictatorMilitia}/10)`);
    },
  })
  .chooseFrom<string>('amount', {
    prompt: 'How many militia to place here?',
    choices: () => {
      const remaining = game.pendingLockdownMilitia?.remaining ?? 0;
      // Offer 1 through remaining (or up to sector cap)
      const max = Math.min(remaining, 10);
      return Array.from({ length: max }, (_, i) => `${i + 1}`);
    },
  })
  .execute((args, ctx) => {
    const pending = game.pendingLockdownMilitia;
    if (!pending) return { success: false, message: 'No pending lockdown militia' };

    // Parse sector from choice (strip militia count suffix)
    const sectorChoice = args.targetSector as string;
    const sectorName = sectorChoice.replace(/\s*\(\d+\/10\)$/, '').trim();
    const sector = game.gameMap.getAllSectors().find(s => s.sectorName === sectorName);
    if (!sector) return { success: false, message: 'Invalid sector' };

    const amount = parseInt(args.amount as string, 10);
    if (isNaN(amount) || amount <= 0) return { success: false, message: 'Invalid amount' };

    // Place militia (addDictatorMilitia respects cap)
    const placed = sector.addDictatorMilitia(amount);
    pending.remaining -= placed;
    game.message(`Lockdown: ${placed} militia placed at ${sector.sectorName} (${pending.remaining} remaining)`);

    // Check for combat
    for (const rebel of game.rebelPlayers) {
      const hasSquad = rebel.primarySquad.sectorId === sector.sectorId ||
        rebel.secondarySquad.sectorId === sector.sectorId;
      const hasMilitia = sector.getRebelMilitia(`${rebel.seat}`) > 0;
      if (hasSquad || hasMilitia) {
        queuePendingCombat(game, sector, rebel, false);
        break;
      }
    }

    // Clear pending if all placed
    if (pending.remaining <= 0) {
      game.pendingLockdownMilitia = null;
    }

    return { success: true, message: `Placed ${placed} militia` };
  });
```

Register the new action where `generalissimoPick` was registered (in the action registration file).

**In src/rules/flow.ts:**

Add a new loop AFTER the generalissimo-hire loop (added by plan 03) and BEFORE the tactics-combat loops:

```typescript
// Lockdown militia placement — dictator places militia on base/adjacent sectors
loop({
  name: 'lockdown-militia-placement',
  while: () => game.pendingLockdownMilitia != null && game.pendingLockdownMilitia.remaining > 0 && !game.isFinished(),
  maxIterations: 50, // Safety: could be many placements
  do: actionStep({
    name: 'lockdown-place-militia',
    actions: ['lockdownPlaceMilitia'],
    prompt: 'Lockdown: Place militia on base or adjacent sectors',
    skipIf: () => game.isFinished() || game.pendingLockdownMilitia == null || game.pendingLockdownMilitia.remaining <= 0,
  }),
}),
```

Place this AFTER the generalissimo-hire loop and BEFORE the tactics-combat-before-attack-healing loop.

After the lockdown placement loop, add combat handling loops (same set of loops that already exist for tactics combat: before-attack-healing, attack-dog, target-selection, hit-allocation, wolverine-sixes, epinephrine, continue-or-retreat, animation-wait). Actually — check if the EXISTING tactics-combat loops (already present at lines 583-701) will handle combat triggered by lockdown. If they're already in the flow after the lockdown loop position, they will naturally handle any combat queued by lockdown placement. Verify the loop order and confirm no additional combat loops are needed.
  </action>
  <verify>
    `npx vitest run` passes. Grep for `lockdownPlaceMilitia` in flow.ts, dictator-actions.ts, and the action registration file. Grep for `pendingLockdownMilitia` in game.ts, tactics-effects.ts, dictator-actions.ts, and flow.ts.
  </verify>
  <done>
    Human dictator gets iterative militia placement on base/adjacent sectors. Flow yields for each placement decision. Combat triggers when rebels are present. All militia placed or sector caps reached.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` passes with no failures
2. `grep -rn "lockdownActive" src/rules/tactics-effects.ts` returns NO hits (old flag reference removed)
3. `grep -rn "pendingLockdownMilitia" src/rules/` returns hits in game.ts, tactics-effects.ts, dictator-actions.ts, and flow.ts
4. `grep -rn "lockdownPlaceMilitia" src/rules/` returns hits in dictator-actions.ts, flow.ts, and the action registration file
5. No TypeScript errors
</verification>

<success_criteria>
- Lockdown places 5 * rebelCount militia per CSV rules
- AI distributes evenly across base + adjacent sectors
- Human gets iterative placement with sector and amount choices
- 10-per-sector cap is respected
- Combat triggered when militia placed in rebel-occupied sectors
- No references to fabricated lockdownActive flag remain
</success_criteria>

<output>
After completion, create `.planning/phases/50-tactics-card-audit/50-04-SUMMARY.md`
</output>
