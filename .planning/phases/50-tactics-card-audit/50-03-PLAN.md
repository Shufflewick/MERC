---
phase: 50-tactics-card-audit
plan: 03
type: execute
wave: 2
depends_on: ["50-01", "50-02"]
files_modified:
  - src/rules/tactics-effects.ts
  - src/rules/game.ts
  - src/rules/actions/dictator-actions.ts
  - src/rules/flow.ts
autonomous: true

must_haves:
  truths:
    - "Generalissimo draws 6 MERCs from the merc deck and lets the dictator pick 1"
    - "The picked MERC is added to a dictator squad at a valid sector"
    - "The picked MERC receives starting equipment"
    - "Unpicked MERCs are discarded"
    - "AI dictator auto-picks the highest combat MERC"
    - "Human dictator gets interactive choice via flow step"
  artifacts:
    - path: "src/rules/tactics-effects.ts"
      provides: "Rewritten generalisimo() that sets pendingGeneralissimoHire"
      contains: "pendingGeneralissimoHire"
    - path: "src/rules/game.ts"
      provides: "pendingGeneralissimoHire state type and property"
      contains: "pendingGeneralissimoHire"
    - path: "src/rules/actions/dictator-actions.ts"
      provides: "generalissimoPick action following castroBonusHire pattern"
      contains: "generalissimoPick"
    - path: "src/rules/flow.ts"
      provides: "Flow step for generalissimo MERC selection after artillery allocation"
      contains: "generalissimo"
  key_links:
    - from: "src/rules/tactics-effects.ts"
      to: "src/rules/game.ts"
      via: "sets pendingGeneralissimoHire state"
      pattern: "game\\.pendingGeneralissimoHire"
    - from: "src/rules/flow.ts"
      to: "src/rules/actions/dictator-actions.ts"
      via: "flow step lists generalissimoPick action"
      pattern: "actions.*generalissimoPick"
    - from: "src/rules/actions/dictator-actions.ts"
      to: "src/rules/game.ts"
      via: "reads and clears pendingGeneralissimoHire"
      pattern: "pendingGeneralissimoHire"
---

<objective>
Completely rewrite Generalissimo to draw 6 MERCs and let the dictator pick 1 to add to either squad, per the authoritative CSV rules.

Purpose: The current Generalissimo implementation is completely wrong — it sets a fabricated +1 combat bonus flag instead of drawing MERCs. The correct behavior per "dictator tactics.csv" is: reveal base, draw 6 MERCs, dictator picks 1 to add to either squad.

Output: Working Generalissimo card that draws 6, picks 1, places in squad with equipment, and discards the rest. Both AI and human player paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-tactics-card-audit/50-RESEARCH.md
@.planning/phases/50-tactics-card-audit/50-01-SUMMARY.md
@.planning/phases/50-tactics-card-audit/50-02-SUMMARY.md
@src/rules/tactics-effects.ts (generalisimo function)
@src/rules/actions/dictator-actions.ts (createCastroBonusHireAction at lines 345-523 — THE TEMPLATE to follow)
@src/rules/flow.ts (lines 560-579 — playTactics step + artillery allocation loop — add new step after)
@src/rules/game.ts (pendingArtilleryAllocation at lines 588-611 — pattern for pending state)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pending state and rewrite Generalissimo effect</name>
  <files>
    src/rules/game.ts
    src/rules/tactics-effects.ts
  </files>
  <action>
**In src/rules/game.ts:**

Add a `pendingGeneralissimoHire` property near the other pending state (after `pendingArtilleryAllocation`). Follow the same nullable pattern:

```typescript
// Pending Generalissimo hire — dictator picks 1 of 6 drawn MERCs
pendingGeneralissimoHire: {
  drawnMercIds: number[];  // Element IDs of the 6 drawn MERCs
} | null = null;
```

Add a getter:
```typescript
get hasGeneralissimoPending(): boolean {
  return this.pendingGeneralissimoHire !== null;
}
```

**In src/rules/tactics-effects.ts:**

Completely rewrite the `generalisimo()` function. Remove the old implementation (lines 519-532 that sets `generalisimoActive = true`).

New implementation:
1. Call `revealBase(game)` first (base reveal is still part of this card)
2. Draw 6 MERCs from the merc deck: `for (let i = 0; i < 6; i++) { const m = game.drawMerc(); if (m) drawnMercs.push(m); }`
3. If no MERCs drawn (deck empty), return success with message "No MERCs available to hire"
4. For AI dictator (`game.dictatorPlayer.isAI`): auto-pick the highest combat MERC, place in primary squad (or secondary if primary is full), equip with best available equipment, discard the rest. Fire `game.animate('tactic-generalissimo', { cardName: 'Generalissimo', mercHired: selectedMerc.combatantName }, () => { /* placement mutations */ })`.
5. For human dictator: set `game.pendingGeneralissimoHire = { drawnMercIds: drawnMercs.map(m => m.id) }` and return. The flow step + action will handle the interactive selection.

Remove the line `game.generalisimoActive = true;` — this flag no longer exists (removed in plan 01). If the property reference causes a TypeScript error, that confirms plan 01 removed it correctly.

For the AI auto-pick path, follow the logic in `castroBonusHire` execute handler (lines 472-521 of dictator-actions.ts) for squad placement and equipment handling. Use the `equipNewHire` helper if it exists, or replicate the equip pattern from castroBonusHire.
  </action>
  <verify>
    `npx vitest run` passes. TypeScript compiles without errors. The generalisimo function no longer references generalisimoActive.
  </verify>
  <done>
    Generalissimo effect draws 6 MERCs. AI auto-picks best. Human sets pending state for interactive flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create generalissimoPick action and flow step</name>
  <files>
    src/rules/actions/dictator-actions.ts
    src/rules/flow.ts
  </files>
  <action>
**In src/rules/actions/dictator-actions.ts:**

Create `createGeneralissimoPickAction(game: MERCGame)` following the `createCastroBonusHireAction` pattern closely. Key differences from Castro:
- Castro draws 3, Generalissimo draws 6 (already drawn and stored in pendingGeneralissimoHire)
- The MERCs are already drawn — read them from `game.pendingGeneralissimoHire.drawnMercIds`
- Condition: `game.pendingGeneralissimoHire != null` (not checking for Castro)

Action builder chain:
```typescript
Action.create('generalissimoPick')
  .prompt('Generalissimo: Choose a MERC to hire')
  .condition({
    'is dictator player': (ctx) => game.isDictatorPlayer(ctx.player),
    'has pending hire': () => game.pendingGeneralissimoHire != null,
    'is human player': () => !game.dictatorPlayer?.isAI,
  })
  .chooseFrom<string>('selectedMerc', {
    prompt: 'Choose a MERC to hire (6 drawn)',
    choices: () => {
      const ids = game.pendingGeneralissimoHire?.drawnMercIds ?? [];
      const mercs = ids
        .map(id => game.getElementById(id))
        .filter((el): el is CombatantModel => isCombatantModel(el) && el.isMerc)
        .sort((a, b) => b.baseCombat - a.baseCombat);
      if (mercs.length === 0) return ['No MERCs available'];
      return mercs.map(m => capitalize(m.combatantName));
    },
  })
  .chooseFrom<string>('equipmentType', {
    prompt: 'Choose starting equipment type',
    choices: () => ['Weapon', 'Armor', 'Accessory'],
  })
  .chooseFrom<string>('targetSector', {
    prompt: 'Choose where to deploy',
    choices: () => {
      // Same sector choice logic as castroBonusHire — dictator squad locations or controlled sectors
      // Copy the sector selection logic from createCastroBonusHireAction lines 389-420
    },
  })
  .execute((args, ctx) => {
    // Same execution logic as castroBonusHire lines 422-522:
    // 1. Find selected MERC from pending state
    // 2. Place in appropriate squad at selected sector
    // 3. Give equipment
    // 4. Discard unpicked MERCs to mercDiscard
    // 5. Clear pendingGeneralissimoHire = null
    // 6. Fire game.animate('tactic-generalissimo', { cardName: 'Generalissimo', mercHired: selectedMerc.combatantName }, () => {})
  });
```

Register the new action in the action registration function. Find where `castroBonusHire` is registered and add `generalissimoPick` nearby. Check `src/rules/actions/index.ts` for the registration pattern.

**In src/rules/flow.ts:**

Add a new loop AFTER the artillery-allocation loop (line 579) and BEFORE the tactics-combat loops. This follows the same pattern as artillery allocation:

```typescript
// Generalissimo MERC selection — dictator picks 1 of 6 drawn MERCs
loop({
  name: 'generalissimo-hire',
  while: () => game.pendingGeneralissimoHire != null && !game.isFinished(),
  maxIterations: 5,
  do: actionStep({
    name: 'generalissimo-pick-merc',
    actions: ['generalissimoPick'],
    prompt: 'Generalissimo: Choose a MERC to hire',
    skipIf: () => game.isFinished() || game.pendingGeneralissimoHire == null,
  }),
}),
```

Place this AFTER the artillery-allocation loop at line 579 and BEFORE the tactics-combat-before-attack-healing loop at line 583.
  </action>
  <verify>
    `npx vitest run` passes. Grep for `generalissimoPick` in flow.ts and dictator-actions.ts — both should have hits. Grep for `generalissimoPick` in index.ts (or wherever actions are registered) — should be registered.
  </verify>
  <done>
    Human dictator gets interactive MERC selection after playing Generalissimo. The flow step yields for player input and the action handles draw-6-pick-1 with squad placement and equipment.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` passes with no failures
2. `grep -rn "generalisimoActive" src/rules/tactics-effects.ts` returns NO hits (old flag reference removed)
3. `grep -rn "pendingGeneralissimoHire" src/rules/` returns hits in game.ts, tactics-effects.ts, dictator-actions.ts, and flow.ts
4. `grep -rn "generalissimoPick" src/rules/` returns hits in dictator-actions.ts, flow.ts, and the action registration file
</verification>

<success_criteria>
- Generalissimo draws 6 MERCs per CSV rules
- AI auto-picks highest combat MERC
- Human gets interactive 3-step choice (MERC, equipment, sector)
- Unpicked MERCs are discarded
- Flow yields correctly for human interaction
- No references to fabricated generalisimoActive flag remain
</success_criteria>

<output>
After completion, create `.planning/phases/50-tactics-card-audit/50-03-SUMMARY.md`
</output>
