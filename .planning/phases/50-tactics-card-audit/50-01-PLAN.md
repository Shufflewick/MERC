---
phase: 50-tactics-card-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/rules/combat.ts
  - src/rules/game.ts
  - src/rules/tactics-effects.ts
  - tests/combat-execution.test.ts
autonomous: true

must_haves:
  truths:
    - "Generalissimo no longer gives fabricated +1 combat to base defenders"
    - "Lockdown no longer gives fabricated +1 armor to base defenders"
    - "Block Trade flips cities AND places militia on each flipped city"
    - "All existing tests pass (updated or removed as appropriate)"
  artifacts:
    - path: "src/rules/combat.ts"
      provides: "applyBaseDefenseBonuses function removed or gutted"
      contains: "no generalisimoActive or lockdownActive usage"
    - path: "src/rules/tactics-effects.ts"
      provides: "Block Trade militia placement"
      contains: "addDictatorMilitia"
    - path: "tests/combat-execution.test.ts"
      provides: "Updated tests without fabricated bonus assertions"
  key_links:
    - from: "src/rules/tactics-effects.ts"
      to: "blockTrade function"
      via: "militia placement after city flip"
      pattern: "addDictatorMilitia"
---

<objective>
Remove fabricated base defense bonuses (generalisimoActive/lockdownActive) from combat system and fix Block Trade to add militia to flipped cities.

Purpose: The generalisimoActive (+1 combat at base) and lockdownActive (+1 armor at base) flags are fabricated effects that don't match any rules document. They must be removed BEFORE the correct Generalissimo and Lockdown implementations are built. Block Trade is missing its militia placement half per the expansion CSV rules.

Output: Clean combat.ts without fabricated bonus code, updated tests, correct Block Trade implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-tactics-card-audit/50-RESEARCH.md
@src/rules/combat.ts (lines 835-878 — applyBaseDefenseBonuses function)
@src/rules/game.ts (lines 414-416 — generalisimoActive/lockdownActive declarations)
@src/rules/tactics-effects.ts (lines 407-420 — blockTrade function)
@tests/combat-execution.test.ts (lines 691-773 — base defense bonus tests)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove fabricated base defense bonuses from combat system</name>
  <files>
    src/rules/combat.ts
    src/rules/game.ts
    tests/combat-execution.test.ts
  </files>
  <action>
1. In `src/rules/game.ts`, remove the two properties and their comments at lines 414-416:
   - `generalisimoActive: boolean = false;`
   - `lockdownActive: boolean = false;`
   - Remove the comment `// Base defense bonus flags (from tactics cards)` above them

2. In `src/rules/combat.ts`, remove the entire `applyBaseDefenseBonuses` function (lines 835-878) and its call site at line 2474. The function applies the fabricated +1 combat and +1 armor bonuses that don't exist in any rules document. Search for all references to this function and remove them.

3. In `tests/combat-execution.test.ts`, remove the three test cases in the base defense bonuses describe block (lines 691-773):
   - "Generalisimo gives +1 combat to dictator units at base"
   - "Lockdown gives +1 armor to dictator units at base"
   - "Base defense bonuses do not apply outside base sector"
   Remove the entire `describe` block wrapping these tests. If the describe block contains only these 3 tests, remove the whole describe.

4. Verify no other files reference `generalisimoActive` or `lockdownActive`. Search the entire codebase. The only other references should be in `tactics-effects.ts` (generalisimo and lockdown functions) which will be rewritten in plans 03 and 04 — leave those alone for now.
  </action>
  <verify>
    Run `npx vitest run` — all tests pass. Grep for `generalisimoActive` and `lockdownActive` across the codebase — should only appear in tactics-effects.ts (the effect functions that will be rewritten later).
  </verify>
  <done>
    The fabricated +1 combat and +1 armor base defense bonuses are completely removed from combat.ts and game.ts. The test file no longer tests for these fabricated behaviors. All remaining tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Block Trade to place militia on flipped cities</name>
  <files>
    src/rules/tactics-effects.ts
  </files>
  <action>
Per the expansion CSV rules: "Flip all cities to explored. Add half rebel count (round up) militia to each city."

Modify the `blockTrade` function in `src/rules/tactics-effects.ts` (currently lines 407-420):

1. After `city.explore()`, add militia placement: `const militiaToAdd = Math.ceil(game.rebelCount / 2);`
2. For EACH city (not just unexplored ones — the militia goes on ALL cities after flipping), call `city.addDictatorMilitia(militiaToAdd)`.
3. Track total militia placed for the return message.
4. Check for combat at each city where militia were placed — if any rebel has a squad or militia there, call `queuePendingCombat(game, city, rebel, false)` (import already exists at top of file). Follow the same pattern used in `reinforcements()` at lines 306-318.
5. Update the return message to include militia count: `Block Trade: ${cities.length} cities explored, ${totalPlaced} militia placed`

Important: The current function only iterates unexplored cities for the explore step. The militia placement should also go on already-explored cities. Re-read the CSV: "Flip all cities to explored. Add half rebel count (round up) militia to each city." The "each city" means ALL cities, not just the ones that were flipped. Adjust the function to:
- Flip unexplored cities
- Place militia on ALL cities (explored or not)
  </action>
  <verify>
    Run `npx vitest run` — all tests pass. Read the blockTrade function to confirm it now places militia.
  </verify>
  <done>
    Block Trade correctly flips unexplored cities AND places militia on all cities. Combat is triggered if rebels are present at any city that receives militia.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` passes with no failures
2. `grep -rn "generalisimoActive\|lockdownActive" src/rules/` only returns hits in `tactics-effects.ts` (the generalisimo and lockdown functions that will be rewritten in later plans)
3. The `blockTrade` function in tactics-effects.ts now calls `addDictatorMilitia`
</verification>

<success_criteria>
- Fabricated base defense bonus system completely removed from combat
- Block Trade places militia per CSV rules
- All tests pass
- No regressions in other tactics card behavior
</success_criteria>

<output>
After completion, create `.planning/phases/50-tactics-card-audit/50-01-SUMMARY.md`
</output>
