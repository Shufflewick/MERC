# Milestone v1.1: Polish

**Status:** ✅ SHIPPED 2026-01-09
**Phases:** 7-8
**Total Plans:** 6

## Overview

Polish milestone focusing on code organization and implementing Artillery Barrage player choice — allowing rebels to choose which units take damage during the dictator's Artillery Barrage card.

## Phases

### Phase 7: File Organization

**Goal**: Split large files for better maintainability
**Depends on**: v1.0 complete
**Plans**: 2 plans

Plans:
- [x] 07-01: Split combat.ts into combat-types.ts and combat-retreat.ts
- [x] 07-02: Split ai-helpers.ts into ai-combat-helpers.ts and ai-action-helpers.ts

**Details:**
- Split `combat.ts` (2,879 lines) → 2,747 lines (-132 lines)
  - Created `combat-types.ts` (62 lines) with Combatant, CombatResult, CombatRound, CombatOutcome interfaces
  - Created `combat-retreat.ts` (95 lines) with getValidRetreatSectors, canRetreat, executeRetreat
- Split `ai-helpers.ts` (1,327 lines) → 899 lines (-428 lines)
  - Created `ai-combat-helpers.ts` (197 lines) with combat/targeting functions
  - Created `ai-action-helpers.ts` (288 lines) with AI action decision logic
- Used re-export pattern for backwards compatibility

### Phase 8: Artillery Barrage

**Goal**: Implement player choice for Artillery Barrage hit allocation
**Depends on**: Phase 7 (optional)
**Plans**: 4 plans

Plans:
- [x] 08-01: Add pendingArtilleryAllocation state and hasArtilleryPending getter
- [x] 08-02: Register artillery allocation action stub and add flow loop
- [x] 08-03: Refactor artilleryBarrage to use pending allocation state
- [x] 08-04: Create artilleryAllocateHits action

**Details:**
- Added `pendingArtilleryAllocation` state property with validTargets array and sectorsRemaining queue
- Added `hasArtilleryPending` getter for clean flow API
- Added artillery-allocation loop after playTactics step in dictator turn
- Refactored `artilleryBarrage` to roll dice upfront and set pending state
- Created `buildArtilleryTargets` helper to identify militia and MERCs in sector
- Implemented full `artilleryAllocateHits` action following combat allocation pattern

---

## Milestone Summary

**Key Decisions:**
- Artillery allocation follows pendingHitAllocation pattern for consistency
- Placed flow loop after playTactics step (where Artillery Barrage card is played)
- Roll dice for all sectors upfront before setting pending state
- Use mercId (string) instead of id (number) for MERC target identification
- Each rebel allocates hits to their own units only (multiplayer-ready)

**Issues Resolved:**
- Large file sizes in combat.ts and ai-helpers.ts addressed through modular extraction
- Artillery Barrage damage allocation now gives rebels meaningful choice

**Issues Deferred:**
None.

**Technical Debt Incurred:**
None.

---

_For current project status, see .planning/ROADMAP.md_
