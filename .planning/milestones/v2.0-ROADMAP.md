# Milestone v2.0: Simultaneous Rebel Turns

**Status:** SHIPPED 2026-02-16
**Phases:** 51-55
**Total Plans:** 6

## Overview

Replace sequential rebel turns with simultaneous play — all rebels act freely during the rebel phase with combat as a synchronization barrier. Uses composable loop pattern wrapping `simultaneousActionStep` with no BoardSmith engine changes required.

## Phases

### Phase 51: Extract Combat Sub-Flow

**Goal**: Combat resolution exists as a standalone sub-flow that any phase can invoke
**Depends on**: Nothing (foundation)
**Plans**: 1 plan

Plans:
- [x] 51-01: Extract combatResolutionFlow function and replace 4 inline duplication sites

**Details:**
- Extracted all 10 combat resolution blocks into single `combatResolutionFlow(game, prefix)` function
- Replaced 4 inline copies at rebel, tactics, dictator, and Kim militia sites
- Reduced flow.ts from 1648 to 986 lines (934 deletions, 272 insertions)
- Sub-flow pattern: function returning `sequence()` with parameterized prefix

### Phase 52: Simultaneous Rebel Step

**Goal**: All rebels act freely during the rebel phase through a simultaneousActionStep, with per-player action evaluation and done tracking
**Depends on**: Phase 51
**Plans**: 2 plans

Plans:
- [x] 52-01: Replace Day 2+ eachPlayer rebel-turns with loop + simultaneousActionStep
- [x] 52-02: Replace Day 1 eachPlayer rebel-landing with loop + simultaneousActionStep

**Details:**
- Day 2+: Replaced sequential `eachPlayer('rebel-turns')` with `loop('rebel-phase')` wrapping `simultaneousActionStep('rebel-actions')`
- Day 1: Replaced sequential `eachPlayer('rebel-landing')` with `loop('rebel-landing')` wrapping `simultaneousActionStep('rebel-landing-actions')`
- Oil Reserves applied to all rebels in single execute block before rebel phase loop
- Mortar allocation actionStep uses `player:` override for correct player context
- `skipPlayer`/`playerDone` check `actionsRemaining === 0` via team property
- `isDay1Complete` helper with Teresa-aware completion tracking

### Phase 53: Combat Barriers

**Goal**: Combat and coordinated attacks act as synchronization barriers that pause simultaneous play, resolve sequentially, then resume
**Depends on**: Phase 52
**Plans**: 1 plan

Plans:
- [x] 53-01: Verify barrier architecture with integration tests for combat, coordinated attack, and done preservation

**Details:**
- 5 integration tests across 3 groups: combat barrier (2), coordinated attack barrier (1), done preservation (2)
- Manual pendingCombat/coordinatedAttack injection for deterministic testing
- Fixed dynamic `require()` in day-one.ts (CJS → static ESM import)
- Step identification via available actions (FlowState has no stepName property)

### Phase 54: Dictator and AI Alignment

**Goal**: Dictator phase uses the shared combat sub-flow; AI rebel players batch actions correctly within simultaneous play
**Depends on**: Phase 51, Phase 52
**Plans**: 1 plan

Plans:
- [x] 54-01: FLOW-05 verification tests + AI rebel action batching (round tracking, action conditions, integration tests)

**Details:**
- Private `_rebelActionCounts` map and `_rebelBatchRound` counter (ephemeral, not serialized)
- `shouldGateAIAction(player)` and `recordRebelActionForBatching(player)` on MERCGame
- AI batch gate condition wired into all 19 rebel simultaneous-step actions
- `resetRebelBatching()` called before Day 1 and Day 2+ simultaneous steps
- FLOW-05 structural test confirms 3 `combatResolutionFlow` call sites in dictator turn

### Phase 55: Simultaneous Play UI

**Goal**: Players have clear visual feedback about simultaneous play state, waiting conditions, and barrier transitions
**Depends on**: Phase 52, Phase 53
**Plans**: 1 plan

Plans:
- [x] 55-01: Combat barrier overlay + verify existing BoardSmith simultaneous play UI infrastructure

**Details:**
- `game.animate('combat-barrier', {}, () => {})` in rebel-phase loop (pure UI signal)
- GameOverlay with red-tinted "Combat Detected" banner (2000ms, `skip: 'drop'` policy)
- UI-01 through UI-04 verified in live multiplayer gameplay
- Existing BoardSmith infrastructure handles turn indicators, waiting messages, and real-time visibility

---

## Milestone Summary

**Key Decisions:**
- Loop pattern for simultaneous+barrier: composable with existing BoardSmith primitives, serializes correctly
- Combat as synchronization barrier: simplest model — one combat at a time, all rebels pause
- No BoardSmith engine changes: use existing simultaneousActionStep + loop
- RebelPlayer cast in skipPlayer/playerDone: BoardSmith Player base lacks team property
- Private properties for AI batch state: not serialized by BoardSmith, ephemeral to simultaneous step
- Conservative isDay1Complete: engine auto-completes players with no available actions

**Issues Resolved:**
- Dynamic `require()` in day-one.ts blocking 3-player tests (CJS → static ESM import)
- FlowState has no stepName property (identify steps by available actions instead)
- Test assertions needed updating for simultaneousActionStep flow topology (awaitingPlayers)

**Issues Deferred:**
- Vendor tarballs missing compiled `dist` folders (blocks build and integration tests)
- Stale comments referencing removed state machine / theatre view (cosmetic)

**Technical Debt Incurred:**
- `detonateExplosives` action missing AI batch gate (win-game action, extremely rare edge case)

---

_For current project status, see .planning/PROJECT.md_
