# Milestone v1.0: Codebase Cleanup

**Status:** ✅ SHIPPED 2026-01-09
**Phases:** 1-6
**Total Plans:** 20

## Overview

A systematic cleanup moving from type safety foundations through code quality improvements to comprehensive test coverage, ensuring the codebase reaches ship confidence without regressions.

## Phases

### Phase 1: Type Safety: Combat State

**Goal**: Replace `any[]` types in combat state with proper `Combatant[]`, `CombatResult[]` types
**Depends on**: Nothing (first phase)
**Plans**: 1 plan

Plans:
- [x] 01-01: Add type imports and fix activeCombat state types

**Details:**
- Added type-only import for Combatant and CombatResult from combat.ts
- Replaced 10 `any[]` usages in activeCombat state with proper types
- Fixed pendingLoot type from `equipment: any[]` to `equipment: Equipment[]`
- Removed redundant `as any[]` casts in debug helpers

### Phase 2: Type Safety: Assertions

**Goal**: Replace unsafe `as` casts with type guards or validated casts across ~350 instances
**Depends on**: Phase 1 (combat types inform some assertions)
**Plans**: 8 plans

Plans:
- [x] 02-01: Create type guard utilities and fix game.ts
- [x] 02-02: Fix flow.ts and tactics-effects.ts (high-risk `as any`)
- [x] 02-03: Fix dictator-actions.ts
- [x] 02-04: Fix rebel-movement.ts
- [x] 02-05: Fix rebel-economy.ts
- [x] 02-06: Fix rebel-equipment.ts (largest file)
- [x] 02-07: Fix day-one-actions.ts
- [x] 02-08: Fix remaining files (combat.ts, rebel-combat.ts, ai-helpers.ts, rebel-hiring.ts)

**Details:**
- Established type guard patterns (isRebelPlayer, isDictatorCard, asRebelPlayer, asDictatorPlayer)
- Used `as unknown as ElementClass` pattern for classRegistry (safer than `as any`)
- Added tactics card state as typed optional properties on MERCGame
- Changed type guards to accept `unknown` with type predicates
- Used instanceof filter pattern for getElementById results
- Typed mixed MercCard/DictatorCard arrays as CombatUnit[] (shared base class)

### Phase 3: Code Quality: Helpers

**Goal**: Extract duplicate helper patterns into shared utilities in `helpers.ts`
**Depends on**: Phase 2 (type guards established in helpers.ts)
**Plans**: 4 plans

Plans:
- [x] 03-01: Add new helper utilities (isDictatorCard, getUnitName, cache helpers, findUnitSector)
- [x] 03-02: Replace duplicates in rebel-economy.ts
- [x] 03-03: Replace duplicates in rebel-equipment.ts
- [x] 03-04: Replace duplicates in day-one-actions.ts and dictator-actions.ts

**Details:**
- Added isDictatorCard type guard, getUnitName, findUnitSector helpers
- Added generic cache helpers (getCachedValue, setCachedValue, clearCachedValue)
- Removed ~166 lines of duplicate code across action files
- Removed unused getDictatorUnitName (dead code)

### Phase 4: Code Quality: State & Legacy

**Goal**: Standardize state persistence pattern and remove legacy `pendingLoot` property
**Depends on**: Phase 3
**Plans**: 3 plans

Plans:
- [x] 04-01: Add global cache helpers + remove legacy pendingLoot
- [x] 04-02: Migrate dictator-actions.ts and day-one-actions.ts to cache helpers
- [x] 04-03: Migrate rebel-economy.ts and flow.ts, complete phase

**Details:**
- Global helpers mirror player-scoped helpers for consistency
- Used explicit type generics on getGlobalCachedValue for type safety
- Extended cache helpers with global variants for dictator/shared state

### Phase 5: Debug Cleanup

**Goal**: Remove DEBUG messages from dictator-actions.ts and gate DEBUG_TACTICS_ORDER
**Depends on**: Phase 4
**Plans**: 1 plan

Plans:
- [x] 05-01: Remove/gate debug code

**Details:**
- Removed two DEBUG: prefixed messages from MERC placement sector matching
- Added documentation comment explaining DEBUG_TACTICS_ORDER is for testing only
- Kept WARNING message for sector fallback (legitimate runtime info)
- Kept [DEBUG] prefix in tactics order message (correctly signals debug mode)

### Phase 6: Test Coverage

**Goal**: Add tests for action `.condition()` validation, state persistence patterns, and error conditions
**Depends on**: Phase 5 (test final state of codebase)
**Plans**: 3 plans

Plans:
- [x] 06-01: Add action condition tests
- [x] 06-02: Add state persistence tests
- [x] 06-03: Add error condition tests

**Details:**
- Used direct condition testing via checkActionCondition helper
- 81 new tests for error conditions and edge cases
- Type assertion helpers validated to throw descriptive errors
- Type guards validated to return false (not throw) for invalid inputs
- Helper function edge cases covered (empty teams, exhausted MERCs, null sectors)
- Game state boundaries tested (empty decks, day limits, team size)

---

## Milestone Summary

**Key Decisions:**

- Used `import type` for Combatant/CombatResult to avoid runtime circular dependencies
- Used constructor.name check for isRebelPlayer to avoid circular dependencies
- Used `as unknown as ElementClass` pattern for classRegistry (safer than `as any`)
- Added tactics card state as typed optional properties on MERCGame
- Changed type guards to accept `unknown` with type predicates
- Used instanceof checks in filter callbacks for element validation
- Typed mixed MercCard/DictatorCard arrays as CombatUnit[] (shared base class)
- Global helpers mirror player-scoped helpers for consistency
- Keep WARNING message for sector fallback (legitimate runtime info)

**Issues Resolved:**

- Fixed 191 type assertions across src/rules/
- Extracted 17 duplicate helper patterns (~166 lines removed)
- Removed legacy pendingLoot property
- Cleaned up debug messages

**Issues Deferred:**

- Artillery Barrage player choice mechanic — requires architectural flow interrupts, too complex for cleanup scope

**Technical Debt Incurred:**

- None — this milestone was focused on reducing technical debt

---

_For current project status, see .planning/ROADMAP.md_
