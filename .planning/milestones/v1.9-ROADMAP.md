# Milestone v1.9: BoardSmith v3.0 Animation Timeline Migration

**Status:** SHIPPED 2026-02-08
**Phases:** 42-46
**Total Plans:** 7

## Overview

Migrate CombatPanel from the removed BoardSmith theatre view system to a 100% event-driven animation player. Remove all dead APIs and vestigial code. Build combat-panel snapshot events with decision context. Rebuild CombatPanel to render entirely from events. Clean up GameTable wiring. Verify with tests.

## Phases

### Phase 42: Remove Dead APIs
**Goal**: All references to BoardSmith v2 theatre view APIs are gone -- the codebase compiles clean against BoardSmith v3.0 without dead imports or calls to removed functions
**Depends on**: Nothing (first phase of v1.9)
**Requirements**: DELETE-01, DELETE-02
**Plans**: 1 plan

Plans:
- [x] 42-01: Remove useCurrentView, truthCombatComplete, truthActiveCombat, and acknowledgment protocol from 5 files

**Details:**
Deleted 7 dead API references (useCurrentView, CURRENT_VIEW_KEY, acknowledgeAnimations, createAcknowledgeAnimationsAction, truthCombatComplete, truthActiveCombat, acknowledge callback) across 5 files. All 602 tests pass. Duration: 2 min.

### Phase 43: Combat Event Architecture
**Goal**: Combat emits a complete, self-contained event stream -- `combat-panel` snapshots with full combatant data and decision context at each decision cycle, plus pure data animation events with no mutation callbacks
**Depends on**: Phase 42
**Requirements**: SRV-01, SRV-02, SRV-03
**Plans**: 2 plans

Plans:
- [x] 43-01: Extract mutations from all 13 animate callbacks into pure data events (SRV-03)
- [x] 43-02: Add combat-panel snapshot emission at all decision cycle points (SRV-01, SRV-02)

**Details:**
Plan 01: All 13 game.animate() calls converted to pure data (10 in combat.ts, 3 in rebel-combat.ts). healthBefore added to combat-heal events. Duration: 4 min.
Plan 02: serializeCombatant() and buildCombatPanelSnapshot() helpers added. combat-panel snapshot emitted at 8 decision cycle points (combat start, target selection, hit allocation, before-attack healing, epinephrine, attack dog, retreat/continue, combat complete). Duration: 4 min.

### Phase 44: CombatPanel Rebuild
**Goal**: CombatPanel is a self-contained animation player that renders 100% from event data -- no gameView reads, no activeCombat prop for rendering, no state machine, no manual health tracking
**Depends on**: Phase 43
**Requirements**: UI-01, UI-02, UI-03, DELETE-03, DELETE-05
**Plans**: 2 plans

Plans:
- [x] 44-01: Register combat-panel handler, rewire combatant rendering to snapshot, remove displayHealth/gameView/resolveCombatant (UI-01, DELETE-05)
- [x] 44-02: Rewire decision prompts to snapshot, remove state machine, add event-driven lifecycle (UI-02, UI-03, DELETE-03)

**Details:**
Plan 01: CombatPanel renders all combatant data from snapshot events. Health tracking via snapshot + healthOverrides. Removed 100 lines of indirection. Duration: 5 min.
Plan 02: All 5 decision prompts read from snapshot computed helpers. State machine fully removed (-110 lines). combat-end handler is sole lifecycle exit. Duration: 4 min.

### Phase 45: GameTable Clean Wiring
**Goal**: GameTable's combat panel section is simple and readable -- panel visibility driven by event presence, no fallback chains, no cached state, no workarounds
**Depends on**: Phase 44
**Requirements**: UI-04, DELETE-04
**Plans**: 1 plan

Plans:
- [x] 45-01: Move snapshot ownership to GameTable, delete fallback chains, update CombatPanel to receive snapshot as prop (UI-04, DELETE-04)

**Details:**
GameTable combat section reduced from ~150 to ~15 lines. Deleted 10 refs/computeds, 6 watchers, 4 dead handlers. CombatPanel props simplified from 62-line type to single combatSnapshot prop. Net deletion: 246 lines. Duration: 5 min.

### Phase 46: Verification
**Goal**: Automated tests confirm the combat event pipeline works end-to-end -- snapshot contents, decision context, animation event data, and the full cycle of snapshot-events-decision-snapshot
**Depends on**: Phase 45
**Requirements**: TEST-01
**Plans**: 1 plan

Plans:
- [x] 46-01: Combat event pipeline tests: snapshots, animation events, decision context, lifecycle (TEST-01)

**Details:**
21 tests across 5 groups: snapshot contents (5), animation events (6), lifecycle (3), decision context (4), snapshot re-emission (3). All using direct executeCombat() calls with pendingAnimationEvents inspection. Duration: 4 min.

---

## Milestone Summary

**Key Decisions:**
- CombatPanel 100% event-driven: animation events carry all data, no gameView/truth reads
- Full snapshot per decision cycle: handles refresh/late-join, no history needed
- Mutations out of animate callbacks: pure data events + normal mutations after
- Parent-owned snapshot (GameTable): always-mounted parent registers handler, eliminates mount-race
- Snapshot + healthOverrides pattern: snapshot authoritative at decision points, overrides for per-hit updates
- ActionController stays for player decisions: decisions submitted through existing action system

**Issues Resolved:**
- Theatre view dead code eliminated (7 API references)
- CombatPanel state machine complexity removed (-110 lines)
- GameTable fallback chain complexity removed (-246 lines)
- Mount-race chicken-and-egg problem solved by parent-owned snapshot handler

**Issues Deferred:**
- Stale comment in GameTable.vue:618 references removed state machine (cosmetic)
- Stale comment in combat.ts:72 references "theatre view system" (cosmetic)

**Technical Debt Incurred:**
None

---

_For current project status, see .planning/PROJECT.md_
